-- Migration: Add match_roundups table for post-match roundup storage
-- Generated by GSD execution of plan 04-03

-- Create match_roundups table for storing full post-match roundup content
CREATE TABLE IF NOT EXISTS match_roundups (
  id TEXT PRIMARY KEY,
  match_id TEXT NOT NULL UNIQUE REFERENCES matches(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  scoreboard TEXT NOT NULL, -- JSON: { homeTeam, awayTeam, homeScore, awayScore, competition, venue, kickoff }
  events TEXT, -- JSON: Array of { minute, type, description }
  stats TEXT NOT NULL, -- JSON: { possession, shots, shotsOnTarget, corners, xG, fouls, offsides, ... }
  model_predictions TEXT NOT NULL, -- HTML table string
  top_performers TEXT NOT NULL, -- JSON: Array of { modelName, prediction, points }
  narrative TEXT NOT NULL, -- Full HTML content (1000+ words)
  keywords TEXT, -- Comma-separated keywords
  similarity_hash TEXT, -- SHA-256 hash for exact-match detection
  generation_cost DOUBLE PRECISION,
  prompt_tokens INTEGER,
  completion_tokens INTEGER,
  generated_by TEXT, -- Model name
  status TEXT DEFAULT 'pending', -- 'pending' | 'published' | 'failed'
  published_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for efficient queries
CREATE INDEX IF NOT EXISTS idx_match_roundups_match_id ON match_roundups(match_id);
CREATE INDEX IF NOT EXISTS idx_match_roundups_status ON match_roundups(status);
CREATE INDEX IF NOT EXISTS idx_match_roundups_published_at ON match_roundups(published_at);
CREATE INDEX IF NOT EXISTS idx_match_roundups_similarity_hash ON match_roundups(similarity_hash);
