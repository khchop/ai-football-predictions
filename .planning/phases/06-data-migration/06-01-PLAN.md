---
phase: 06-data-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/recalculate-accuracy.ts
autonomous: true

must_haves:
  truths:
    - "Snapshot table stats_pre_migration exists with pre-migration accuracy values"
    - "All 160 models have recalculated accuracy using tendencyPoints > 0 formula"
    - "Verification report shows before/after comparison for all models"
    - "All stats-related caches are invalidated after migration"
  artifacts:
    - path: "scripts/recalculate-accuracy.ts"
      provides: "Idempotent migration script"
      min_lines: 150
  key_links:
    - from: "scripts/recalculate-accuracy.ts"
      to: "stats_pre_migration table"
      via: "CREATE TABLE AS SELECT"
      pattern: "CREATE TABLE.*stats_pre_migration"
    - from: "scripts/recalculate-accuracy.ts"
      to: "Redis cache"
      via: "cacheDeletePattern after COMMIT"
      pattern: "cacheDeletePattern.*leaderboard"
---

<objective>
Execute data migration to recalculate historical accuracy stats using the corrected formula from Phase 5.

Purpose: Fix inflated accuracy numbers (94% -> 87%) by applying the `tendencyPoints > 0` formula established in Phase 5 to all historical data.

Output: Migration script that creates snapshot for rollback, recalculates all model stats, generates verification report, and invalidates caches.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-data-migration/06-CONTEXT.md
@.planning/phases/06-data-migration/06-RESEARCH.md

# Key references
@scripts/migrate-betting-system.ts (migration script pattern)
@src/lib/services/stats.ts (canonical accuracy formula)
@src/lib/cache/redis.ts (cacheDeletePattern, cacheKeys)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create idempotent migration script</name>
  <files>scripts/recalculate-accuracy.ts</files>
  <action>
Create `scripts/recalculate-accuracy.ts` following the established migration pattern from `migrate-betting-system.ts`.

The script must:

1. **Check idempotency:** If `stats_pre_migration` table exists, exit early (migration already ran)

2. **Create snapshot table BEFORE transaction:**
```sql
DROP TABLE IF EXISTS stats_pre_migration CASCADE;

CREATE TABLE stats_pre_migration AS
SELECT
  m.id as model_id,
  m.display_name,
  COUNT(p.id) FILTER (WHERE p.status = 'scored') as scored_predictions,
  SUM(CASE WHEN p.tendency_points > 0 THEN 1 ELSE 0 END) as correct_tendencies,
  COALESCE(ROUND(100.0 * SUM(CASE WHEN p.tendency_points > 0 THEN 1 ELSE 0 END)
    / NULLIF(COUNT(p.id) FILTER (WHERE p.status = 'scored'), 0)::numeric, 1), 0) as old_accuracy,
  now() as snapshot_created_at
FROM models m
LEFT JOIN predictions p ON p.model_id = m.id
WHERE m.active = true
GROUP BY m.id, m.display_name;

CREATE INDEX idx_stats_pre_migration_model ON stats_pre_migration(model_id);
```

3. **Generate verification report:**
After snapshot, compute NEW accuracy using the corrected formula and compare:
- Query both old (from snapshot) and new (live calculation) values
- Calculate delta and percent change
- Flag any model with delta > 15 percentage points
- Output: JSON file at `.planning/phases/06-data-migration/verification-report.json`

Report format:
```typescript
interface VerificationReport {
  migrationDate: string;
  totalModels: number;
  flaggedModels: number;  // delta > 15
  summary: {
    avgDelta: number;
    maxDelta: number;
    minDelta: number;
  };
  models: Array<{
    modelId: string;
    displayName: string;
    oldAccuracy: number;
    newAccuracy: number;
    delta: number;
    scoredPredictions: number;
    flagged: boolean;
  }>;
}
```

4. **No actual data update needed:**
The migration does NOT update any tables - the formula is already fixed in queries (Phase 5).
The snapshot preserves old calculated values for:
- Rollback reference (user-reported issues)
- Changelog entry (show before/after)
- 30-day retention

5. **Invalidate caches AFTER snapshot creation:**
```typescript
await Promise.all([
  cacheDeletePattern('db:leaderboard:*'),
  cacheDelete(cacheKeys.overallStats()),
  cacheDelete(cacheKeys.topPerformingModel()),
  cacheDeletePattern('db:model:*:stats'),
]);
```

IMPORTANT:
- Use `pg` Pool pattern from existing migration scripts
- Import cache functions from `@/lib/cache/redis`
- Use `tsx` to run: `npx tsx scripts/recalculate-accuracy.ts`
- Script must be runnable from project root with DATABASE_URL and REDIS_URL env vars
  </action>
  <verify>
Run: `npx tsx scripts/recalculate-accuracy.ts --dry-run` (add --dry-run flag that skips cache invalidation and logs what would happen)

Expected output:
- "Would create snapshot table with X models"
- "Would generate verification report"
- "Would invalidate X cache patterns"
  </verify>
  <done>
Script created with snapshot logic, verification report generation, and cache invalidation. Dry-run mode works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute migration and generate verification report</name>
  <files>scripts/recalculate-accuracy.ts, .planning/phases/06-data-migration/verification-report.json</files>
  <action>
Run the migration script against the production database:

```bash
npx tsx scripts/recalculate-accuracy.ts
```

After successful execution:
1. Verify `stats_pre_migration` table exists with expected row count (~160 models)
2. Verify `verification-report.json` was created
3. Review flagged models (delta > 15) - these are expected for models with many null tendencyPoints

Expected behavior:
- Most models should show ~5-8% accuracy drop (the IS NOT NULL vs > 0 bug)
- Some models may show larger drops if they had many 0-point scored predictions
- Zero flagged models with INCREASES (that would indicate a problem)
  </action>
  <verify>
Run SQL to verify snapshot:
```sql
SELECT COUNT(*) as model_count,
       ROUND(AVG(old_accuracy), 1) as avg_old_accuracy
FROM stats_pre_migration;
```

Expected: ~160 models, avg accuracy around 50-60%

Check verification report:
```bash
cat .planning/phases/06-data-migration/verification-report.json | jq '.summary'
```

Expected: avgDelta negative (accuracy dropped), no increases
  </verify>
  <done>
Migration executed, snapshot table created with ~160 models, verification report generated showing expected accuracy corrections.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify cache invalidation and fresh data</name>
  <files>None (verification only)</files>
  <action>
Confirm caches were invalidated and fresh stats are being served:

1. Check Redis for stale cache keys:
```bash
redis-cli KEYS "db:leaderboard:*" | head -5
redis-cli KEYS "db:stats:*" | head -5
```
Expected: Empty or very few (recently created)

2. Hit the leaderboard API to trigger fresh cache:
```bash
curl -s http://localhost:3000/api/leaderboard | jq '.data[0] | {name, accuracy}'
```

3. Compare displayed accuracy with verification report:
- Pick a model from verification report
- Check its accuracy on the leaderboard matches the "newAccuracy" value

4. Verify no errors in application logs during cache rebuild
  </action>
  <verify>
Compare verification report model accuracy with live API:
```bash
# Get first model from report
MODEL_ID=$(cat .planning/phases/06-data-migration/verification-report.json | jq -r '.models[0].modelId')
EXPECTED=$(cat .planning/phases/06-data-migration/verification-report.json | jq -r '.models[0].newAccuracy')

# Get from API (adjust endpoint as needed)
curl -s "http://localhost:3000/api/models/$MODEL_ID/stats" | jq '.accuracy'
```

Values should match within 0.1 (rounding)
  </verify>
  <done>
Caches invalidated, fresh stats being served, leaderboard accuracy matches verification report values.
  </done>
</task>

</tasks>

<verification>
Phase 6 success criteria from ROADMAP.md:

1. All 160 models across 17 leagues show recalculated accuracy using corrected formula
   - Verify: `SELECT COUNT(*) FROM stats_pre_migration` returns ~160
   - Verify: Leaderboard shows new accuracy values

2. Leaderboard rankings reflect corrected calculations without cache serving stale data
   - Verify: `redis-cli KEYS "db:leaderboard:*"` shows fresh timestamps
   - Verify: API response accuracy matches verification report

3. User can view explanation of why accuracy numbers changed (changelog, methodology page)
   - Deferred to Plan 06-02

4. Historical data preserved for 30-day rollback window in case of issues
   - Verify: `stats_pre_migration` table exists with `snapshot_created_at` column
</verification>

<success_criteria>
- [ ] `stats_pre_migration` table created with ~160 model snapshots
- [ ] `verification-report.json` exists with complete before/after comparison
- [ ] Average accuracy delta is negative (expected correction direction)
- [ ] No models show accuracy INCREASE (would indicate bug)
- [ ] All leaderboard/stats caches invalidated
- [ ] Fresh API responses match verification report values
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-migration/06-01-SUMMARY.md`
</output>
