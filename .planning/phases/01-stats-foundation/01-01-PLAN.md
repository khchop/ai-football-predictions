---
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema/stats.ts
  - drizzle/migrations/XXXXXX_create_stats_views.sql
autonomous: true
---

# Plan: Database Schema for Stats Foundation

## Goal
Create materialized views, indexes, and supporting schema for aggregated model performance tracking with concurrent refresh support.

## Background
Current system has predictions and matches tables. Need aggregated stats views to efficiently track model performance without expensive JOINs on every query. Views will be refreshed via BullMQ worker within 1 hour of match completion.

## Tasks

### Task 1.1: Define stats schema extensions in TypeScript
```typescript
// src/lib/db/schema/stats.ts

// Add to existing schema:
// - model_stats (enum: overall, competition, club)
// - Rarity scoring: 2-6 points based on prediction frequency
```

### Task 1.2: Create migration for materialized views
```sql
-- drizzle/migrations/XXXXXX_create_stats_views.sql

-- 1. mv_model_stats_overall
-- Columns: model_id, total_matches, total_points, avg_points, win_rate, win_count, draw_count, loss_count
-- Unique index: (model_id) WITH (model_stats_overall_model_id_key)

-- 2. mv_model_stats_competition  
-- Columns: model_id, competition_id, season, total_matches, total_points, avg_points, win_rate
-- Unique index: (model_id, competition_id, season) WITH (model_stats_comp_model_comp_season_key)

-- 3. mv_model_stats_club
-- Columns: model_id, club_id, season, is_home (boolean), total_matches, total_points, avg_points, win_rate
-- Unique index: (model_id, club_id, season, is_home) WITH (model_stats_club_model_club_season_home_key)
```

### Task 1.3: Add composite indexes on source tables
```sql
-- Performance indexes for view refresh:
CREATE INDEX idx_predictions_model_match ON predictions(model_id, match_id);
CREATE INDEX idx_matches_competition_season ON matches(competition_id, season);
CREATE INDEX idx_matches_status_scheduled ON matches(status, kickoff_at);
CREATE INDEX idx_predictions_model_frequency ON predictions(model_id, match_id) 
  WHERE prediction IS NOT NULL;
```

### Task 1.4: Configure view refresh scheduling
```sql
-- Add comment to views explaining refresh policy:
COMMENT ON MATERIALIZED VIEW mv_model_stats_overall IS 'Refreshed via BullMQ within 1hr of match completion. Current season only.';
```

## Verification
- [ ] Migration runs without errors: `npm run db:migrate`
- [ ] All 3 materialized views created in database
- [ ] Unique concurrent refresh indexes exist on each view
- [ ] Composite indexes on source tables present
- [ ] `REFRESH MATERIALIZED VIEW CONCURRENTLY mv_model_stats_overall` succeeds without blocking

## must_haves
- Materialized views return correct aggregated data
- Concurrent refresh works without table locks
- Query performance < 100ms for stats lookups
- View data limited to current season

## Notes
- Use `WITH NO DATA` initially, first refresh populates
- Each view needs unique index for CONCURRENTLY refresh
- Rarity scoring applied in points calculation service (Wave 2)
