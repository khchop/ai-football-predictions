---
phase: 20-league-page-rebuild
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/league/league-trend-chart.tsx
  - src/lib/league/get-league-trends.ts
autonomous: true

must_haves:
  truths:
    - "Trend chart shows accuracy bars for last 4-8 time periods"
    - "Bar colors match accuracy thresholds (red <40%, amber 40-70%, green >70%)"
    - "Chart is CSS-only (no JavaScript charting libraries)"
    - "Chart handles empty data gracefully with null return"
  artifacts:
    - path: "src/components/league/league-trend-chart.tsx"
      provides: "CSS-only bar chart for trend visualization"
      exports: ["LeagueTrendChart"]
    - path: "src/lib/league/get-league-trends.ts"
      provides: "Query for historical accuracy trends"
      exports: ["getLeagueTrends", "TrendData"]
  key_links:
    - from: "src/components/league/league-trend-chart.tsx"
      to: "TrendData"
      via: "type import"
      pattern: "import.*TrendData"
    - from: "src/lib/league/get-league-trends.ts"
      to: "predictions"
      via: "database query"
      pattern: "from.*predictions"
---

<objective>
Create CSS-only trend visualization component and data query for historical performance.

Purpose: Enable users to explore historical model accuracy trends (LEAG-04, LEAG-05)
Output: LeagueTrendChart component, getLeagueTrends query function
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-league-page-rebuild/20-RESEARCH.md

@src/app/globals.css (chart colors: --chart-1 through --chart-5, --win/--draw/--loss)
@src/components/ui/accuracy-badge.tsx (accuracy threshold logic reference)
@src/lib/db/queries.ts (query patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trend data query</name>
  <files>src/lib/league/get-league-trends.ts</files>
  <action>
    Create new file src/lib/league/get-league-trends.ts:

    1. Define and export TrendData interface:
       ```typescript
       export interface TrendData {
         period: string;  // e.g., "Week 1", "Jan", "2025-W01"
         accuracy: number; // 0-100 percentage
         matchCount: number; // number of matches in period
       }
       ```

    2. Export async function getLeagueTrends(competitionId: string, periods: number = 8): Promise<TrendData[]>

    3. Query logic:
       - Group predictions by week (or month if insufficient weekly data)
       - Calculate accuracy per period: (correct_tendencies / scored_predictions) * 100
       - Return last N periods ordered chronologically
       - Use existing db patterns from queries.ts

    4. SQL approach (adapt to drizzle):
       ```sql
       SELECT
         TO_CHAR(m.kickoff_time, 'YYYY-"W"IW') as period,
         COUNT(*) as match_count,
         ROUND(100.0 * SUM(CASE WHEN p.tendency_points > 0 THEN 1 ELSE 0 END) /
               NULLIF(SUM(CASE WHEN p.status = 'scored' THEN 1 ELSE 0 END), 0), 1) as accuracy
       FROM predictions p
       JOIN matches m ON p.match_id = m.id
       WHERE m.competition_id = $1
         AND p.status = 'scored'
       GROUP BY period
       ORDER BY period DESC
       LIMIT $2
       ```

    5. Handle edge cases:
       - If no data: return empty array []
       - If fewer than requested periods: return what exists
       - Null accuracy values: filter out periods with no scored predictions

    6. Import from existing db setup (use getDb pattern from queries.ts)
  </action>
  <verify>
    Run `npx tsc --noEmit src/lib/league/get-league-trends.ts` - no type errors.
    Grep for 'getLeagueTrends' to confirm export.
  </verify>
  <done>
    getLeagueTrends() returns TrendData[] grouped by week/period.
    Empty data handled gracefully with empty array return.
    Query follows existing drizzle patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSS-only trend chart component</name>
  <files>src/components/league/league-trend-chart.tsx</files>
  <action>
    Create new file src/components/league/league-trend-chart.tsx:

    1. Import TrendData from '@/lib/league/get-league-trends'

    2. Props interface:
       ```typescript
       interface LeagueTrendChartProps {
         data: TrendData[];
         title?: string; // default: "Accuracy Trend"
       }
       ```

    3. Component structure:
       - If data.length === 0: return null (empty data = no chart)
       - Wrapper div with space-y-2
       - Title: text-sm font-medium text-muted-foreground
       - Chart container: flex items-end gap-1 h-24

    4. Bar rendering for each data point:
       - Calculate height: (accuracy / 100) * 100%
       - Color based on accuracy thresholds (user decision):
         - accuracy < 40: 'bg-loss' (red)
         - accuracy < 70: 'bg-draw' (amber)
         - accuracy >= 70: 'bg-win' (green)
       - These classes map to OKLCH colors in globals.css

    5. Bar structure:
       ```tsx
       <div className="flex-1 flex flex-col items-center gap-1">
         <div
           className={`w-full rounded-t ${colorClass} transition-all duration-300`}
           style={{ height: `${height}%` }}
           title={`${period}: ${accuracy.toFixed(1)}% (${matchCount} matches)`}
         />
         <span className="text-xs text-muted-foreground truncate w-full text-center">
           {formatPeriod(period)}
         </span>
       </div>
       ```

    6. Helper function formatPeriod(period: string): string
       - "2025-W01" -> "W1"
       - "2025-01" -> "Jan"
       - Keep short for display

    7. Accessibility:
       - Title attribute on bars for hover info
       - Visible labels below each bar
  </action>
  <verify>
    Run `npx tsc --noEmit src/components/league/league-trend-chart.tsx` - no type errors.
    Grep for 'bg-win\|bg-draw\|bg-loss' to confirm color classes used.
  </verify>
  <done>
    LeagueTrendChart renders CSS-only bar chart.
    Colors match accuracy thresholds (uses --win/--draw/--loss tokens).
    Empty data returns null (no broken UI).
    No JavaScript charting library used.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit src/lib/league/get-league-trends.ts src/components/league/league-trend-chart.tsx`
2. Files exist with correct exports:
   - getLeagueTrends function exported
   - TrendData type exported
   - LeagueTrendChart component exported
3. No charting library imports (grep for 'chart.js\|d3\|recharts' should return nothing)
</verification>

<success_criteria>
- LEAG-05 (Historical trends): Chart component ready for integration
- CSS-only implementation (no Chart.js/D3.js)
- Accuracy color coding matches AccuracyBadge thresholds
- Uses existing design tokens (--win, --draw, --loss)
- Empty data handled gracefully
- Query returns weekly grouped accuracy data
</success_criteria>

<output>
After completion, create `.planning/phases/20-league-page-rebuild/20-03-SUMMARY.md`
</output>
