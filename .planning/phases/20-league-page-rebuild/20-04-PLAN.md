---
phase: 20-league-page-rebuild
plan: 04
type: execute
wave: 2
depends_on: ["20-01", "20-02", "20-03"]
files_modified:
  - src/app/leagues/[slug]/league-hub-content.tsx
  - src/app/leagues/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "League page displays FAQ section at bottom with 5 dynamic questions"
    - "League page displays trend chart in stats dashboard area"
    - "JSON-LD contains combined @graph with SportsOrganization, BreadcrumbList, and FAQPage"
    - "All dynamic data fetched in parallel (no waterfall)"
  artifacts:
    - path: "src/app/leagues/[slug]/league-hub-content.tsx"
      provides: "Integrated league content with FAQ and trends"
      contains: "LeagueFAQ"
    - path: "src/app/leagues/[slug]/page.tsx"
      provides: "Combined schema @graph with FAQ"
      contains: "generateFAQPageSchema"
  key_links:
    - from: "src/app/leagues/[slug]/league-hub-content.tsx"
      to: "LeagueFAQ"
      via: "component import"
      pattern: "import.*LeagueFAQ"
    - from: "src/app/leagues/[slug]/league-hub-content.tsx"
      to: "LeagueTrendChart"
      via: "component import"
      pattern: "import.*LeagueTrendChart"
    - from: "src/app/leagues/[slug]/page.tsx"
      to: "generateFAQPageSchema"
      via: "function import"
      pattern: "import.*generateFAQPageSchema"
---

<objective>
Integrate FAQ, trends, and combined schema into league page.

Purpose: Complete league page rebuild with all LEAG requirements satisfied
Output: Fully integrated league page with FAQ, trends, and combined @graph schema
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-league-page-rebuild/20-RESEARCH.md

# Prior plan outputs (all Wave 1)
@.planning/phases/20-league-page-rebuild/20-01-SUMMARY.md
@.planning/phases/20-league-page-rebuild/20-02-SUMMARY.md
@.planning/phases/20-league-page-rebuild/20-03-SUMMARY.md

@src/app/leagues/[slug]/page.tsx
@src/app/leagues/[slug]/league-hub-content.tsx
@src/components/league/league-faq.tsx
@src/components/league/league-trend-chart.tsx
@src/lib/league/generate-league-faqs.ts
@src/lib/league/get-league-trends.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate FAQ and trends into LeagueHubContent</name>
  <files>src/app/leagues/[slug]/league-hub-content.tsx</files>
  <action>
    Update LeagueHubContent to include FAQ and trend chart:

    1. Add imports at top:
       ```typescript
       import { LeagueFAQ } from '@/components/league/league-faq';
       import { LeagueTrendChart } from '@/components/league/league-trend-chart';
       import { generateLeagueFAQs } from '@/lib/league/generate-league-faqs';
       import { getLeagueTrends } from '@/lib/league/get-league-trends';
       import { getCompetitionByIdOrAlias } from '@/lib/football/competitions';
       ```

    2. In LeagueInsights component, update Promise.all to include trends:
       ```typescript
       const [topModels, stats, predictionSummary, nextMatch, matches, trends] = await Promise.all([
         getTopModelsByCompetition(competitionId, 5),
         getCompetitionStats(competitionId),
         getCompetitionPredictionSummary(competitionId),
         getNextMatchForCompetition(competitionId),
         getMatchesByCompetitionId(competitionId, 1),
         getLeagueTrends(competitionId, 8),
       ]);
       ```

    3. Add LeagueTrendChart to the stats section (right column, after CompetitionStats):
       ```tsx
       <div className="lg:col-span-2 space-y-6">
         <CompetitionStats stats={stats} />
         {trends.length > 0 && (
           <Card className="mb-6">
             <CardHeader className="pb-3">
               <CardTitle className="text-lg">Accuracy Trend</CardTitle>
             </CardHeader>
             <CardContent>
               <LeagueTrendChart data={trends} />
             </CardContent>
           </Card>
         )}
         <CompetitionPredictionSummary summary={predictionSummary} />
       </div>
       ```

    4. Generate FAQs and add LeagueFAQ at the bottom of LeagueHubContent:
       - Get competition config: `const competition = getCompetitionByIdOrAlias(competitionId);`
       - Generate FAQs: `const faqs = generateLeagueFAQs({ competition: { id: competitionId, name: competition?.name || '' }, stats: { finishedMatches: stats.finishedMatches, avgGoalsPerMatch: stats.avgGoalsPerMatch }, topModel: topModels[0] });`
       - Add before closing div: `<LeagueFAQ faqs={faqs} />`

    5. Pass competition config properly for FAQ generation
  </action>
  <verify>
    Run `npm run build` - no build errors.
    Visit /leagues/epl and confirm:
    - Trend chart visible in stats section (if data exists)
    - FAQ section at bottom with 5 questions
  </verify>
  <done>
    LeagueTrendChart renders in stats dashboard area.
    LeagueFAQ renders at page bottom with 5 dynamic questions.
    All data fetched in parallel via Promise.all.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add FAQPage schema to combined @graph</name>
  <files>src/app/leagues/[slug]/page.tsx</files>
  <action>
    Update LeaguePage to include FAQPage schema in combined @graph:

    1. Add imports:
       ```typescript
       import { generateFAQPageSchema } from '@/lib/seo/schemas';
       import { generateLeagueFAQs } from '@/lib/league/generate-league-faqs';
       import { getCompetitionStats, getTopModelsByCompetition } from '@/lib/db/queries';
       ```

    2. In LeaguePage component, fetch data for FAQ generation:
       ```typescript
       // Fetch stats and top models for FAQ generation
       const [stats, topModels] = await Promise.all([
         getCompetitionStats(competition.id),
         getTopModelsByCompetition(competition.id, 1),
       ]);
       ```

    3. Generate FAQs:
       ```typescript
       const faqs = generateLeagueFAQs({
         competition: { id: competition.id, name: competition.name },
         stats: {
           finishedMatches: stats.finishedMatches,
           avgGoalsPerMatch: stats.avgGoalsPerMatch,
         },
         topModel: topModels[0],
       });
       ```

    4. Add FAQPage schema to @graph:
       ```typescript
       const faqSchema = generateFAQPageSchema(faqs);

       const schema = {
         '@context': 'https://schema.org',
         '@graph': [competitionSchema, breadcrumbs, faqSchema],
       };
       ```

    5. Note: This duplicates FAQ generation between page.tsx and league-hub-content.tsx.
       This is intentional - page.tsx needs it for schema, hub-content needs it for rendering.
       Next.js request deduplication handles duplicate queries.
  </action>
  <verify>
    Run `npm run build` - no errors.
    Visit /leagues/epl and view page source.
    Confirm JSON-LD script contains @graph with 3 items:
    - SportsOrganization (with areaServed, description)
    - BreadcrumbList
    - FAQPage (with 5 questions)
  </verify>
  <done>
    Combined @graph contains SportsOrganization + BreadcrumbList + FAQPage.
    FAQPage schema questions match visible FAQ content exactly (same source).
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and cleanup</name>
  <files>
    src/app/leagues/[slug]/page.tsx
    src/app/leagues/[slug]/league-hub-content.tsx
  </files>
  <action>
    Final verification pass:

    1. Run full build: `npm run build`

    2. Check for unused imports in both files

    3. Verify parallel fetching (no await waterfall):
       - page.tsx: Promise.all for stats/topModels
       - league-hub-content.tsx: Promise.all for all 6 fetches

    4. Test with different competitions:
       - /leagues/epl (should have data)
       - /leagues/ucl (should have data)
       - Verify FAQ content differs based on competition name

    5. Validate JSON-LD with Google Rich Results Test:
       - Copy JSON-LD from page source
       - Paste into https://search.google.com/test/rich-results
       - Should show valid SportsOrganization and FAQPage

    6. Check for any TypeScript errors: `npx tsc --noEmit`
  </action>
  <verify>
    `npm run build` succeeds.
    `npx tsc --noEmit` succeeds.
    Visit /leagues/epl:
    - Page loads without errors
    - FAQ section visible at bottom
    - Trend chart visible (if data exists)
    - JSON-LD contains all 3 schema types
  </verify>
  <done>
    All LEAG requirements satisfied:
    - LEAG-01: Dynamic SEO metadata with stats
    - LEAG-02: Enhanced SportsOrganization schema
    - LEAG-03: FAQ section with FAQPage schema
    - LEAG-04: Stats dashboard (existing + trends)
    - LEAG-05: Historical trend visualization
    No TypeScript or build errors.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. TypeScript clean: `npx tsc --noEmit`
3. Visual verification at /leagues/epl:
   - Title includes "35 Models"
   - Meta description mentions match count
   - Trend chart visible in stats section
   - FAQ section at bottom with 5 questions
   - Questions mention "Premier League" specifically
4. JSON-LD verification:
   - View page source, find script type="application/ld+json"
   - Contains @graph array with 3 items
   - SportsOrganization has areaServed: "England"
   - FAQPage has 5 Question items
   - All answers <= 300 chars
</verification>

<success_criteria>
- All 5 LEAG requirements complete:
  - LEAG-01: SEO metadata optimized
  - LEAG-02: SportsOrganization schema enhanced
  - LEAG-03: FAQ section with schema
  - LEAG-04: Stats dashboard complete
  - LEAG-05: Trend visualization working
- Combined @graph pattern (single JSON-LD script)
- Parallel data fetching (no waterfall)
- Visual consistency with existing page sections
</success_criteria>

<output>
After completion, create `.planning/phases/20-league-page-rebuild/20-04-SUMMARY.md`
</output>
