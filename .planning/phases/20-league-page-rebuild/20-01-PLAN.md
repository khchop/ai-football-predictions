---
phase: 20-league-page-rebuild
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/seo/schema/competition.ts
  - src/app/leagues/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "League pages have dynamic SEO titles with competition stats"
    - "League pages have dynamic descriptions mentioning match count and accuracy"
    - "SportsOrganization schema includes sport, areaServed, and description properties"
    - "OG images receive real stats (matchCount, upcomingCount) instead of zeros"
  artifacts:
    - path: "src/lib/seo/schema/competition.ts"
      provides: "Enhanced SportsOrganization schema builder"
      exports: ["buildCompetitionSchema", "buildEnhancedCompetitionSchema"]
    - path: "src/app/leagues/[slug]/page.tsx"
      provides: "Dynamic metadata with stats integration"
      contains: "generateMetadata"
  key_links:
    - from: "src/app/leagues/[slug]/page.tsx"
      to: "getCompetitionStats"
      via: "parallel fetch in generateMetadata"
      pattern: "getCompetitionStats.*competitionId"
    - from: "src/lib/seo/schema/competition.ts"
      to: "CompetitionConfig"
      via: "type import"
      pattern: "import.*CompetitionConfig"
---

<objective>
Enhance league page SEO metadata and SportsOrganization schema with dynamic stats integration.

Purpose: Enable rich search snippets and help AI search engines understand league structure (LEAG-01, LEAG-02)
Output: Dynamic metadata with stats, enhanced SportsOrganization schema
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-league-page-rebuild/20-RESEARCH.md

@src/lib/seo/schema/competition.ts
@src/app/leagues/[slug]/page.tsx
@src/lib/db/queries.ts (getCompetitionStats function)
@src/lib/football/competitions.ts (CompetitionConfig type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance SportsOrganization schema builder</name>
  <files>src/lib/seo/schema/competition.ts</files>
  <action>
    Create `buildEnhancedCompetitionSchema()` function that extends the existing schema with:

    1. Add interface `EnhancedCompetitionData`:
       - competition: CompetitionConfig
       - stats?: { totalMatches: number; finishedMatches: number; avgGoalsPerMatch: number }

    2. Enhance SportsOrganization schema:
       - Keep existing @id, name, url, sport properties
       - Add `areaServed`: derive from competition.id (e.g., 'epl' -> 'England', 'bundesliga' -> 'Germany')
       - Add `description`: dynamic with stats ("Premier League football competition with 250 matches tracked and AI predictions from 35 models") or static fallback
       - Keep @type as 'SportsOrganization' (SportsLeague does NOT exist in Schema.org)

    3. Create helper function `getCountryFromCompetitionId(id: string): string`:
       - Map competition IDs to countries/regions (epl->England, laliga->Spain, etc.)
       - Default to 'Europe' for unknowns

    4. Keep existing `buildCompetitionSchema()` for backward compatibility

    Use schema-dts types (already imported). Do NOT add sameAs property yet (would need external URLs in CompetitionConfig).
  </action>
  <verify>
    Run `npx tsc --noEmit src/lib/seo/schema/competition.ts` - no type errors.
    Grep for 'buildEnhancedCompetitionSchema' in the file to confirm export exists.
  </verify>
  <done>
    buildEnhancedCompetitionSchema() returns SportsOrganization with sport, areaServed, description.
    Existing buildCompetitionSchema() unchanged for backward compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance generateMetadata with dynamic stats</name>
  <files>src/app/leagues/[slug]/page.tsx</files>
  <action>
    Update generateMetadata() to fetch and use competition stats:

    1. Import getCompetitionStats from '@/lib/db/queries'

    2. In generateMetadata():
       - After getting competition, call `const stats = await getCompetitionStats(competition.id)`
       - This is OK in metadata - Next.js deduplicates the fetch

    3. Update title format:
       - Current: "{shortName} Predictions | kroam.xyz"
       - New: "{shortName} AI Predictions | 35 Models | kroam.xyz"

    4. Update description dynamically:
       - If stats.finishedMatches > 0: "AI predictions for {name} from 35 models. {finishedMatches} matches analyzed with {avgGoalsPerMatch} avg goals. Track model accuracy and compare predictions."
       - Else: keep existing static description

    5. Fix OG image URL parameters:
       - Current: matchCount: '0', upcomingCount: '0' (hardcoded)
       - New: matchCount: String(stats?.finishedMatches || 0), upcomingCount: String(stats?.scheduledMatches || 0)

    6. Update keywords to include more variations:
       - Add '{name} predictions', '{name} AI', 'football betting tips'
  </action>
  <verify>
    Run `npm run build` and check for no build errors.
    Visit /leagues/epl and inspect page source for updated meta description with match count.
  </verify>
  <done>
    generateMetadata returns dynamic description with stats.
    OG image URL includes real matchCount and upcomingCount values.
    Title includes "35 Models" for differentiation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire enhanced schema to page component</name>
  <files>src/app/leagues/[slug]/page.tsx</files>
  <action>
    Update the LeaguePage component to use enhanced schema:

    1. Import buildEnhancedCompetitionSchema from '@/lib/seo/schema/competition'

    2. In LeaguePage component:
       - Fetch stats in parallel with existing work: `const stats = await getCompetitionStats(competition.id)`
       - Call buildEnhancedCompetitionSchema({ competition, stats }) instead of buildCompetitionSchema(competition)

    3. The schema @graph already combines competitionSchema + breadcrumbs - no changes needed there.

    Note: FAQ schema will be added in Plan 04 (integration plan) after FAQ component is built.
  </action>
  <verify>
    Run `npm run build` - no errors.
    Visit /leagues/epl and view page source.
    Confirm JSON-LD script contains areaServed and description properties in SportsOrganization.
  </verify>
  <done>
    League page JSON-LD contains enhanced SportsOrganization with:
    - areaServed: "England" (for EPL)
    - description: dynamic with match count
    - sport: "Football"
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Visit /leagues/epl and check:
   - Page title includes "35 Models"
   - Meta description mentions match count
   - JSON-LD has SportsOrganization with areaServed and description
   - OG image URL has non-zero matchCount/upcomingCount
</verification>

<success_criteria>
- LEAG-01 (SEO metadata): Title optimized, description dynamic with stats
- LEAG-02 (Structured data): SportsOrganization schema enhanced with areaServed, description
- OG images receive real stats instead of zeros
- Backward compatibility maintained (existing buildCompetitionSchema unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/20-league-page-rebuild/20-01-SUMMARY.md`
</output>
