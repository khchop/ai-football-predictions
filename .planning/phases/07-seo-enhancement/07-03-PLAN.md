---
phase: 07-seo-enhancement
plan: 03
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified:
  - src/app/sitemap/static.xml/route.ts
  - src/lib/seo/constants.ts
  - src/lib/seo/metadata.ts
  - src/app/page.tsx
  - src/app/api/og/route.tsx
autonomous: true

must_haves:
  truths:
    - "Sitemap includes /methodology page"
    - "All pages pass Google Rich Results Test without errors"
    - "Meta descriptions are under 160 characters"
    - "Social shares display Prediction Accuracy: X% label"
    - "Homepage has WebSite + SearchAction structured data"
    - "OG image displays 'Prediction Accuracy: X%' label clearly"
  artifacts:
    - path: "src/app/sitemap/static.xml/route.ts"
      provides: "Static sitemap including methodology page"
      contains: "methodology"
    - path: "src/app/api/og/route.tsx"
      provides: "OG image with accuracy label"
      contains: "Prediction Accuracy"
  key_links:
    - from: "src/app/sitemap.xml/route.ts"
      to: "src/app/sitemap/static.xml/route.ts"
      via: "sitemap index reference"
      pattern: "static.xml"
    - from: "src/app/page.tsx"
      to: "SearchAction"
      via: "JSON-LD in homepage"
      pattern: "SearchAction"
---

<objective>
Finalize SEO implementation with sitemap updates, homepage SearchAction, OG image accuracy labels, and validation sweep.

Purpose: Ensure /methodology page (created in Phase 6) is discoverable by search engines, homepage enables sitelinks searchbox via SearchAction, OG images clearly show accuracy metric, and validate that all structured data passes Google's Rich Results Test requirements.

Output: Updated sitemap, validated schemas, homepage SearchAction, enhanced OG images, and confirmation that all success criteria from roadmap are met.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-seo-enhancement/07-CONTEXT.md
@.planning/phases/07-seo-enhancement/07-01-SUMMARY.md
@.planning/phases/07-seo-enhancement/07-02-SUMMARY.md
@src/app/sitemap/static.xml/route.ts
@src/app/methodology/page.tsx
@src/app/page.tsx
@src/app/api/og/route.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add methodology page to sitemap and validate homepage SearchAction</name>
  <files>
    src/app/sitemap/static.xml/route.ts
    src/app/page.tsx
  </files>
  <action>
1. Update `src/app/sitemap/static.xml/route.ts`:
   - Add /methodology to static URLs array with:
     - priority: 0.7 (important reference page)
     - changefreq: 'monthly' (rarely changes)
     - lastmod: current date
   - Verify other static pages are included:
     - / (homepage) - priority 1.0
     - /about - priority 0.6
     - /leaderboard - priority 0.9
     - /matches - priority 0.8
     - /blog - priority 0.7
     - /methodology - priority 0.7 (NEW)

If static sitemap doesn't exist, check sitemap structure and add /methodology wherever static pages are defined.

2. Validate/add homepage SearchAction in `src/app/page.tsx`:
   - Check if WebSite + SearchAction schema already exists (user noted "already exists")
   - If exists: Verify it has correct structure:
     - @type: "WebSite"
     - @id: "{BASE_URL}/#website"
     - name: "kroam.xyz"
     - url: "{BASE_URL}"
     - potentialAction: {
         @type: "SearchAction",
         target: "{BASE_URL}/search?q={search_term_string}",
         query-input: "required name=search_term_string"
       }
   - If missing or incomplete: Add the WebSite + SearchAction schema
   - Ensure JSON-LD is rendered in the page (either in generateMetadata or as script tag in component)
  </action>
  <verify>
    Build and check sitemap: `npm run build && curl -s http://localhost:3000/sitemap/static.xml | grep methodology`
    Or if using dev: `npm run dev &` then `sleep 5 && curl -s http://localhost:3000/sitemap/static.xml | grep methodology`
    Check homepage SearchAction: `curl -s http://localhost:3000 | grep -o 'SearchAction'`
  </verify>
  <done>
    /methodology page included in sitemap with appropriate priority
    Sitemap validates as proper XML
    Homepage has WebSite + SearchAction structured data
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OG image generation to include accuracy label</name>
  <files>
    src/app/api/og/route.tsx
  </files>
  <action>
1. Update `src/app/api/og/route.tsx` to display accuracy metric:
   - Add query parameter support: `?accuracy=85` (percentage value)
   - When accuracy provided, display "Prediction Accuracy: X%" prominently
   - Positioning: Below the main title/content, in a clearly visible badge or callout
   - Styling guidelines:
     - Use contrasting color for the accuracy badge (e.g., green on dark background)
     - Font size large enough to be legible in social media previews (minimum 24px equivalent)
     - Format: "Prediction Accuracy: 85%" (not just "85%")

2. Update OG image layout to accommodate accuracy:
   - If accuracy is provided:
     - Main content area (title, teams, etc) in upper 2/3
     - Accuracy badge in lower section or corner
   - If accuracy is not provided:
     - Keep existing layout unchanged

3. Ensure proper number formatting:
   - Round to nearest integer: 85.4 -> 85%
   - Handle edge cases: missing/invalid accuracy -> omit badge entirely
   - Cap at 100%, floor at 0%

Example URL: `/api/og?title=Arsenal+vs+Chelsea&accuracy=85`
Should render: Image with "Arsenal vs Chelsea" and "Prediction Accuracy: 85%" badge
  </action>
  <verify>
    Start dev server and test OG image:
    `npm run dev &`
    `sleep 5`
    `curl -s "http://localhost:3000/api/og?accuracy=85" -o /tmp/og-test.png && file /tmp/og-test.png`
    Should return "PNG image data"
    Manual inspection: Open /tmp/og-test.png to verify accuracy label is visible
  </verify>
  <done>
    OG image endpoint accepts accuracy parameter
    Accuracy displays as "Prediction Accuracy: X%" when provided
    Layout accommodates accuracy badge without obscuring main content
    Missing accuracy parameter gracefully handled (no badge shown)
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate schema output and metadata length constraints</name>
  <files>
    src/lib/seo/schema/sports-event.ts
    src/lib/seo/schema/article.ts
    src/lib/seo/schema/competition.ts
    src/lib/seo/schema/graph.ts
    src/lib/seo/metadata.ts
    src/lib/seo/constants.ts
  </files>
  <action>
1. Review all schema builders for Google Rich Results requirements:

   SportsEvent (src/lib/seo/schema/sports-event.ts):
   - Required: name, startDate (ISO-8601 with timezone), location.Place
   - Required by Google: eventStatus (https://schema.org/EventScheduled)
   - For finished: Add homeTeamScore, awayTeamScore properties
   - Verify competitor array has @type: "SportsTeam" for each

   Article (src/lib/seo/schema/article.ts):
   - Required: headline, datePublished, author, publisher.logo
   - publisher must have logo.ImageObject with url property
   - image must be array of URLs or ImageObject

   Competition/SportsOrganization:
   - Required: name, url
   - sport should be "Football" (string)

   BreadcrumbList:
   - Required: itemListElement array
   - Each ListItem needs: position (1-indexed), name, item (URL)

2. Ensure all schemas include @context: "https://schema.org" at graph level (not individual items)

3. Fix any missing required properties identified above

4. Add length validation helpers to `src/lib/seo/constants.ts`:
   - MAX_TITLE_LENGTH = 60
   - MAX_META_DESCRIPTION_LENGTH = 155
   - MAX_OG_DESCRIPTION_LENGTH = 200

5. Update `src/lib/seo/metadata.ts`:
   - Add helper function `truncateWithEllipsis(text: string, maxLength: number): string`
   - Apply to all description generators:
     - createDescription() output truncated to 155 chars
     - OG descriptions truncated to 200 chars
     - Titles truncated to 60 chars (but prioritize removing site name suffix over truncating content)

   Truncation strategy:
   - If over limit, truncate at last word boundary before limit
   - Add "..." only if actually truncated
   - Never break mid-word

6. Test accuracy label fits: "Prediction Accuracy: X%" = 23 chars, leaves ~130 chars for rest of description
  </action>
  <verify>
    Run build: `npm run build`
    No TypeScript errors in schema files
    Constants exist: `grep "MAX_.*LENGTH" src/lib/seo/constants.ts`
    Truncation helper exists: `grep "truncateWithEllipsis" src/lib/seo/metadata.ts`
    Manually test one page JSON-LD is valid JSON: `curl -s localhost:3000 | grep -oP '(?<=application/ld\+json">)[^<]+' | head -1 | jq .` (if jq available)
  </verify>
  <done>
    All schema builders include required properties for Rich Results
    JSON-LD output is valid JSON
    No TypeScript errors in schema files
    Length constants defined in constants.ts
    Truncation helper implemented and used
    All metadata functions respect length limits
    Accuracy label fits within limits
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Sitemap includes methodology: Check static.xml for /methodology entry
3. Homepage SearchAction: `curl -s http://localhost:3000 | grep SearchAction`
4. OG image accuracy: Test endpoint with accuracy parameter renders correctly
5. Schema validation: All schema files compile without errors
6. Length constraints: Constants and truncation helper exist
7. Manual spot check: Start dev server, inspect a few pages for valid JSON-LD
</verification>

<success_criteria>
- Sitemap includes /methodology with priority 0.7
- Homepage has WebSite + SearchAction structured data for sitelinks searchbox
- OG image displays "Prediction Accuracy: X%" label when accuracy provided
- All schema builders have required Google Rich Results properties
- Meta descriptions enforced under 160 characters
- Titles enforced under 60 characters
- OG descriptions under 200 characters
- Build passes without errors
- JSON-LD output is valid on all enhanced pages
</success_criteria>

<output>
After completion, create `.planning/phases/07-seo-enhancement/07-03-SUMMARY.md`
</output>
