---
phase: 30-layout-assembly
plan: 03
type: execute
wave: 2
depends_on: [30-01, 30-02]
files_modified:
  - src/app/leagues/[slug]/[match]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Match page uses MatchLayout component"
    - "Predictions data passed from server to MatchLayout"
    - "FAQs generated at server level and passed to MatchLayout"
    - "Schema and breadcrumbs remain outside Provider (SSR optimized)"
    - "Page renders without errors for all match states"
  artifacts:
    - path: "src/app/leagues/[slug]/[match]/page.tsx"
      provides: "Integrated match page with new layout"
      min_lines: 100
  key_links:
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "MatchLayout"
      via: "Component import and render"
      pattern: "<MatchLayout"
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "MatchDataProvider"
      via: "Context wrapper"
      pattern: "<MatchDataProvider"
---

<objective>
Replace match page content with new MatchLayout component, wiring predictions and FAQ data from server.

Purpose: Integrate the state-aware MatchLayout component into the match page, replacing the old layout with the new component composition.
Output: Updated page.tsx that renders MatchLayout with correct data flow.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/30-layout-assembly/30-CONTEXT.md
@.planning/phases/30-layout-assembly/30-RESEARCH.md
@.planning/phases/30-layout-assembly/30-01-SUMMARY.md
@src/app/leagues/[slug]/[match]/page.tsx
@src/components/match/match-layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify and integrate MatchLayout</name>
  <files>src/app/leagues/[slug]/[match]/page.tsx</files>
  <action>
Rewrite the page.tsx to use the new MatchLayout component. Keep server-side data fetching and schema generation, replace the layout with MatchLayout.

**Key changes:**

1. **Keep these sections** (they're SSR-optimized per WRAP-001/002):
   - MatchPageSchema (JSON-LD)
   - BreadcrumbsWithSchema
   - Metadata generation
   - Server-side data fetching (match, competition, analysis, predictions, FAQs)

2. **Remove these sections** (deprecated per CONTEXT.md):
   - MatchH1 (sr-only H1 - hero has visible H1-equivalent)
   - Back to league link (hero has competition info)
   - MatchTLDR
   - MatchPageHeader
   - Match Events card
   - MatchStats
   - MatchContentSection
   - PredictionTable with avg prediction analysis
   - TopPerformers
   - Explore More card
   - RelatedMatchesWidget

3. **New structure:**
   ```tsx
   return (
     <div className="max-w-4xl mx-auto space-y-8">
       <MatchPageSchema
         match={matchData}
         competition={{ name: competition.name, slug: competitionSlug }}
         url={`https://kroam.xyz/leagues/${competitionSlug}/${matchData.slug}`}
         faqs={faqs}
       />
       <BreadcrumbsWithSchema items={breadcrumbs} />

       <MatchDataProvider
         match={matchData}
         competition={competition}
         analysis={analysis}
       >
         <MatchLayout
           predictions={formattedPredictions}
           faqs={aiFaqs}
         />
       </MatchDataProvider>
     </div>
   );
   ```

4. **Format predictions** for SortablePredictionsTable interface:
   ```tsx
   const formattedPredictions = predictions.map(p => ({
     id: p.predictionId,
     modelId: p.modelId,
     modelDisplayName: p.modelDisplayName,
     provider: p.provider,
     predictedHomeScore: p.predictedHome,
     predictedAwayScore: p.predictedAway,
     points: p.totalPoints,
     isExact: p.exactScoreBonus !== null && p.exactScoreBonus > 0,
     isCorrectResult: p.tendencyPoints !== null && p.tendencyPoints > 0,
   }));
   ```

5. **Simplify data fetching:**
   - Keep: getMatchBySlug, getMatchWithAnalysis, getPredictionsForMatchWithDetails, getMatchFAQContent
   - Remove: getNextMatchesForTeams, getMatchRoundup, getActiveModels, getMatchEvents (not needed in new layout)

6. **Update imports:**
   - Add: `import { MatchLayout } from '@/components/match/match-layout';`
   - Remove: All deprecated component imports (MatchH1, MatchPageHeader, MatchTLDR, etc.)
  </action>
  <verify>
1. Build succeeds: `npm run build 2>&1 | tail -20`
2. Page renders: Check for TypeScript errors in VSCode
3. MatchLayout imported: `grep -n "import.*MatchLayout" src/app/leagues/[slug]/[match]/page.tsx`
4. Old components removed: `grep -c "MatchH1\|MatchTLDR\|MatchPageHeader\|RelatedMatches" src/app/leagues/[slug]/[match]/page.tsx` should be 0
  </verify>
  <done>
- Page uses MatchLayout inside MatchDataProvider
- Predictions formatted and passed as props
- FAQs passed as props
- Schema and breadcrumbs remain outside Provider
- Deprecated sections removed
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Update /matches/[id] redirect page</name>
  <files>src/app/matches/[id]/page.tsx</files>
  <action>
The /matches/[id] route is a legacy redirect that forwards to /leagues/[slug]/[match]. Simplify it to only perform the redirect.

**Review current behavior:**
- If match has slug and competition.id, it does permanentRedirect
- If not, it renders a full page with old components

**New behavior:**
- ALWAYS redirect to /leagues/[slug]/[match] if possible
- If match doesn't have slug/competition, return notFound()

Simplify to:
```tsx
import { notFound, permanentRedirect } from 'next/navigation';
import { getMatchWithAnalysis } from '@/lib/db/queries';
import type { Metadata } from 'next';

interface MatchPageProps {
  params: Promise<{ id: string }>;
}

export async function generateMetadata({ params }: MatchPageProps): Promise<Metadata> {
  return {
    title: 'Redirecting...',
    robots: { index: false },
  };
}

export default async function MatchPage({ params }: MatchPageProps) {
  const { id } = await params;
  const result = await getMatchWithAnalysis(id);

  if (!result) {
    notFound();
  }

  const { match, competition } = result;

  // Redirect to canonical URL
  if (match.slug && competition.id) {
    permanentRedirect(`/leagues/${competition.id}/${match.slug}`);
  }

  // Fallback - shouldn't happen for valid matches
  notFound();
}
```

This removes ALL the old component rendering from this file - the canonical page is leagues/[slug]/[match].
  </action>
  <verify>
1. Build succeeds: `npm run build 2>&1 | tail -20`
2. Page simplified: `wc -l src/app/matches/[id]/page.tsx` should be < 40 lines
3. No old imports: `grep -c "MatchHeader\|MatchOdds\|PredictionsSection" src/app/matches/[id]/page.tsx` should be 0
  </verify>
  <done>
- /matches/[id] simplified to redirect-only
- Old component rendering removed
- Always redirects to canonical URL
- Returns notFound() for invalid matches
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Match page renders correctly in browser (manual test)
3. No TypeScript errors
4. Old imports removed from both page files
</verification>

<success_criteria>
- [ ] leagues/[slug]/[match]/page.tsx uses MatchLayout
- [ ] Predictions data correctly formatted and passed
- [ ] FAQs passed to MatchLayout
- [ ] Schema/breadcrumbs outside Provider (SSR optimized)
- [ ] matches/[id]/page.tsx simplified to redirect-only
- [ ] Build succeeds
- [ ] No old component imports remain in page files
</success_criteria>

<output>
After completion, create `.planning/phases/30-layout-assembly/30-03-SUMMARY.md`
</output>
