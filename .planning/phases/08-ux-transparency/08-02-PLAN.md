---
phase: 08-ux-transparency
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/leaderboard-table.tsx
  - src/app/models/[id]/page.tsx
  - src/components/model-stats-grid.tsx
  - src/components/model-competition-breakdown.tsx
autonomous: true

must_haves:
  truths:
    - "User sees denominator alongside percentage on leaderboard (e.g., 81/160 (50.6%))"
    - "User can hover on accuracy metric to see tooltip explaining calculation methodology"
    - "Model detail page hero shows denominator format for accuracy"
    - "Numbers match between leaderboard and model detail pages for same model"
    - "Accuracy percentages match manual calculation: correctTendencies / totalPredictions * 100"
  artifacts:
    - path: "src/components/leaderboard-table.tsx"
      provides: "Leaderboard with AccuracyDisplay in accuracy column"
      contains: "AccuracyDisplay"
    - path: "src/app/models/[id]/page.tsx"
      provides: "Model page with AccuracyDisplay in hero stats"
      contains: "AccuracyDisplay"
    - path: "src/components/model-stats-grid.tsx"
      provides: "Stats grid with AccuracyDisplay for accuracy stat"
      contains: "AccuracyDisplay"
  key_links:
    - from: "src/components/leaderboard-table.tsx"
      to: "src/components/accuracy-display.tsx"
      via: "import { AccuracyDisplay }"
      pattern: "AccuracyDisplay.*correct=.*total="
    - from: "src/app/models/[id]/page.tsx"
      to: "src/components/accuracy-display.tsx"
      via: "import { AccuracyDisplay }"
      pattern: "AccuracyDisplay.*correct=.*total="
    - from: "src/lib/db/queries/stats.ts getLeaderboard()"
      to: "predictions table"
      via: "JOIN with status='scored' filter"
      pattern: "eq\\(predictions\\.status.*scored"
---

<objective>
Integrate AccuracyDisplay component across all accuracy displays in the application

Purpose: Users now see "81/160 (50.6%)" instead of just "50.6%" everywhere accuracy is shown. Hovering reveals a tooltip explaining what the metric means and linking to the methodology page. This builds trust by showing the denominator users can verify.

Output: Updated leaderboard table, model page, and stats grid all using consistent AccuracyDisplay component
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ux-transparency/08-RESEARCH.md
@.planning/phases/08-ux-transparency/08-01-SUMMARY.md

# Files being modified
@src/components/leaderboard-table.tsx
@src/app/models/[id]/page.tsx
@src/components/model-stats-grid.tsx
@src/components/accuracy-display.tsx

# Data source verification (read to confirm totalPredictions = scoredPredictions)
@src/lib/db/queries/stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update leaderboard-table.tsx to use AccuracyDisplay</name>
  <files>src/components/leaderboard-table.tsx</files>
  <action>
Update `src/components/leaderboard-table.tsx`:

**IMPORTANT DATA MODEL VERIFICATION:**
Before implementing, confirm that `totalPredictions` in the leaderboard API equals scored predictions.
Check `src/lib/db/queries/stats.ts` getLeaderboard() function (around line 262-384):
- The query uses `leftJoin(predictions, and(eq(predictions.modelId, models.id), eq(predictions.status, 'scored')))`
- This JOIN filter means only scored predictions are counted
- Therefore `totalPredictions = COUNT(predictions.id)` is the correct denominator

1. Add import at top:
   `import { AccuracyDisplay } from '@/components/accuracy-display'`

2. The LeaderboardEntry interface already has the required fields:
   - totalPredictions: number (scored predictions count - verified from query)
   - correctTendencies?: number (correct tendency count)
   - correctResults?: number (legacy fallback)

3. Update the accuracy column (column id 'accuracy', around line 294-322):

   BEFORE:
   ```tsx
   cell: ({ getValue }) => {
     const accuracy = getValue() as number;
     return (
       <div className="flex items-center gap-2">
         <div className="flex-1 h-2 bg-muted rounded-full overflow-hidden min-w-[50px]">
           <div className={...} style={{ width: `${accuracy}%` }} />
         </div>
         <span className="text-xs text-muted-foreground font-mono w-10 text-right">
           {accuracy}%
         </span>
       </div>
     );
   }
   ```

   AFTER:
   ```tsx
   cell: ({ row }) => {
     const entry = row.original;
     const correct = entry.correctTendencies ?? entry.correctResults ?? 0;
     const total = entry.totalPredictions; // This IS scoredPredictions (verified: query filters status='scored')
     const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
     return (
       <div className="flex items-center gap-2">
         <div className="flex-1 h-2 bg-muted rounded-full overflow-hidden min-w-[50px]">
           <div
             className={cn(
               "h-full rounded-full transition-all",
               accuracy >= 50 ? "bg-gradient-to-r from-green-500 to-green-400" :
               accuracy >= 30 ? "bg-gradient-to-r from-yellow-500 to-yellow-400" :
               "bg-gradient-to-r from-red-500 to-red-400"
             )}
             style={{ width: `${accuracy}%` }}
           />
         </div>
         <AccuracyDisplay
           correct={correct}
           total={total}
           size="sm"
           className="min-w-[80px]"
         />
       </div>
     );
   }
   ```

4. Update MobileCard accuracy section (around line 446-462):

   BEFORE:
   ```tsx
   <div className="flex items-center gap-2">
     <div className="flex-1 h-2 bg-muted rounded-full overflow-hidden">
       <div className={...} style={{ width: `${accuracy}%` }} />
     </div>
     <span className="text-xs text-muted-foreground font-mono w-10 text-right">
       {accuracy}%
     </span>
   </div>
   ```

   AFTER:
   ```tsx
   <div className="flex items-center gap-2">
     <div className="flex-1 h-2 bg-muted rounded-full overflow-hidden">
       <div
         className={cn(
           "h-full rounded-full transition-all",
           accuracy >= 50 ? "bg-gradient-to-r from-green-500 to-green-400" :
           accuracy >= 30 ? "bg-gradient-to-r from-yellow-500 to-yellow-400" :
           "bg-gradient-to-r from-red-500 to-red-400"
         )}
         style={{ width: `${accuracy}%` }}
       />
     </div>
     <AccuracyDisplay
       correct={correctCount}
       total={entry.totalPredictions}
       size="sm"
     />
   </div>
   ```

5. Remove the native `title` attribute from streak indicators (lines 129, 137, 145, 152) - these should use Radix tooltips in future, but for now just remove the `title` to avoid conflicts with future tooltip additions.

6. Keep the existing getAccuracy() helper for the progress bar gradient logic.
  </action>
  <verify>
    - AccuracyDisplay imported at top of file
    - Desktop table accuracy column uses AccuracyDisplay component
    - Mobile card accuracy section uses AccuracyDisplay component
    - Build passes: `npm run build 2>&1 | grep -i error | head -5 || echo "Build OK"`
  </verify>
  <done>
    - Leaderboard shows "X/Y (Z%)" format in accuracy column
    - Both desktop and mobile views updated
    - Progress bar retained alongside AccuracyDisplay
    - Hover reveals methodology tooltip
  </done>
</task>

<task type="auto">
  <name>Task 2: Update model detail page to use AccuracyDisplay</name>
  <files>src/app/models/[id]/page.tsx</files>
  <action>
Update `src/app/models/[id]/page.tsx`:

1. Add import at top:
   `import { AccuracyDisplay } from '@/components/accuracy-display'`

2. Update the hero stats "Accuracy" card (around line 250-260):

   BEFORE:
   ```tsx
   <Card className="bg-card/50 border-border/50">
     <CardContent className="p-6">
       <div className="flex items-center gap-2 mb-2">
         <Sparkles className="h-4 w-4 text-primary" />
         <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Accuracy</p>
       </div>
       <p className="text-4xl font-bold font-mono">{tendencyAccuracy}%</p>
       <p className="text-xs text-muted-foreground mt-1">tendency</p>
     </CardContent>
   </Card>
   ```

   AFTER:
   ```tsx
   <Card className="bg-card/50 border-border/50">
     <CardContent className="p-6">
       <div className="flex items-center gap-2 mb-2">
         <Sparkles className="h-4 w-4 text-primary" />
         <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Accuracy</p>
       </div>
       <AccuracyDisplay
         correct={predictionStats?.correctTendencies || 0}
         total={scoredPredictions}
         size="lg"
         className="text-4xl"
       />
       <p className="text-xs text-muted-foreground mt-1">tendency</p>
     </CardContent>
   </Card>
   ```

3. The existing variables `scoredPredictions` and `predictionStats.correctTendencies` are already calculated correctly (lines 136-141).

4. Remove the `tendencyAccuracy` variable calculation if it becomes unused after this change, or keep it if used elsewhere in the file.
  </action>
  <verify>
    - AccuracyDisplay imported at top of file
    - Hero stats accuracy card uses AccuracyDisplay with size="lg"
    - correct prop uses predictionStats.correctTendencies
    - total prop uses scoredPredictions (not totalPredictions)
    - Build passes: `npm run build 2>&1 | grep -i "models/\[id\]" | head -5 || echo "Build OK"`
  </verify>
  <done>
    - Model page hero shows "X/Y (Z%)" format for accuracy
    - Large size variant matches existing visual prominence
    - Tooltip explains methodology when hovering
    - Uses correct denominator (scoredPredictions)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update model-stats-grid and model-competition-breakdown</name>
  <files>
    src/components/model-stats-grid.tsx
    src/components/model-competition-breakdown.tsx
  </files>
  <action>
**Part A: Update model-stats-grid.tsx**

1. Add import:
   `import { AccuracyDisplay } from '@/components/accuracy-display'`

2. Update ModelStats interface to include correctTendencies (already present at line 13)

3. Update the Accuracy stat card (around line 87-92):

   The current pattern uses a statCards array. Update the accuracy entry:

   BEFORE:
   ```tsx
   {
     label: 'Accuracy',
     value: `${stats.accuracy}%`,
     icon: Target,
     color: stats.accuracy >= 50 ? 'text-green-400' : stats.accuracy >= 30 ? 'text-yellow-400' : 'text-red-400',
   },
   ```

   Instead of modifying the statCards pattern extensively, add a special case for accuracy in the render (around line 134-143):

   ```tsx
   {statCards.map((stat) => (
     <div
       key={stat.label}
       className="rounded-xl bg-card/50 border border-border/50 p-4 text-center"
     >
       <stat.icon className={cn("h-5 w-5 mx-auto mb-2", stat.color)} />
       {stat.label === 'Accuracy' ? (
         <AccuracyDisplay
           correct={stats.correctTendencies}
           total={stats.totalPredictions}
           size="md"
           className="justify-center"
         />
       ) : (
         <p className={cn("text-2xl font-bold", stat.color)}>{stat.value}</p>
       )}
       <p className="text-xs text-muted-foreground mt-1">{stat.label}</p>
     </div>
   ))}
   ```

**Part B: Update model-competition-breakdown.tsx**

1. Add import:
   `import { AccuracyDisplay } from '@/components/accuracy-display'`

2. The interface already has totalPredictions and correctTendencies (lines 10-11)

3. Update the accuracy cell render (around line 243):

   Find the accuracy column cell that currently shows `{row.accuracy}%` and update:

   BEFORE:
   ```tsx
   <span className={...}>{row.accuracy}%</span>
   ```

   AFTER:
   ```tsx
   <AccuracyDisplay
     correct={row.correctTendencies}
     total={row.totalPredictions}
     size="sm"
   />
   ```

4. Keep the existing accuracy sorting logic (it calculates accuracy from correctTendencies/totalPredictions already).
  </action>
  <verify>
    - AccuracyDisplay imported in both files
    - model-stats-grid.tsx shows accuracy with AccuracyDisplay in stats grid
    - model-competition-breakdown.tsx shows accuracy with AccuracyDisplay in table
    - Build passes: `npm run build 2>&1 | grep -i "error" | head -5 || echo "Build OK"`
  </verify>
  <done>
    - Stats grid shows "X/Y (Z%)" format for accuracy
    - Competition breakdown table shows "X/Y (Z%)" format
    - All accuracy displays now have consistent format and tooltip
    - UX-01, UX-02, UX-03 requirements satisfied
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. Run dev server: `npm run dev`
3. Navigate to /leaderboard:
   - Accuracy column shows "X/Y (Z%)" format
   - Hover on accuracy shows tooltip with methodology explanation
   - Click "Learn how we calculate accuracy" link goes to /methodology
4. Click on any model to go to model detail page:
   - Hero stats accuracy shows "X/Y (Z%)" format
   - Hover shows tooltip
   - Numbers match what was shown on leaderboard
5. Check mobile view (responsive):
   - Leaderboard cards show "X/Y (Z%)" format
   - Tooltip accessible via tap/focus

**UX-03 DATA CORRECTNESS VERIFICATION (MANUAL SPOT-CHECK):**
After integration, verify accuracy numbers match the canonical formula by spot-checking 3 models:
1. Pick any 3 models from the leaderboard
2. For each model, verify: displayed percentage = (correctTendencies / totalPredictions) * 100
3. Cross-reference with model detail page - numbers must match exactly
4. If any discrepancy found, investigate data source (query, API, component prop passing)

Example verification:
- Model A shows "81/160 (50.6%)" on leaderboard
- Calculate: 81 / 160 = 0.50625 -> 50.6% (matches)
- Model A detail page also shows "81/160 (50.6%)" (consistent)
</verification>

<success_criteria>
1. All accuracy displays show "X/Y (Z%)" format (UX-01)
2. All accuracy displays have hover tooltip explaining methodology (UX-02)
3. Leaderboard accuracy matches model page accuracy for same model (UX-03)
4. Accuracy percentage = correctTendencies / totalPredictions * 100 (verified via spot-check)
5. Tooltip links to /methodology page for full explanation
6. Build passes and no visual regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-ux-transparency/08-02-SUMMARY.md`
</output>
