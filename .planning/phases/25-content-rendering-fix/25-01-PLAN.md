---
phase: 25-content-rendering-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/utils/strip-html.ts
  - src/components/match/MatchContent.tsx
  - src/components/match/narrative-preview.tsx
autonomous: true

must_haves:
  truths:
    - "Pre-match narrative displays as clean text without HTML tags"
    - "Betting narrative displays as clean text without HTML tags"
    - "Post-match narrative displays as clean text without HTML tags"
    - "NarrativePreview word truncation works correctly on HTML content"
  artifacts:
    - path: "src/lib/utils/strip-html.ts"
      provides: "HTML stripping utility function"
      exports: ["stripHtml"]
    - path: "src/components/match/MatchContent.tsx"
      provides: "Sanitized narrative rendering"
      contains: "stripHtml"
    - path: "src/components/match/narrative-preview.tsx"
      provides: "Sanitized preview text"
      contains: "stripHtml"
  key_links:
    - from: "src/components/match/MatchContent.tsx"
      to: "src/lib/utils/strip-html.ts"
      via: "import stripHtml"
      pattern: "import.*stripHtml.*from.*strip-html"
    - from: "src/components/match/narrative-preview.tsx"
      to: "src/lib/utils/strip-html.ts"
      via: "import stripHtml"
      pattern: "import.*stripHtml.*from.*strip-html"
---

<objective>
Strip HTML tags from narrative content in MatchContentSection and NarrativePreview components so all text displays as clean prose without visible `<p>`, `<h2>`, etc. tags.

Purpose: Fixes content quality issue (QUAL-01) where LLM-generated narrative content sometimes contains HTML tags that render as raw text instead of being stripped or rendered as HTML.

Output: Clean text rendering in all narrative sections (pre-match, betting, post-match) regardless of whether source content contains HTML tags.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-content-rendering-fix/25-RESEARCH.md

# Source files to modify
@src/components/match/MatchContent.tsx
@src/components/match/narrative-preview.tsx
@src/components/content/entity-linked-text.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install isomorphic-dompurify and create stripHtml utility</name>
  <files>
    package.json
    src/lib/utils/strip-html.ts
  </files>
  <action>
1. Install isomorphic-dompurify:
   ```bash
   npm install isomorphic-dompurify
   ```

2. Create `src/lib/utils/strip-html.ts` with:
   ```typescript
   import DOMPurify from 'isomorphic-dompurify';

   /**
    * Strip all HTML tags from a string, returning plain text.
    * Handles edge cases like malformed HTML, HTML entities, and nested tags.
    * Uses isomorphic-dompurify for SSR compatibility.
    *
    * @param html - String potentially containing HTML tags
    * @returns Plain text with all HTML tags removed
    */
   export function stripHtml(html: string | null | undefined): string {
     if (!html) return '';

     // DOMPurify with no allowed tags = strip all HTML, keep text
     const clean = DOMPurify.sanitize(html, {
       ALLOWED_TAGS: [],
       KEEP_CONTENT: true,
     });

     // Normalize whitespace and trim
     return clean.replace(/\s+/g, ' ').trim();
   }
   ```

Note: Use isomorphic-dompurify (not raw dompurify) because Next.js App Router renders Server Components on the server, and raw DOMPurify requires browser DOM APIs.
  </action>
  <verify>
1. `npm ls isomorphic-dompurify` shows package installed
2. File exists at `src/lib/utils/strip-html.ts`
3. TypeScript compiles: `npx tsc --noEmit src/lib/utils/strip-html.ts`
  </verify>
  <done>
- isomorphic-dompurify is in package.json dependencies
- stripHtml utility function exists and exports correctly
- Function handles null/undefined input gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply HTML stripping to MatchContentSection and NarrativePreview</name>
  <files>
    src/components/match/MatchContent.tsx
    src/components/match/narrative-preview.tsx
  </files>
  <action>
**In MatchContentSection.tsx:**

1. Add import at top:
   ```typescript
   import { stripHtml } from '@/lib/utils/strip-html';
   ```

2. Strip HTML before passing to EntityLinkedText (3 locations - pre-match, betting, post-match):
   - Change `text={content.preMatchContent!}` to `text={stripHtml(content.preMatchContent)}`
   - Change `text={content.bettingContent!}` to `text={stripHtml(content.bettingContent)}`
   - Change `text={content.postMatchContent!}` to `text={stripHtml(content.postMatchContent)}`

3. Strip HTML for non-entity-linked rendering (3 locations):
   - Change `content.preMatchContent` to `stripHtml(content.preMatchContent)`
   - Change `content.bettingContent` to `stripHtml(content.bettingContent)`
   - Change `content.postMatchContent` to `stripHtml(content.postMatchContent)`

4. Strip HTML in NarrativePreview calls (2 locations):
   - Change `previewText={content.preMatchContent!}` to `previewText={stripHtml(content.preMatchContent)}`
   - Change `previewText={content.postMatchContent!}` to `previewText={stripHtml(content.postMatchContent)}`

**In NarrativePreview.tsx:**

1. Add import at top:
   ```typescript
   import { stripHtml } from '@/lib/utils/strip-html';
   ```

2. Strip HTML before word splitting (inside the component):
   ```typescript
   // Truncate to approximate word count for preview (150 words target)
   const cleanText = stripHtml(previewText);  // ADD THIS LINE
   const words = cleanText.split(/\s+/);      // Change from previewText.split
   ```

3. Update preview generation:
   ```typescript
   const preview = isLongContent
     ? words.slice(0, previewWordCount).join(' ') + '...'
     : cleanText;  // Change from previewText
   ```

This ensures:
- EntityLinkedText receives clean text (no HTML interfering with regex matching)
- NarrativePreview word count is accurate (not counting HTML tags as words)
- Direct text rendering shows clean prose
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. Start dev server: `npm run dev`
3. Visit a match page with narrative content (e.g., http://localhost:3000/leagues/epl/[any-match-slug])
4. Verify no raw HTML tags visible in:
   - Match Preview section (if scheduled match)
   - AI Model Predictions section (if live/finished match)
   - Match Report section (if finished match)
  </verify>
  <done>
- All narrative sections display clean text without HTML tags
- EntityLinkedText receives sanitized input
- NarrativePreview truncates based on actual word count, not HTML tags
- Build passes with no TypeScript errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification**: `npm run build` passes without errors
2. **Visual verification**: Visit match pages in different states:
   - Scheduled match: Pre-match preview shows clean text
   - Finished match: Betting + Post-match sections show clean text
3. **Edge case check**: If any narrative content in database contains HTML, it renders as clean prose
4. **Entity linking still works**: Team names and model names still become clickable links
</verification>

<success_criteria>
- [ ] isomorphic-dompurify installed (appears in package.json)
- [ ] stripHtml utility function created and exported
- [ ] MatchContentSection uses stripHtml for all narrative content
- [ ] NarrativePreview uses stripHtml before word splitting
- [ ] Build passes (`npm run build`)
- [ ] No visible HTML tags in any narrative section on match pages
- [ ] Requirements QUAL-01 satisfied (HTML tags stripped/rendered properly)
</success_criteria>

<output>
After completion, create `.planning/phases/25-content-rendering-fix/25-01-SUMMARY.md`
</output>
