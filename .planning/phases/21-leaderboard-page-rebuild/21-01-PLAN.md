---
phase: 21-leaderboard-page-rebuild
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/leaderboard-filters.tsx
  - src/lib/db/queries/stats.ts
  - src/components/leaderboard/trend-indicator.tsx
  - src/components/leaderboard-table.tsx
  - src/lib/table/columns.ts
autonomous: true

must_haves:
  truths:
    - "User can filter leaderboard by weekly, monthly, or all-time periods"
    - "User sees rank change indicators (up/down arrows) for each model"
    - "New models show 'New' badge instead of blank trend"
    - "Filter changes reset pagination to prevent empty page errors"
  artifacts:
    - path: "src/components/leaderboard-filters.tsx"
      provides: "Time period filter (weekly/monthly/all)"
      contains: "timePeriod"
    - path: "src/lib/db/queries/stats.ts"
      provides: "getLeaderboardWithTrends() with rank change calculation"
      exports: ["getLeaderboardWithTrends"]
    - path: "src/components/leaderboard/trend-indicator.tsx"
      provides: "Visual trend indicator component"
      exports: ["TrendIndicator"]
    - path: "src/components/leaderboard-table.tsx"
      provides: "Table with trend column"
      contains: "TrendIndicator"
  key_links:
    - from: "src/components/leaderboard-filters.tsx"
      to: "URL search params"
      via: "timePeriod query param"
      pattern: "timePeriod"
    - from: "src/app/leaderboard/page.tsx"
      to: "src/lib/db/queries/stats.ts"
      via: "getLeaderboardWithTrends call"
      pattern: "getLeaderboardWithTrends"
    - from: "src/components/leaderboard-table.tsx"
      to: "src/components/leaderboard/trend-indicator.tsx"
      via: "import and render"
      pattern: "TrendIndicator"
---

<objective>
Add time period filtering (weekly/monthly/all-time) to leaderboard and display rank change trend indicators for each model.

Purpose: Enable users to view recent performance (weekly/monthly) vs long-term consistency (all-time), and quickly identify rising/falling models via visual trend arrows.

Output: Enhanced leaderboard with time period filter dropdown and trend column showing rank changes with up/down arrows and "New" badges.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-leaderboard-page-rebuild/21-RESEARCH.md

# Existing patterns to follow
@src/components/leaderboard-filters.tsx
@src/components/leaderboard-table.tsx
@src/lib/db/queries/stats.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add time period filter and trend query</name>
  <files>
    src/components/leaderboard-filters.tsx
    src/lib/db/queries/stats.ts
  </files>
  <action>
1. **Update LeaderboardFilters** (`src/components/leaderboard-filters.tsx`):
   - Replace TIME_RANGE_OPTIONS with TIME_PERIOD_OPTIONS:
     ```typescript
     const TIME_PERIOD_OPTIONS = [
       { value: 'all', label: 'All Time' },
       { value: 'monthly', label: 'This Month' },
       { value: 'weekly', label: 'This Week' },
     ];
     ```
   - Rename state from `currentTimeRange` to `currentTimePeriod`
   - Update the filter dropdown to use `timePeriod` param instead of `timeRange`
   - In updateParams callback, reset pagination when timePeriod changes:
     ```typescript
     // Reset page when changing time filters to avoid empty results
     if (key === 'timePeriod') {
       params.delete('page');
     }
     ```

2. **Add getLeaderboardWithTrends to stats.ts** (`src/lib/db/queries/stats.ts`):
   - Create new interface:
     ```typescript
     export interface LeaderboardEntryWithTrend extends LeaderboardEntry {
       trendDirection: 'rising' | 'falling' | 'stable' | 'new';
       rankChange: number;
       previousRank: number | null;
     }
     ```
   - Add `timePeriod` to LeaderboardFilters interface: `timePeriod?: 'all' | 'weekly' | 'monthly'`
   - Create `getLeaderboardWithTrends()` function that:
     - Calculates current period rankings using DATE_TRUNC for weekly/monthly
     - Uses a subquery or CTE to get previous period rankings
     - Computes rank change using SQL (previous_rank - current_rank)
     - Handles NULL previous rank as 'new' trend direction
     - Uses ISO week standard (Monday start) via DATE_TRUNC('week', scored_at)
   - SQL pattern for time filtering:
     ```sql
     -- Current period (e.g., this week)
     WHERE DATE_TRUNC('week', scored_at) = DATE_TRUNC('week', CURRENT_DATE)

     -- Previous period (e.g., last week)
     WHERE DATE_TRUNC('week', scored_at) = DATE_TRUNC('week', CURRENT_DATE - INTERVAL '7 days')
     ```
   - For 'all' time period, compare current month vs previous month for trend calculation
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Filter dropdown shows "All Time", "This Month", "This Week" options
  </verify>
  <done>
    LeaderboardFilters has timePeriod dropdown replacing timeRange
    getLeaderboardWithTrends() exported from stats.ts with rank change calculation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TrendIndicator component and add to table</name>
  <files>
    src/components/leaderboard/trend-indicator.tsx
    src/components/leaderboard-table.tsx
    src/lib/table/columns.ts
  </files>
  <action>
1. **Create TrendIndicator component** (`src/components/leaderboard/trend-indicator.tsx`):
   ```typescript
   import { ArrowUp, ArrowDown, Minus } from 'lucide-react';
   import { cn } from '@/lib/utils';

   export interface TrendIndicatorProps {
     direction: 'rising' | 'falling' | 'stable' | 'new';
     rankChange: number;
   }

   /**
    * Trend indicator showing rank change with semantic colors
    * Uses arrow direction as primary indicator (accessibility)
    * Color provides enhancement (--win green, --loss red)
    */
   export function TrendIndicator({ direction, rankChange }: TrendIndicatorProps) {
     if (direction === 'new') {
       return (
         <span className="text-xs font-medium px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">
           New
         </span>
       );
     }

     if (direction === 'stable') {
       return (
         <div className="flex items-center gap-1 text-muted-foreground">
           <Minus className="h-3 w-3" />
         </div>
       );
     }

     const isRising = direction === 'rising';
     const Icon = isRising ? ArrowUp : ArrowDown;
     // Use semantic colors from globals.css (--win, --loss)
     const colorClass = isRising ? 'text-win' : 'text-loss';

     return (
       <div className={cn("flex items-center gap-1", colorClass)}>
         <Icon className="h-4 w-4" />
         <span className="text-xs font-medium">
           {Math.abs(rankChange)}
         </span>
       </div>
     );
   }
   ```

2. **Update LeaderboardEntry interface** (`src/lib/table/columns.ts` or inline in leaderboard-table.tsx):
   - Add trend fields to the interface used by LeaderboardTable:
     ```typescript
     trendDirection?: 'rising' | 'falling' | 'stable' | 'new';
     rankChange?: number;
     ```

3. **Add trend column to LeaderboardTable** (`src/components/leaderboard-table.tsx`):
   - Import TrendIndicator: `import { TrendIndicator } from '@/components/leaderboard/trend-indicator';`
   - Add new column after 'accuracy' and before 'streak':
     ```typescript
     // Trend column (after accuracy, before streak)
     {
       id: 'trend',
       header: 'Trend',
       cell: ({ row }) => {
         const direction = row.original.trendDirection || 'stable';
         const change = row.original.rankChange || 0;
         return <TrendIndicator direction={direction} rankChange={change} />;
       },
       size: 80,
       meta: { align: 'center' as const },
       enableSorting: false, // Trend is derived, not sortable
     },
     ```
   - Update MobileCard component to show trend next to rank icon in header row:
     ```typescript
     {/* In MobileCard header after streak indicator */}
     {entry.trendDirection && (
       <TrendIndicator
         direction={entry.trendDirection}
         rankChange={entry.rankChange || 0}
       />
     )}
     ```
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    TrendIndicator component renders with correct colors (green up, red down, blue new)
  </verify>
  <done>
    TrendIndicator component created with rising/falling/stable/new states
    LeaderboardTable has new Trend column with TrendIndicator
    Mobile card view shows trend indicator in header
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire time period filter to page and use trends query</name>
  <files>
    src/app/leaderboard/page.tsx
  </files>
  <action>
1. **Update leaderboard page** (`src/app/leaderboard/page.tsx`):
   - Import `getLeaderboardWithTrends` instead of `getLeaderboard`
   - Parse `timePeriod` from searchParams:
     ```typescript
     const timePeriod = typeof searchParams.timePeriod === 'string'
       ? searchParams.timePeriod as 'all' | 'weekly' | 'monthly'
       : 'all';
     ```
   - Update query call to use trends function:
     ```typescript
     const leaderboard = await getLeaderboardWithTrends(50, 'avgPoints', {
       competitionId,
       season,
       timePeriod,
     });
     ```
   - Update formattedLeaderboard mapping to include trend data:
     ```typescript
     const formattedLeaderboard = leaderboard.map((entry) => ({
       // ...existing fields...
       trendDirection: entry.trendDirection,
       rankChange: entry.rankChange,
     })).filter((entry) => entry.totalPredictions >= minPredictions);
     ```
   - Ensure TypeScript is happy with the new fields

2. **Test the integration**:
   - Load `/leaderboard` - should show all-time rankings with trends
   - Select "This Week" - should filter to weekly data with weekly rank changes
   - Select "This Month" - should filter to monthly data with monthly rank changes
   - New models (no previous period data) should show "New" badge
  </action>
  <verify>
    Visit /leaderboard - table shows Trend column
    Change time period filter - data updates with appropriate trends
    curl -s "http://localhost:3000/leaderboard?timePeriod=weekly" | grep -o "Trend" (verify column exists)
  </verify>
  <done>
    Leaderboard page uses getLeaderboardWithTrends
    Time period filter controls data and trend calculation
    Trend column displays correctly for all time periods
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds: `npx tsc --noEmit`
2. Leaderboard page loads without errors
3. Time period dropdown shows All Time / This Month / This Week
4. Switching time periods updates rankings and trends
5. Rising models show green up arrow with rank change number
6. Falling models show red down arrow with rank change number
7. Stable models show gray minus
8. New models show blue "New" badge
9. Mobile view shows trend indicator in card header
</verification>

<success_criteria>
- User can filter leaderboard by weekly, monthly, or all-time views
- User sees visual trend indicators (up/down arrows) for rising/falling models
- New models without previous period data show "New" badge
- Filter changes reset pagination to avoid empty page errors
- Trend calculation uses SQL window functions (not client-side)
- Colors follow design system (--win green, --loss red)
</success_criteria>

<output>
After completion, create `.planning/phases/21-leaderboard-page-rebuild/21-01-SUMMARY.md`
</output>
