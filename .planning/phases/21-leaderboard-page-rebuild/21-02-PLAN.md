---
phase: 21-leaderboard-page-rebuild
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/lib/leaderboard/generate-leaderboard-faqs.ts
  - src/app/leaderboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User finds FAQ section at bottom of leaderboard page"
    - "FAQ content includes dynamic stats (total models, top model, prediction count)"
    - "Search engines receive FAQPage schema in JSON-LD"
    - "FAQ answers explain trend indicators and time period filtering"
  artifacts:
    - path: "src/lib/leaderboard/generate-leaderboard-faqs.ts"
      provides: "Dynamic FAQ generator with live stats"
      exports: ["generateLeaderboardFAQs"]
    - path: "src/app/leaderboard/page.tsx"
      provides: "Page with dynamic FAQs and schema integration"
      contains: "generateLeaderboardFAQs"
  key_links:
    - from: "src/app/leaderboard/page.tsx"
      to: "src/lib/leaderboard/generate-leaderboard-faqs.ts"
      via: "import and call"
      pattern: "generateLeaderboardFAQs"
    - from: "src/app/leaderboard/page.tsx"
      to: "JSON-LD script tag"
      via: "FAQPage schema in @graph"
      pattern: "FAQPage"
---

<objective>
Add dynamic FAQ section with live leaderboard statistics and integrate FAQPage schema for SEO optimization.

Purpose: Improve search engine visibility with FAQ rich snippets and provide users with answers to common leaderboard questions (ranking methodology, trend indicators, time filtering).

Output: Leaderboard page with dynamic FAQ section using live data and proper FAQPage schema in JSON-LD @graph.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-leaderboard-page-rebuild/21-RESEARCH.md

# Prior plan SUMMARY needed for trends implementation
@.planning/phases/21-leaderboard-page-rebuild/21-01-SUMMARY.md

# Existing FAQ patterns to follow
@src/lib/league/generate-league-faqs.ts
@src/lib/seo/schemas.ts
@src/components/FaqSchema.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic leaderboard FAQ generator</name>
  <files>
    src/lib/leaderboard/generate-leaderboard-faqs.ts
  </files>
  <action>
1. **Create FAQ generator** (`src/lib/leaderboard/generate-leaderboard-faqs.ts`):
   - Create directory if needed: `src/lib/leaderboard/`
   - Follow the pattern from `src/lib/league/generate-league-faqs.ts`

   ```typescript
   /**
    * Leaderboard FAQ Generator
    *
    * Generates dynamic FAQ content based on current leaderboard data.
    * Optimized for GEO (Generative Engine Optimization) with:
    * - TL;DR question first (AI search citation priority)
    * - 5 FAQ max (reasonable schema size)
    * - 300 char answer truncation (schema best practice)
    */

   import type { FAQItem } from '@/lib/seo/schemas';

   export interface LeaderboardFAQData {
     totalModels: number;
     totalPredictions: number;
     topModel: {
       name: string;
       avgPoints: number;
       accuracy: number;
     } | null;
     timePeriod: 'all' | 'weekly' | 'monthly';
   }

   /**
    * Truncate text to max length at last complete sentence
    */
   function truncateToSentence(text: string, maxLength: number): string {
     if (text.length <= maxLength) return text;

     const truncated = text.slice(0, maxLength);
     const lastPeriod = truncated.lastIndexOf('.');
     const lastQuestion = truncated.lastIndexOf('?');
     const lastExclamation = truncated.lastIndexOf('!');
     const lastSentenceEnd = Math.max(lastPeriod, lastQuestion, lastExclamation);

     if (lastSentenceEnd > maxLength / 2) {
       return text.slice(0, lastSentenceEnd + 1);
     }

     const lastSpace = truncated.lastIndexOf(' ');
     if (lastSpace > maxLength / 2) {
       return text.slice(0, lastSpace) + '...';
     }

     return truncated + '...';
   }

   /**
    * Generate FAQ items for leaderboard page
    */
   export function generateLeaderboardFAQs(data: LeaderboardFAQData): FAQItem[] {
     const { totalModels, totalPredictions, topModel, timePeriod } = data;

     const periodLabel = timePeriod === 'weekly' ? 'this week'
       : timePeriod === 'monthly' ? 'this month'
       : 'all time';

     // Q1: TL;DR - What determines ranking (always first for AI citation)
     const tldrAnswer = `Models are ranked by average points per prediction using the Kicktipp scoring system. Points are awarded for correct tendency (2-6 based on rarity), goal difference bonus (+1), and exact score bonus (+3). Maximum 10 points per match. The leaderboard tracks ${totalModels} AI models across ${totalPredictions.toLocaleString()} predictions.`;

     // Q2: Best performing model (dynamic)
     let bestModelAnswer = `Performance varies by time period and competition.`;
     if (topModel) {
       bestModelAnswer = `${topModel.name} leads the leaderboard ${periodLabel} with ${topModel.avgPoints.toFixed(2)} average points per match and ${topModel.accuracy.toFixed(1)}% tendency accuracy. Use weekly/monthly filters to compare recent performance versus long-term consistency.`;
     }

     // Q3: Trend indicators explanation (new feature)
     const trendAnswer = `Trend indicators show rank changes compared to the previous ${timePeriod === 'weekly' ? 'week' : timePeriod === 'monthly' ? 'month' : 'period'}. Green up arrows indicate rising rank, red down arrows indicate falling rank. Gray minus means stable position. "New" badges mark models that recently started making predictions.`;

     // Q4: Time filtering explanation
     const filterAnswer = `Use time period filters to view all-time rankings for consistency, monthly rankings for medium-term trends, or weekly rankings for recent hot streaks. Competition filters narrow results to specific leagues like Premier League or Champions League.`;

     // Q5: Update frequency
     const updateAnswer = `The leaderboard updates automatically after each match is scored, typically within minutes of the final whistle. Rankings reflect the most recent results. Weekly views reset each Monday (ISO week standard), monthly views reset on the 1st.`;

     const faqs: FAQItem[] = [
       {
         question: 'What determines AI model ranking on this leaderboard?',
         answer: truncateToSentence(tldrAnswer, 300),
       },
       {
         question: 'Which AI model is currently performing best?',
         answer: truncateToSentence(bestModelAnswer, 300),
       },
       {
         question: 'What do the trend indicators (arrows) mean?',
         answer: truncateToSentence(trendAnswer, 300),
       },
       {
         question: 'Can I filter the leaderboard by time period?',
         answer: truncateToSentence(filterAnswer, 300),
       },
       {
         question: 'How often is the leaderboard updated?',
         answer: truncateToSentence(updateAnswer, 300),
       },
     ];

     return faqs;
   }
   ```
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    File exists: `ls src/lib/leaderboard/generate-leaderboard-faqs.ts`
  </verify>
  <done>
    generateLeaderboardFAQs() function created with dynamic stats and trend explanation
    Follows existing FAQ generator patterns (truncation, 5 max, TL;DR first)
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate dynamic FAQs and schema into page</name>
  <files>
    src/app/leaderboard/page.tsx
  </files>
  <action>
1. **Update leaderboard page** (`src/app/leaderboard/page.tsx`):

   a. **Import the FAQ generator**:
      ```typescript
      import { generateLeaderboardFAQs } from '@/lib/leaderboard/generate-leaderboard-faqs';
      import { generateFAQPageSchema } from '@/lib/seo/schemas';
      ```

   b. **Remove static leaderboardFaqs array** (lines ~18-39 in current file)

   c. **Generate dynamic FAQs in LeaderboardContent component** (after fetching leaderboard data):
      ```typescript
      // Calculate stats for FAQ generation
      const totalModels = leaderboard.length;
      const totalPredictions = leaderboard.reduce((sum, e) => sum + e.totalPredictions, 0);
      const topModel = leaderboard[0] ? {
        name: leaderboard[0].displayName,
        avgPoints: leaderboard[0].avgPoints,
        accuracy: leaderboard[0].accuracy,
      } : null;

      // Generate dynamic FAQs
      const faqs = generateLeaderboardFAQs({
        totalModels,
        totalPredictions,
        topModel,
        timePeriod: timePeriod || 'all',
      });
      ```

   d. **Update schema to include FAQPage in @graph**:
      Move schema generation into the component that has access to FAQ data.
      ```typescript
      // Build combined schema with BreadcrumbList and FAQPage
      const faqSchema = generateFAQPageSchema(faqs);
      const schema = {
        '@context': 'https://schema.org',
        '@graph': [breadcrumbs, faqSchema],
      };
      ```

   e. **Update FAQ section rendering** to use dynamic faqs:
      - Replace static `leaderboardFaqs.map(...)` with `faqs.map(...)`
      - Use native `<details>/<summary>` for accordion (following Phase 19/20 pattern):
      ```typescript
      <Card className="bg-card/50 border-border/50">
        <CardContent className="p-6">
          <h2 className="text-xl font-bold mb-6">Understanding Model Rankings</h2>
          <div className="space-y-2">
            {faqs.map((faq, idx) => (
              <details key={idx} className="group border-b border-border/30 pb-3 last:border-0">
                <summary className="cursor-pointer font-semibold text-sm py-2 list-none flex items-center justify-between">
                  {faq.question}
                  <span className="text-muted-foreground group-open:rotate-180 transition-transform">
                    <ChevronDown className="h-4 w-4" />
                  </span>
                </summary>
                <p className="text-sm text-muted-foreground leading-relaxed pt-2 pb-1">
                  {faq.answer}
                </p>
              </details>
            ))}
          </div>
        </CardContent>
      </Card>
      ```

   f. **Remove the separate FaqSchema component** since schema is now in @graph:
      ```typescript
      // Remove: <FaqSchema faqs={leaderboardFaqs} />
      ```

   g. **Add ChevronDown import** if not already present:
      ```typescript
      import { Trophy, ChevronDown } from 'lucide-react';
      ```

2. **Handle passing FAQs up from LeaderboardContent**:
   Since LeaderboardContent is async and schema needs to be in the page wrapper:
   - Option A: Move schema generation into LeaderboardContent and render there
   - Option B: Fetch leaderboard data at page level, pass to component

   Recommended: Option A - render schema inside LeaderboardContent:
   ```typescript
   async function LeaderboardContent({ searchParams }: { ... }) {
     // ... existing code to get leaderboard ...

     // Generate FAQs and schema
     const faqs = generateLeaderboardFAQs({ ... });
     const faqSchema = generateFAQPageSchema(faqs);

     return (
       <>
         {/* Schema JSON-LD (inside Suspense boundary is fine) */}
         <script
           type="application/ld+json"
           dangerouslySetInnerHTML={{
             __html: JSON.stringify({
               '@context': 'https://schema.org',
               '@type': 'FAQPage',
               ...faqSchema,
             }),
           }}
         />

         {/* ... existing Card with LeaderboardTable ... */}

         {/* FAQ Section */}
         <Card className="bg-card/50 border-border/50 mt-8">
           {/* ... FAQ content ... */}
         </Card>
       </>
     );
   }
   ```

   Keep BreadcrumbList schema in the page wrapper (outside Suspense).
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Visit /leaderboard - FAQ section renders with dynamic content
    View page source - FAQPage schema present in JSON-LD
    FAQ answers include current top model name and stats
  </verify>
  <done>
    Static FAQ array removed, replaced with dynamic generation
    FAQ section uses details/summary accordion
    FAQPage schema included in page JSON-LD
    FAQ answers reflect current leaderboard data (top model, total predictions)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds: `npx tsc --noEmit`
2. Leaderboard page loads without errors
3. FAQ section visible at bottom of page
4. FAQ uses accordion (details/summary) for expand/collapse
5. FAQ content includes dynamic data:
   - "tracks X AI models" matches actual model count
   - Top model name matches #1 position
   - Average points matches #1 model's stats
6. View page source shows FAQPage schema in JSON-LD
7. Google Rich Results Test validates FAQPage schema
8. FAQ answers explain trend indicators and time filtering
</verification>

<success_criteria>
- User finds FAQ section answering common leaderboard questions
- FAQ content is dynamically generated with live stats
- FAQPage schema present for search engine rich snippets
- FAQ explains trend indicators (new feature from Plan 01)
- FAQ explains time period filtering options
- Schema validates without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-leaderboard-page-rebuild/21-02-SUMMARY.md`
</output>
