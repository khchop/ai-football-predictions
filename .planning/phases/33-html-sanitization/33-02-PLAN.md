---
phase: 33-html-sanitization
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/lib/content/match-content.ts
  - src/lib/content/generator.ts
autonomous: true

must_haves:
  truths:
    - "Content is sanitized before database save"
    - "Invalid content with HTML tags throws error"
  artifacts:
    - path: "src/lib/content/match-content.ts"
      provides: "Sanitized content generation"
      contains: "sanitizeContent"
    - path: "src/lib/content/generator.ts"
      provides: "Sanitized preview/roundup generation"
      contains: "sanitizeContent"
  key_links:
    - from: "src/lib/content/match-content.ts"
      to: "src/lib/content/sanitization.ts"
      via: "import"
      pattern: "import.*sanitizeContent.*from.*sanitization"
    - from: "src/lib/content/generator.ts"
      to: "src/lib/content/sanitization.ts"
      via: "import"
      pattern: "import.*sanitizeContent.*from.*sanitization"
---

<objective>
Integrate sanitization into all content generation functions before database save.

Purpose: Ensure HTML artifacts never reach the database by applying sanitization as the last step before insert/update operations.

Output: All content generation functions in match-content.ts and generator.ts sanitize content before database save.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-html-sanitization/33-01-SUMMARY.md
@src/lib/content/sanitization.ts
@src/lib/content/match-content.ts
@src/lib/content/generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate sanitization into match-content.ts</name>
  <files>src/lib/content/match-content.ts</files>
  <action>
1. Add import at top of file:
   ```typescript
   import { sanitizeContent, validateNoHtml } from './sanitization';
   ```

2. Update generatePreMatchContent:
   - After `const content = result.content;`
   - Add: `const cleanContent = sanitizeContent(content);`
   - Update validateGeneratedContent call to use cleanContent
   - Add: `validateNoHtml(cleanContent);`
   - Update database insert to use cleanContent

3. Update generateBettingContent:
   - Same pattern: sanitize after result.content, validate, save cleanContent

4. Update generatePostMatchContent:
   - Same pattern: sanitize after result.content, validate, save cleanContent

5. Update generateFAQContent:
   - FAQs are JSON array, sanitize each question and answer field:
   ```typescript
   const sanitizedFaqs = result.content.map((faq: FAQItem) => ({
     question: sanitizeContent(faq.question),
     answer: sanitizeContent(faq.answer),
   }));
   ```
   - Validate each field after sanitization
   - Save sanitizedFaqs to database

IMPORTANT: Apply sanitization AFTER getting content from LLM, BEFORE validation and database save. Order is:
1. LLM response
2. sanitizeContent()
3. validateGeneratedContent()
4. validateNoHtml()
5. database insert
  </action>
  <verify>
    grep "sanitizeContent" src/lib/content/match-content.ts shows 5+ occurrences
    grep "validateNoHtml" src/lib/content/match-content.ts shows 4 occurrences (one per function)
    npm run build passes
  </verify>
  <done>
    All 4 content generation functions sanitize content before save
    Each function validates no HTML remains before database insert
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate sanitization into generator.ts</name>
  <files>src/lib/content/generator.ts</files>
  <action>
1. Add import at top of file:
   ```typescript
   import { sanitizeContent, validateNoHtml } from './sanitization';
   ```

2. Update generateMatchPreview:
   - Sanitize each text field from result.content before saving:
   ```typescript
   const newPreview: NewMatchPreview = {
     // ...
     introduction: sanitizeContent(result.content.introduction),
     teamFormAnalysis: sanitizeContent(result.content.teamFormAnalysis),
     headToHead: sanitizeContent(result.content.headToHead),
     keyPlayers: sanitizeContent(result.content.keyPlayers),
     tacticalAnalysis: sanitizeContent(result.content.tacticalAnalysis),
     prediction: sanitizeContent(result.content.prediction),
     bettingInsights: sanitizeContent(result.content.bettingInsights),
     metaDescription: sanitizeContent(result.content.metaDescription),
     keywords: result.content.keywords.join(', '), // Keywords are array, join only
     // ...
   };
   ```

3. Update generateLeagueRoundup:
   - Sanitize title, excerpt, content, metaTitle, metaDescription before save
   - Note: content is markdown-formatted, but should not have HTML tags

4. Update generateModelReport:
   - Same pattern: sanitize all text fields before save

5. Update generatePostMatchRoundup:
   - This is the most complex with embedded HTML:
   - Sanitize title
   - Sanitize finalNarrative before constructing roundupHtml
   - For the roundupHtml template at line 904-950:
     - This template CREATES HTML structure for display
     - The issue is LLM-generated content INSIDE the template
     - Sanitize finalNarrative (already done above)
     - Sanitize modelPredictions field from result.content
     - Sanitize topPerformers entries
   - The structural HTML (h1, div, ul) is intentional for rendering - keep it
   - The content INSIDE those tags must be plain text - sanitize it

6. For fields that should allow markdown but not HTML:
   - Markdown characters (*, #, -, []) are NOT HTML
   - sanitizeContent preserves these naturally
   - Only actual HTML tags and entities are removed
  </action>
  <verify>
    grep "sanitizeContent" src/lib/content/generator.ts shows 15+ occurrences
    grep "import.*sanitization" src/lib/content/generator.ts shows import line
    npm run build passes
  </verify>
  <done>
    generateMatchPreview sanitizes all 8 text fields
    generateLeagueRoundup sanitizes 5 text fields
    generateModelReport sanitizes 5 text fields
    generatePostMatchRoundup sanitizes content fields before template insertion
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. grep for sanitizeContent shows usage in both files
3. No content reaches database without sanitization
</verification>

<success_criteria>
- All content generation functions import and use sanitizeContent
- Sanitization applied before database save in all cases
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/33-html-sanitization/33-02-SUMMARY.md`
</output>
