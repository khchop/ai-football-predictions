---
phase: 33-html-sanitization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/content/sanitization.ts
  - src/lib/content/match-content.ts
  - src/lib/content/prompts.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "LLM prompts explicitly request plain text output"
    - "sanitizeContent function converts HTML to plain text"
    - "validateNoHtml function throws on HTML detection"
  artifacts:
    - path: "src/lib/content/sanitization.ts"
      provides: "HTML sanitization utilities"
      exports: ["sanitizeContent", "validateNoHtml"]
    - path: "package.json"
      contains: "html-to-text"
  key_links:
    - from: "src/lib/content/sanitization.ts"
      to: "html-to-text"
      via: "import { convert }"
      pattern: "import.*convert.*from.*html-to-text"
    - from: "src/lib/content/sanitization.ts"
      to: "he"
      via: "import { decode }"
      pattern: "import.*decode.*from.*he"
---

<objective>
Create HTML sanitization utilities and update LLM prompts to request plain text output.

Purpose: Establish the foundation for HTML-free content generation with a reusable sanitization module and explicit plain text instructions in all prompts.

Output: New sanitization.ts module with sanitizeContent() and validateNoHtml() functions, plus updated prompts in match-content.ts and prompts.ts.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-html-sanitization/33-CONTEXT.md
@.planning/phases/33-html-sanitization/33-RESEARCH.md
@src/lib/content/match-content.ts
@src/lib/content/prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create sanitization module</name>
  <files>
    package.json
    src/lib/content/sanitization.ts
  </files>
  <action>
1. Install required packages:
   ```
   npm install html-to-text he
   npm install --save-dev @types/html-to-text
   ```

2. Create `src/lib/content/sanitization.ts` with two exports:

   **sanitizeContent(content: string): string**
   - Handle empty/null input (return empty string)
   - Use html-to-text convert() with options:
     - wordwrap: false (preserve original line breaks)
     - preserveNewlines: true
     - selectors for p (block with 2 leading/trailing line breaks), br (lineBreak), div (block with 1 line break), strong/em/b/i (inline), * (skip)
   - Use he decode() to convert HTML entities to characters
   - Normalize whitespace: max 2 consecutive newlines, collapse multiple spaces, trim

   **validateNoHtml(content: string): void**
   - Check for HTML tags with regex: /<[a-z][\s\S]*?>/i
   - Check for common entities: /&(?:amp|lt|gt|quot|nbsp);/
   - Throw descriptive Error if either pattern matches
  </action>
  <verify>
    npm run build passes (TypeScript compilation)
    Import from '@/lib/content/sanitization' resolves
  </verify>
  <done>
    sanitization.ts exists with sanitizeContent and validateNoHtml exports
    html-to-text and he in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Update prompts to request plain text output</name>
  <files>
    src/lib/content/match-content.ts
    src/lib/content/prompts.ts
  </files>
  <action>
**In src/lib/content/match-content.ts:**

Update the 4 content generation prompts (generatePreMatchContent, generateBettingContent, generatePostMatchContent, generateFAQContent) to add plain text instructions.

For each prompt, add after "Write flowing prose without headers.":
```
OUTPUT FORMAT:
- Plain text only, no HTML tags
- No HTML entities (use actual characters: &, ", etc.)
- Use natural line breaks for paragraphs
```

For generateFAQContent JSON prompt, update systemPrompt to include:
```
CRITICAL: All text in question/answer fields must be plain text with no HTML tags or entities.
```

**In src/lib/content/prompts.ts:**

Update buildMatchPreviewPrompt:
- Add to Writing Guidelines section:
  ```
  - Output plain text only, no HTML tags or entities
  ```

Update buildLeagueRoundupPrompt:
- Add to OUTPUT REQUIREMENTS:
  ```
  - All text fields must be plain text (no HTML tags or entities)
  ```

Update buildModelReportPrompt:
- Add to Writing Guidelines:
  ```
  - Plain text only, no HTML tags or entities in any field
  ```

Update buildPostMatchRoundupPrompt:
- IMPORTANT: This prompt currently requests HTML output (see WRITING GUIDELINES line 594).
- Change "HTML format with <h2>, <p>, <ul>, <table> tags" to "Plain text format with natural line breaks"
- Update OUTPUT FORMAT section to request plain text in narrative field
- Remove HTML table reference from modelPredictions field description
  </action>
  <verify>
    grep -r "Plain text only" src/lib/content/ shows matches in all 4 files
    grep -r "HTML format" src/lib/content/ returns no matches
    npm run build passes
  </verify>
  <done>
    All content prompts include explicit plain text instructions
    No prompts request HTML output
    buildPostMatchRoundupPrompt requests plain text instead of HTML
  </done>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. sanitization.ts exports sanitizeContent and validateNoHtml
3. All prompt files contain "Plain text only" instruction
4. No prompt files contain "HTML format" instruction
</verification>

<success_criteria>
- html-to-text and he packages installed
- src/lib/content/sanitization.ts exists with both functions
- All content prompts updated with plain text instructions
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/33-html-sanitization/33-01-SUMMARY.md`
</output>
