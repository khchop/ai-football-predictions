---
phase: 32-make-failures-visible
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/errors/content-errors.ts
  - src/lib/content/match-content.ts
autonomous: true

must_haves:
  truths:
    - "Content generation functions throw errors on failure instead of returning false"
    - "Errors include diagnostic context (matchId, teams, content type)"
    - "Fatal errors (match not found) use UnrecoverableError"
    - "Retryable errors (API failures) use regular Error"
  artifacts:
    - path: "src/lib/errors/content-errors.ts"
      provides: "Custom error classes for content generation"
      exports: ["RetryableContentError", "FatalContentError"]
    - path: "src/lib/content/match-content.ts"
      provides: "Content generation with proper error throwing"
      contains: "throw new"
  key_links:
    - from: "src/lib/content/match-content.ts"
      to: "src/lib/errors/content-errors.ts"
      via: "import RetryableContentError, FatalContentError"
      pattern: "import.*from.*errors/content-errors"
---

<objective>
Convert silent failures (return false) in content generation to proper thrown errors that BullMQ can retry and track.

Purpose: Enable BullMQ retry mechanism and dead letter queue visibility for content generation failures. Currently, functions return false on failure which bypasses retry logic entirely.
Output: Error-throwing content generation functions with diagnostic context
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-make-failures-visible/32-CONTEXT.md
@.planning/phases/32-make-failures-visible/32-RESEARCH.md
@src/lib/content/match-content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content error classes</name>
  <files>src/lib/errors/content-errors.ts</files>
  <action>
Create a new directory `src/lib/errors/` and file `content-errors.ts` with two error classes:

1. **RetryableContentError** (extends Error):
   - For transient failures that should trigger BullMQ retry
   - Constructor accepts message and context object with: matchId, homeTeam, awayTeam, contentType, timestamp, originalError
   - Name property set to 'RetryableContentError'

2. **FatalContentError** (extends UnrecoverableError from 'bullmq'):
   - For permanent failures that should NOT retry (match not found, invalid data)
   - Constructor accepts message and context object with: matchId, reason, timestamp
   - Name property set to 'FatalContentError'

Also export a helper function `classifyError(error: unknown): 'retryable' | 'fatal'` that classifies errors:
- Return 'fatal' for: match not found, authentication failures
- Return 'retryable' for: network errors (ECONNRESET, ETIMEDOUT), rate limits (429), other API errors

Reference pattern from RESEARCH.md Custom Error Classes section.
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors
Verify file exists: `ls src/lib/errors/content-errors.ts`
  </verify>
  <done>
- RetryableContentError class exported with context property
- FatalContentError class exported extending UnrecoverableError
- classifyError helper exported
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert match-content.ts to throw errors</name>
  <files>src/lib/content/match-content.ts</files>
  <action>
Refactor all four content generation functions to throw errors instead of returning false:

1. **Change function signatures** from `Promise<boolean>` to `Promise<void>`

2. **For generatePreMatchContent:**
   - Line 53 (match not found): Replace `return false` with `throw new FatalContentError(...)`
   - Lines 151-152 (catch block): Replace `return false` with `throw new RetryableContentError(...)` including full context
   - Remove `return true` at end (void function)

3. **For generateBettingContent:**
   - Line 179 (match not found): Replace with `throw new FatalContentError(...)`
   - Lines 315-316 (catch block): Replace with `throw new RetryableContentError(...)`
   - Remove `return true` at end

4. **For generatePostMatchContent:**
   - Line 343 (match not found): Replace with `throw new FatalContentError(...)`
   - Line 353 (match not finished): This is a legitimate skip case - throw FatalContentError with reason 'match_not_finished' (no point retrying)
   - Lines 484-485 (catch block): Replace with `throw new RetryableContentError(...)`
   - Remove `return true` at end

5. **For generateFAQContent:**
   - Line 515 (match not found): Replace with `throw new FatalContentError(...)`
   - Line 648 (invalid format): This should retry - throw regular Error (LLM may produce valid format on retry)
   - Lines 709-710 (catch block): Replace with `throw new RetryableContentError(...)`
   - Remove `return true` at end

6. **Add imports** at top of file:
   ```typescript
   import { RetryableContentError, FatalContentError } from '@/lib/errors/content-errors';
   ```

7. **Update JSDoc comments** to reflect that functions now throw on failure instead of returning false.

Error context must include: matchId, homeTeam (from match object), awayTeam (from match object), contentType ('pre-match' | 'betting' | 'post-match' | 'faq'), timestamp, originalError (in catch blocks).
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors
Run `grep -c "return false" src/lib/content/match-content.ts` - should return 0
Run `grep -c "throw new" src/lib/content/match-content.ts` - should return at least 8 (2 per function)
  </verify>
  <done>
- All 4 functions return Promise<void> instead of Promise<boolean>
- No `return false` statements remain in the file
- FatalContentError thrown for match not found cases
- RetryableContentError thrown in catch blocks with full diagnostic context
- JSDoc updated to reflect error-throwing behavior
  </done>
</task>

<task type="auto">
  <name>Task 3: Update content.worker.ts to handle new signatures</name>
  <files>src/lib/queue/workers/content.worker.ts</files>
  <action>
Update scanMatchesMissingContent function to handle void-returning functions:

1. **Remove boolean checks** in scanMatchesMissingContent (lines 255-267, 277-289, 299-311):
   - Change from `const success = await generatePreMatchContent(...)` / `if (success)`
   - To `await generatePreMatchContent(...)` and count success, catch errors for failure count

2. **Wrap each generation call in try/catch** within the loops:
   ```typescript
   try {
     await generatePreMatchContent(match.matchId);
     results.preMatch.generated++;
     generated++;
     log.info({ matchId: match.matchId }, 'Backfilled pre-match content');
   } catch (err) {
     results.preMatch.failed++;
     // Errors are already logged in the content function
     // Just track the failure count here
   }
   ```

3. **Update log messages** - remove "returned false (non-blocking)" since functions now throw

4. **Do not re-throw errors** in scanMatchesMissingContent - this scan job should continue processing other matches even when one fails. The individual content jobs will handle their own retries when triggered directly.

This change makes the scan job robust while individual content generation jobs (when triggered directly) will properly throw and retry via BullMQ.
  </action>
  <verify>
Run `npx tsc --noEmit` - no TypeScript errors
Run `grep -c "if (success)" src/lib/queue/workers/content.worker.ts` - should return 0
  </verify>
  <done>
- scanMatchesMissingContent uses try/catch around each generation call
- No more boolean success checks
- Errors are caught and counted, not re-thrown (scan continues)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compilation: `npx tsc --noEmit` passes
2. No silent failures: `grep -c "return false" src/lib/content/match-content.ts` returns 0
3. Error throwing implemented: `grep -c "throw new" src/lib/content/match-content.ts` returns 8+
4. Error classes exist: `cat src/lib/errors/content-errors.ts | head -20` shows exports
</verification>

<success_criteria>
- PIPE-01 satisfied: Content generation functions throw errors on failure
- All 4 content generation functions (pre-match, betting, post-match, FAQ) throw instead of return false
- FatalContentError used for unrecoverable cases (match not found)
- RetryableContentError used for transient failures with diagnostic context
- Content worker handles new void signatures correctly
</success_criteria>

<output>
After completion, create `.planning/phases/32-make-failures-visible/32-01-SUMMARY.md`
</output>
