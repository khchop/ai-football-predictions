---
phase: 48-performance-verification
plan: 02
type: execute
wave: 2
depends_on: ["48-01"]
files_modified:
  - scripts/audit-internal-links.ts
autonomous: true

must_haves:
  truths:
    - "Production TTFB measured for all page types against kroam.xyz"
    - "Any pages with TTFB >2s are investigated and optimized if fix is straightforward"
    - "/matches/UUID redirect verified to respond within 500ms"
    - "All 6 audit passes run successfully against production with 0 failures"
    - "Pre-Ahrefs spot-checks confirm site is audit-ready"
  artifacts:
    - path: "scripts/audit-internal-links.ts"
      provides: "Audit script (may have additional fixes from profiling results)"
  key_links:
    - from: "scripts/audit-internal-links.ts"
      to: "kroam.xyz"
      via: "AUDIT_BASE_URL=https://kroam.xyz"
      pattern: "AUDIT_BASE_URL"
---

<objective>
Profile production TTFB against kroam.xyz, optimize any slow pages found, verify /matches/UUID redirect speed, run complete audit suite, and perform pre-Ahrefs spot-checks to declare site audit-ready.

Purpose: This is the investigation and verification plan. After Plan 01 added the TTFB measurement tooling, this plan uses it against production to find and fix performance issues, then verifies the entire v2.6 SEO work (Phases 44-47) is clean.
Output: Production-profiled site with documented TTFB results, all audit passes green, site declared Ahrefs-ready.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-performance-verification/48-CONTEXT.md
@.planning/phases/48-performance-verification/48-RESEARCH.md
@.planning/phases/48-performance-verification/48-01-SUMMARY.md
@scripts/audit-internal-links.ts
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy and Run Production TTFB Profiling</name>
  <files></files>
  <action>
This task profiles production performance and fixes any issues found. It is primarily investigation work.

**Step 1: Deploy latest code (with Pass 6 from Plan 01)**
- Run `git push` to trigger Coolify deployment (if not already deployed)
- Wait for deployment to complete (check production is live)

**Step 2: Run full audit against production**
- Execute: `AUDIT_BASE_URL=https://kroam.xyz npm run audit:links`
- This runs all 6 passes including the new Pass 6 TTFB measurement
- Capture and analyze results for all passes

**Step 3: Verify /matches/UUID redirect speed (PERF-02)**
- Use curl with timing to verify: `curl -w "TTFB: %{time_starttransfer}s\nTotal: %{time_total}s\n" -o /dev/null -s https://kroam.xyz/matches/00000000-0000-0000-0000-000000000000`
- The middleware returns 410 Gone immediately - this should be well under 500ms
- If >500ms, investigate why (should be impossible given synchronous middleware)

**Step 4: Investigate any slow pages (>2s TTFB)**
If Pass 6 reports slow pages:
- Identify page type (match, league, model, blog, index)
- Check if the page data fetching already uses Promise.all() (most do per code review)
- For match pages: the two-stage fetch is necessary (need match ID first), but the parallel second stage should keep TTFB reasonable
- For any page with sequential queries NOT already parallelized: fix with Promise.all()
- For pages slow due to cold starts or external factors: document in summary but do NOT treat as blockers (per user decision)

**Step 5: Fix easy wins found during profiling**
If optimization opportunities are found:
- Apply Promise.all() parallelization where missing
- Check Suspense boundaries are properly placed for PPR
- Verify cacheComponents is working (static shell should be fast)
- DO NOT add complex caching layers or new dependencies unless clearly needed

**Step 6: Re-run audit if fixes were applied**
- If code changes were made, deploy and re-run: `AUDIT_BASE_URL=https://kroam.xyz npm run audit:links`
- Confirm all 6 passes show 0 failures
  </action>
  <verify>
- `AUDIT_BASE_URL=https://kroam.xyz npm run audit:links` returns exit code 0 (0 failures)
- Pass 6 results show average TTFB per page type
- curl timing for /matches/UUID shows TTFB <500ms
  </verify>
  <done>All 6 audit passes green against production. /matches/UUID responds <500ms. TTFB profiling complete with results documented. Any easy-win optimizations applied.</done>
</task>

<task type="auto">
  <name>Task 2: Pre-Ahrefs Spot-Check Verification</name>
  <files></files>
  <action>
Perform the recommended pre-audit spot-checks to confirm the site is ready for Ahrefs crawl.

**Check 1: Sitemap accessibility**
- `curl -s -o /dev/null -w "%{http_code}" https://kroam.xyz/sitemap.xml` should return 200
- Verify the sitemap index lists sub-sitemaps

**Check 2: robots.txt**
- `curl -s https://kroam.xyz/robots.txt`
- Verify it allows crawling of important paths (/leagues/, /models/, /blog/, /leaderboard)
- Verify it references the sitemap URL

**Check 3: Redirect verification**
- Test www redirect: `curl -s -o /dev/null -w "%{http_code} -> %{redirect_url}" https://www.kroam.xyz/` should return 301 to https://kroam.xyz/
- Test HTTP redirect: verify x-forwarded-proto handling works in production
- Test long-form league slug: `curl -s -o /dev/null -w "%{http_code} -> %{redirect_url}" https://kroam.xyz/leagues/premier-league` should return 301 to /leagues/epl

**Check 4: Sample page health (3-5 URLs per page type)**
For each page type, fetch and verify 200 status:
- Index: https://kroam.xyz/, https://kroam.xyz/models, https://kroam.xyz/leagues
- League: https://kroam.xyz/leagues/epl, https://kroam.xyz/leagues/ucl
- Model: Pick 2 model URLs from sitemap
- Blog: Pick 2 blog URLs from sitemap
- Match: Pick 2 match URLs from sitemap

**Check 5: Breadcrumb structure**
- Fetch 3 pages (a league page, a match page, a model page)
- Verify BreadcrumbList JSON-LD is present with correct itemListElement structure

**Check 6: No critical SEO issues**
- Verify no pages return 404 or 500
- Verify no redirect chains exist (all redirects are single-hop)
- Verify canonical URLs are self-referential on sampled pages

Document all spot-check results. If any check fails, fix the issue before declaring ready.
  </action>
  <verify>
All 6 spot-checks pass:
1. Sitemap returns 200 with valid sub-sitemaps
2. robots.txt allows crawling and references sitemap
3. All redirects work correctly (301, single-hop)
4. Sample pages return 200
5. Breadcrumb schemas present
6. No critical SEO errors found
  </verify>
  <done>All pre-Ahrefs spot-checks pass. Site declared ready for Ahrefs audit. Findings documented in summary.</done>
</task>

</tasks>

<verification>
1. Full audit suite passes against production (0 failures across 6 passes)
2. /matches/UUID TTFB verified <500ms
3. All pre-Ahrefs spot-checks pass
4. TTFB profiling results documented with page type averages
</verification>

<success_criteria>
- Production audit: 6/6 passes green
- PERF-02: /matches/UUID <500ms verified
- PERF-01: TTFB profiled for all page types, slow pages investigated and easy wins fixed
- Pre-Ahrefs: sitemap, robots.txt, redirects, sample pages, breadcrumbs, no critical errors
- Site declared Ahrefs-ready
</success_criteria>

<output>
After completion, create `.planning/phases/48-performance-verification/48-02-SUMMARY.md`
</output>
