---
phase: 04-content-pipeline
plan: 05
type: execute
wave: 1
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified: ["src/lib/queue/jobs/calculate-stats.ts"]
autonomous: true
gap_closure: true
---

<objective>
Trigger roundup generation AFTER stats calculation completes, ensuring roundups include complete model performance data.

Purpose: Currently `schedulePostMatchRoundup()` is called immediately after scoring (in scoring.worker.ts), but stats calculation happens separately. This means roundups may not include complete model performance data.

Output: Roundups are triggered after stats calculation completes, with access to fresh model stats.
</objective>

<execution_context>
@/Users/pieterbos/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Gap to Close: INT-02 - Roundup Generation Doesn't Wait for Stats

From .planning/v1-MILESTONE-AUDIT.md:

```
- id: INT-02
  description: Roundup generation doesn't wait for stats calculation
  severity: medium
  impact: Roundups may not include complete model performance data
```

**Current State:**

Roundup generation flow:
1. Match finishes → scoring.worker.ts:232 → `schedulePostMatchRoundup()` (60s delay)
2. Stats worker calculates points separately
3. Roundups may not have access to complete stats data

Stats calculation flow:
1. enqueuePointsCalculation() queues stats job
2. handleCalculatePoints() processes job
3. invalidateStatsCache() clears cache after stats
4. NO roundup trigger after stats complete

**Existing Code:**

`src/lib/queue/workers/scoring.worker.ts:232`:
```typescript
await schedulePostMatchRoundup(matchId);  // Called immediately after scoring
```

`src/lib/queue/jobs/calculate-stats.ts:185`:
```typescript
await invalidateStatsCache({...});  // After stats calculation
// NO roundup trigger here
```

**Desired State:**

Roundup should be triggered AFTER stats calculation completes, so the roundup can include:
- Updated model performance data
- Correct points totals
- Latest leaderboard positions

Implementation approach:
- Call `schedulePostMatchRoundup()` after `invalidateStatsCache()` in `handleCalculatePoints()`
- Use a short delay (e.g., 30s) to let stats settle
- Or chain directly without delay (stats are already calculated)

**Files to modify:**

1. `src/lib/queue/jobs/calculate-stats.ts` - Add roundup trigger after cache invalidation

**Key considerations:**

1. The roundup generation already has a 60s internal delay in `schedulePostMatchRoundup()`
2. Stats calculation completes very quickly (within the stats worker)
3. We should trigger AFTER invalidateStatsCache ensures cache is fresh
4. Need to import schedulePostMatchRoundup from scoring.worker.ts or queue module

**Reference implementation pattern:**

```typescript
// In calculate-stats.ts handleCalculatePoints, after line 185:
const { schedulePostMatchRoundup } = await import('@/lib/queue/workers/scoring.worker.ts');
await schedulePostMatchRoundup(matchId, 30000); // 30s delay for stats to settle
```

</context>

<tasks>

<task type="auto">
  <name>Add roundup trigger after stats calculation</name>
  <files>src/lib/queue/jobs/calculate-stats.ts</files>
  <action>
  Update `src/lib/queue/jobs/calculate-stats.ts` to trigger roundup generation after stats calculation completes.

  1. Find the `handleCalculatePoints` function (around line 99)
  2. After the `invalidateStatsCache()` call (around line 185), add roundup trigger:
     ```typescript
     // Trigger roundup after stats calculation completes
     // This ensures roundups have access to complete model performance data
     try {
       const { schedulePostMatchRoundup } = await import('@/lib/queue/workers/scoring.worker.ts');
       await schedulePostMatchRoundup(matchId, 30000); // 30s delay for stats to settle
     } catch (error) {
       // Log error but don't fail stats calculation
       console.error('Failed to schedule post-match roundup:', error);
     }
     ```
  
  3. Import `schedulePostMatchRoundup` is already exported from scoring.worker.ts
  4. The function uses dynamic import to avoid circular dependency
  5. Error handling ensures stats calculation succeeds even if roundup fails
  6. 30s delay gives time for cache invalidation to propagate and stats to be queryable

  7. Verify: The roundup will trigger ~90 seconds after match (60s from original schedule + 30s here)
     - Actually, we should NOT call both places. We need to either:
       a. Remove the call from scoring.worker.ts and only trigger from stats worker
       b. Or use a flag to skip the initial trigger and only trigger after stats

  8. BETTER APPROACH: Remove the call from scoring.worker.ts:232 and only trigger from stats worker
     - This ensures roundups always include complete stats
     - Modify scoring.worker.ts to NOT call schedulePostMatchRoundup
     - Only trigger roundup after stats calculation in calculate-stats.ts
  </action>
  <verify>
  1. Check that schedulePostMatchRoundup is NOT called in scoring.worker.ts anymore
  2. Check that schedulePostMatchRoundup IS called after invalidateStatsCache in calculate-stats.ts
  3. npm run build compiles successfully
  4. TypeScript types are correct
  </verify>
  <done>Roundup generation is triggered AFTER stats calculation completes, ensuring roundups include complete model performance data</done>
</task>

<task type="auto">
  <name>Remove roundup trigger from scoring worker</name>
  <files>src/lib/queue/workers/scoring.worker.ts</files>
  <action>
  Remove the roundup trigger from `src/lib/queue/workers/scoring.worker.ts` to avoid duplicate triggers.

  1. Find the call to `schedulePostMatchRoundup(matchId)` at line 232
  2. Remove or comment out this line:
     ```typescript
     // REMOVED: Roundups are now triggered after stats calculation
     // await schedulePostMatchRoundup(matchId);
     ```

  3. Add a comment explaining why it was removed:
     ```typescript
     // NOTE: Roundup generation moved to stats worker (calculate-stats.ts)
     // Roundups now trigger AFTER stats calculation to ensure complete model data
     ```

  4. Keep the `schedulePostMatchRoundup` function export (it's needed by calculate-stats.ts)
  5. Do NOT remove the function definition - it's still used by calculate-stats.ts
  </action>
  <verify>npm run build compiles successfully (no errors)</verify>
  <done>Duplicate roundup trigger removed from scoring worker, preventing race conditions</done>
</task>

</tasks>

<verification>
1. schedulePostMatchRoundup is called ONLY in calculate-stats.ts (after stats)
2. scoring.worker.ts no longer calls schedulePostMatchRoundup at line 232
3. Dynamic import pattern works correctly (no circular dependency)
4. Error handling prevents stats calculation from failing if roundup fails
5. npm run build completes without errors
6. TypeScript compilation passes
</verification>

<success_criteria>
- Roundups trigger AFTER stats calculation (not immediately after scoring)
- Complete model performance data is included in roundups
- No duplicate roundup triggers
- Build passes without errors
- Error handling ensures stats calculation succeeds independently
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-pipeline/04-05-SUMMARY.md` documenting the roundup timing fix
</output>