---
phase: 04-content-pipeline
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/content/generator.ts
  - src/lib/content/match-content.ts
  - src/lib/content/prompts.ts
  - src/lib/db/queries.ts
autonomous: true
must_haves:
  truths:
    - "Post-match roundup contains scoreboard header with final score"
    - "Roundup includes key events timeline with possession, shots, corners, xG"
    - "Model predictions displayed with accuracy columns"
    - "Top performer models listed with their predictions"
    - "LLM generates factual narrative analysis (no hallucinations)"
  artifacts:
    - path: "src/lib/content/generator.ts"
      provides: "generatePostMatchRoundup function with full roundup structure"
    - path: "src/lib/content/match-content.ts"
      provides: "generatePostMatchRoundupContent helper function"
    - path: "src/lib/content/prompts.ts"
      provides: "buildPostMatchRoundupPrompt template"
    - path: "src/lib/db/queries.ts"
      provides: "getMatchPredictionsWithAccuracy query"
  key_links:
    - from: "generator.ts"
      to: "prompts.ts"
      via: "buildPostMatchRoundupPrompt builds structured prompt"
      pattern: "buildPostMatchRoundupPrompt"
    - from: "generator.ts"
      to: "db/queries.ts"
      via: "getMatchPredictionsWithAccuracy fetches model predictions"
      pattern: "getMatchPredictionsWithAccuracy"
---

<objective>
Implement LLM-powered post-match roundup generation with structured prompt engineering.

**Purpose:** Generate comprehensive roundups with scoreboard, events, model predictions, and factual narrative analysis following the format from CONTEXT.md.

**Output:** Working roundup generation that creates Score → Events → Analysis structured content with model predictions and top performers.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-content-pipeline/04-CONTEXT.md
@.planning/phases/04-content-pipeline/04-RESEARCH.md
@src/lib/content/generator.ts
@src/lib/content/match-content.ts
@src/lib/content/prompts.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Add getMatchPredictionsWithAccuracy query</name>
  <files>src/lib/db/queries.ts</files>
  <action>
    Add database query to fetch match predictions with accuracy data:

    Create `getMatchPredictionsWithAccuracy(matchId: string)` function that returns:
    - For each model: model name, predicted score, predicted result
    - Actual result and score (homeScore, awayScore, finalScore)
    - Points earned: tendencyPoints, goalDiffBonus, exactScoreBonus, totalPoints
    - Accuracy: whether predicted result matches actual (H/D/A), whether score was exact
    - Rank by totalPoints descending

    Return type should be Array<{
      modelName: string;
      predictedHome: number;
      predictedAway: number;
      predictedResult: 'H' | 'D' | 'A';
      actualHome: number;
      actualAway: number;
      actualResult: 'H' | 'D' | 'A';
      correctTendency: boolean;
      exactScore: boolean;
      totalPoints: number;
    }>

    Reference existing prediction queries at line ~180-250 of queries.ts for pattern.
  </action>
  <verify>
    grep -n "getMatchPredictionsWithAccuracy" src/lib/db/queries.ts
  </verify>
  <done>
    Query returns model predictions with accuracy data for a match
  </done>
</task>

<task type="auto">
  <name>Add buildPostMatchRoundupPrompt to prompts.ts</name>
  <files>src/lib/content/prompts.ts</files>
  <action>
    Create prompt template for post-match roundup:

    Build structured prompt that includes:

    **Data Section (for LLM context):**
    - Match info: homeTeam, awayTeam, final score, competition, venue, kickoff
    - Match events: goals (scorer, minute), cards (type, player, minute), substitutions, key incidents
    - Extended stats: possession (%), shots (total/on target), corners, xG, fouls, offsides
    - Model predictions table: model name, predicted score, predicted result, actual result, correct tendency (Y/N), exact score (Y/N), points earned
    - Top 3 performers: model name, prediction, points earned
    - Narrative angles to detect: derby, comeback, upset, milestone

    **Instructions Section:**
    - Write 1000+ words with balanced tone (storytelling + stats)
    - Structure: Score header → Events timeline → Model predictions → Analysis
    - Include specific model names (no generic "Model 1")
    - Use facts only from provided data (no hallucinations)
    - Highlight unique angles (comebacks, upsets, derbies)
    - Rich formatting: headers, bullet points for stats, occasional emoji

    **JSON Output:**
    Return structured JSON with:
    - `title`: Match title with score
    - `scoreboard`: { homeTeam, awayTeam, homeScore, awayScore, competition }
    - `events`: Array of { minute, type, description }
    - `stats`: { possession, shots, corners, xG, ... }
    - `modelPredictions`: HTML table string
    - `topPerformers`: Array of { modelName, prediction, points }
    - `narrative`: Full HTML content (1000+ words)
    - `keywords`: Array of SEO keywords

    Reference existing buildMatchPreviewPrompt and buildLeagueRoundupPrompt patterns.
  </action>
  <verify>
    grep -n "buildPostMatchRoundupPrompt\|PostMatchRoundupResponse" src/lib/content/prompts.ts
  </verify>
  <done>
    Prompt template builds structured prompt for roundup generation
  </done>
</task>

<task type="auto">
  <name>Implement generatePostMatchRoundup function</name>
  <files>src/lib/content/generator.ts</files>
  <action>
    Implement main roundup generation function:

    Create `generatePostMatchRoundup(matchId: string): Promise<string>` that:

    1. **Data Gathering:**
       - Fetch match data with final score and status
       - Fetch predictions with accuracy using getMatchPredictionsWithAccuracy
       - Fetch match events (goals, cards, substitutions) from matchAnalysis
       - Detect narrative angles: derby (same city), comeback (trailed then won), upset (underdog won), milestone (records)

    2. **Model Performance Analysis:**
       - Calculate: total predictions, correct tendency count, exact score count
       - Identify top 3 performers by points
       - Build predictions table with accuracy columns

    3. **Prompt Building:**
       - Call buildPostMatchRoundupPrompt with all data
       - Use temperature 0.3-0.5 for factual content (from RESEARCH.md 1.1)

    4. **LLM Generation:**
       - Call generateWithTogetherAI with PostMatchRoundupResponse schema
       - Use JSON mode for structured output (from RESEARCH.md 1.3)

    5. **Validation:**
       - Validate output using existing validation patterns (check for hallucinated team names)
       - Ensure model names match actual model names from database

    6. **Storage:**
       - Store roundup in appropriate table (matchContent or new roundups table)
       - Include all fields: title, scoreboard, events, stats, predictions table, narrative, keywords

    Return the roundup ID.

    Reference existing generateMatchPreview and generateLeagueRoundup patterns.
  </action>
  <verify>
    grep -n "generatePostMatchRoundup" src/lib/content/generator.ts
  </verify>
  <done>
    Post-match roundup generation creates structured content with all required sections
  </done>
</task>

<task type="auto">
  <name>Wire roundup handler in content worker</name>
  <files>src/lib/queue/workers/content.worker.ts</files>
  <action>
    Connect the generate-roundup job type to the new generator function:

    1. Update the 'generate-roundup' case in the switch statement to call:
       `await generatePostMatchRoundupContent(data as { matchId: string })`

    2. Create the helper function `async function generatePostMatchRoundupContent(data: { matchId: string })`:
       - Call generatePostMatchRoundup(data.matchId)
       - Return { success: true, roundupId, matchId: data.matchId }

    3. Handle errors appropriately (log and rethrow for retry)

    This connects the queue job to the actual generation logic.
  </action>
  <verify>
    grep -n "generatePostMatchRoundupContent\|generate-roundup" src/lib/queue/workers/content.worker.ts
  </verify>
  <done>
    Content worker routes roundup jobs to generation function
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without type errors
2. getMatchPredictionsWithAccuracy returns predictions with accuracy data
3. buildPostMatchRoundupPrompt produces structured prompt with all sections
4. generatePostMatchRoundup creates roundup with scoreboard, events, predictions, narrative
5. Content worker successfully processes roundup jobs
</verification>

<success_criteria>
- [ ] Roundups include scoreboard header with final score
- [ ] Events timeline shows goals, cards, key incidents
- [ ] Extended stats: possession, shots, corners, xG displayed
- [ ] Model predictions table shows each model's prediction vs actual with accuracy
- [ ] Top 3 performers listed with predictions and points
- [ ] LLM narrative is 1000+ words with factual analysis
- [ ] Generation uses temperature 0.3-0.5 for factual content
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-pipeline/04-02-SUMMARY.md`
</output>
