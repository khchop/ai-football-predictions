---
phase: 04-content-pipeline
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queue/types.ts
  - src/lib/queue/workers/settlement.worker.ts
  - src/lib/queue/index.ts
autonomous: true
must_haves:
  truths:
    - "Post-match roundup generation is triggered automatically after match settlement"
    - "Content queue processes roundup jobs with 30-60 second delay"
    - "Match data and predictions are gathered for content generation"
  artifacts:
    - path: "src/lib/queue/types.ts"
      provides: "GenerateRoundupPayload type and job type constant"
    - path: "src/lib/queue/workers/settlement.worker.ts"
      provides: "schedulePostMatchRoundup function with delayed job queueing"
    - path: "src/lib/queue/index.ts"
      provides: "QUEUE_NAMES.ROUNDUP constant if needed"
  key_links:
    - from: "settlement.worker.ts"
      to: "contentQueue"
      via: "schedulePostMatchRoundup function with 60000ms delay"
      pattern: "getContentQueue\\(\\).add.*delay.*60000"
---

<objective>
Set up BullMQ content queue for post-match roundup generation with automatic trigger from settlement worker.

**Purpose:** Enable automated roundup generation by adding a new job type that content worker can process, triggered from settlement after matches complete.

**Output:** Queue infrastructure ready to receive roundup generation jobs with 30-60 second delay after match settlement.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-pipeline/04-CONTEXT.md
@.planning/phases/04-content-pipeline/04-RESEARCH.md

# Existing queue patterns from codebase
@src/lib/queue/index.ts
@src/lib/queue/workers/content.worker.ts
@src/lib/queue/workers/settlement.worker.ts
</context>

<tasks>

<task type="auto">
  <name>Add roundup job type and payload to queue types</name>
  <files>src/lib/queue/types.ts</files>
  <action>
    Add new job type constant and payload interface for roundup generation:

    1. Add to JOB_TYPES (or extend if needed): `GENERATE_ROUNDUP: 'generate-roundup'`
    2. Add new interface `GenerateRoundupPayload` with:
       - `type: 'generate-roundup'`
       - `data.matchId: string`
       - `data.triggeredAt: string` (ISO timestamp when settlement completed)
    3. Add to `GenerateContentPayload` union type if using existing pattern

    Reference existing pattern at line 12-32 of types.ts for style consistency.
  </action>
  <verify>
    grep -n "GENERATE_ROUNDUP" src/lib/queue/types.ts && grep -n "GenerateRoundupPayload" src/lib/queue/types.ts
  </verify>
  <done>
    Types for roundup generation job exist in queue types file
  </done>
</task>

<task type="auto">
  <name>Create schedulePostMatchRoundup function in settlement worker</name>
  <files>src/lib/queue/workers/settlement.worker.ts</files>
  <action>
    Add function to schedule roundup generation after settlement:

    1. Import `getContentQueue` and `QUEUE_NAMES` from queue/index
    2. Create `schedulePostMatchRoundup(matchId: string, delayMs: number = 60000)` function that:
       - Queues a job with type 'generate-roundup' and { matchId, triggeredAt }
       - Uses the delay parameter (default 60000ms = 60 seconds)
       - Sets jobId to `roundup-{matchId}` to prevent duplicates
       - Configures removeOnComplete (age: 86400) and removeOnFail (age: 604800)
    3. Call this function from settleMatch() after scoring completes successfully
    4. Log the scheduling: "Scheduled post-match roundup for match {id} with {delay}ms delay"

    Reference existing schedulePostMatchContent at line 223-250 of 04-RESEARCH.md for pattern.
  </action>
  <verify>
    grep -n "schedulePostMatchRoundup\|GENERATE_ROUNDUP" src/lib/queue/workers/settlement.worker.ts
  </verify>
  <done>
    Settlement worker schedules roundup generation 60 seconds after match settlement
  </done>
</task>

<task type="auto">
  <name>Add roundup type handler to content worker</name>
  <files>src/lib/queue/workers/content.worker.ts</files>
  <action>
    Add handler for roundup generation job type in content worker:

    1. Add case for 'generate-roundup' in the job type switch (around line 42)
    2. Create placeholder function `generatePostMatchRoundupContent(data: { matchId: string })` that:
       - Logs "Generating post-match roundup for match {id}"
       - Returns { success: true, matchId, skipped: false } for now
    3. This will be implemented in Plan 2 - just wire up the skeleton now

    The function signature should match what will be called by queue.add().
  </action>
  <verify>
    grep -n "generate-roundup\|generatePostMatchRoundupContent" src/lib/queue/workers/content.worker.ts
  </verify>
  <done>
    Content worker can receive and route roundup generation jobs
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without type errors
2. Queue types export new job type and payload interface
3. Settlement worker imports and uses schedulePostMatchRoundup
4. Content worker has handler for generate-roundup type
</verification>

<success_criteria>
- [ ] Roundup generation job type defined in queue types
- [ ] schedulePostMatchRoundup function queues jobs with 60-second delay
- [ ] Settlement worker triggers roundup generation after scoring
- [ ] Content worker accepts roundup jobs (placeholder implementation)
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-pipeline/04-01-SUMMARY.md`
</output>
