---
phase: 19-blog-page-rebuild
plan: 04
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/components/blog/blog-toc.tsx
autonomous: true

must_haves:
  truths:
    - "User jumps to specific sections via table of contents on long articles"
    - "TOC appears as fixed sidebar on desktop"
    - "TOC is hidden on mobile (desktop-only feature)"
    - "Active section is highlighted as user scrolls"
  artifacts:
    - path: "src/components/blog/blog-toc.tsx"
      provides: "Table of contents with scroll spy"
      exports: ["BlogTOC"]
  key_links:
    - from: "src/components/blog/blog-toc.tsx"
      to: "Intersection Observer API"
      via: "useEffect + new IntersectionObserver"
      pattern: "IntersectionObserver"
    - from: "src/components/blog/blog-toc.tsx"
      to: "heading IDs from content"
      via: "getElementById for observation"
      pattern: "getElementById.*observe"
---

<objective>
Create table of contents component with Intersection Observer scroll spy.

Purpose: BLOG-03 requires TOC for articles over 500 words. User decision specifies fixed sidebar on desktop, collapsed on mobile. Intersection Observer is the performance-standard approach for scroll tracking (per research: "offloads to browser's compositor thread").

Output: BlogTOC component with sticky positioning, scroll spy highlighting, and mobile hiding.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-blog-page-rebuild/19-CONTEXT.md
@.planning/phases/19-blog-page-rebuild/19-RESEARCH.md

# Dependency - heading extraction from Plan 01
@src/lib/blog/extract-headings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BlogTOC component with scroll spy</name>
  <files>src/components/blog/blog-toc.tsx</files>
  <action>
Create BlogTOC component with Intersection Observer scroll tracking:

```typescript
'use client';

import type { Heading } from '@/lib/blog/extract-headings';

interface BlogTOCProps {
  headings: Heading[];
}

export function BlogTOC({ headings }: BlogTOCProps)
```

Implementation requirements:

1. **Client component** - requires useEffect for Intersection Observer

2. **State management**:
   - `activeId` state tracks currently visible section
   - Use `useRef` for observer instance (per research: avoid re-renders)

3. **Intersection Observer setup** (per research pattern):
   ```typescript
   const observerRef = useRef<IntersectionObserver | null>(null);

   useEffect(() => {
     // Use Map for visibility tracking (not state - per research anti-pattern)
     const visibilityMap = new Map<string, boolean>();

     observerRef.current = new IntersectionObserver(
       (entries) => {
         entries.forEach(entry => {
           visibilityMap.set(entry.target.id, entry.isIntersecting);
         });
         // Find first visible heading
         const firstVisible = headings.find(h => visibilityMap.get(h.id));
         if (firstVisible) {
           setActiveId(firstVisible.id);
         }
       },
       {
         rootMargin: '-80px 0px -80% 0px', // Near top trigger
         threshold: 0.5
       }
     );

     // Observe all headings
     headings.forEach(h => {
       const el = document.getElementById(h.id);
       if (el) observerRef.current?.observe(el);
     });

     // CRITICAL: Disconnect on unmount (per research)
     return () => observerRef.current?.disconnect();
   }, [headings]);
   ```

4. **Styling** (per user decision: fixed sidebar on desktop):
   ```tsx
   <nav className="hidden lg:block sticky top-24 max-h-[calc(100vh-6rem)] overflow-auto">
     <h2 className="font-semibold mb-3 text-sm text-muted-foreground">On this page</h2>
     <ul className="space-y-2 text-sm">
       {headings.map(h => (
         <li key={h.id} className={h.level === 3 ? 'ml-4' : ''}>
           <a
             href={`#${h.id}`}
             className={cn(
               'block py-1 transition-colors hover:text-foreground',
               activeId === h.id
                 ? 'text-primary font-medium'
                 : 'text-muted-foreground'
             )}
           >
             {h.text}
           </a>
         </li>
       ))}
     </ul>
   </nav>
   ```

5. **Mobile handling** (per user decision and research recommendation):
   - `hidden lg:block` - completely hidden on mobile
   - No dropdown/bottom sheet (simplest approach first)

6. **Empty state**:
   - If headings.length === 0, return null

Import `cn` from '@/lib/utils' for className merging.
  </action>
  <verify>
- File exists at src/components/blog/blog-toc.tsx
- Uses 'use client' directive
- Creates IntersectionObserver in useEffect
- Disconnects observer in cleanup function
- Hidden on mobile (lg:block)
  </verify>
  <done>
BlogTOC component tracks scroll position, highlights active section, renders as sticky sidebar on desktop
  </done>
</task>

<task type="auto">
  <name>Task 2: Add smooth scroll behavior</name>
  <files>src/components/blog/blog-toc.tsx</files>
  <action>
Enhance TOC links with smooth scroll and accessibility:

1. **Smooth scroll on click**:
   ```tsx
   onClick={(e) => {
     e.preventDefault();
     const element = document.getElementById(h.id);
     if (element) {
       element.scrollIntoView({ behavior: 'smooth' });
       // Update URL hash without scroll jump
       history.pushState(null, '', `#${h.id}`);
     }
   }}
   ```

2. **Respect prefers-reduced-motion** (per Phase 17 decision):
   ```tsx
   const prefersReducedMotion =
     typeof window !== 'undefined' &&
     window.matchMedia('(prefers-reduced-motion: reduce)').matches;

   element.scrollIntoView({
     behavior: prefersReducedMotion ? 'auto' : 'smooth'
   });
   ```

3. **ARIA attributes** for accessibility:
   - `aria-label="Table of contents"` on nav
   - `aria-current="location"` on active link

This task modifies the component created in Task 1 to add click behavior.
  </action>
  <verify>
- Clicking TOC link smoothly scrolls to section
- URL hash updates without page reload
- prefers-reduced-motion disables smooth scroll
  </verify>
  <done>
TOC links scroll smoothly with reduced-motion support and proper ARIA attributes
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify TOC TypeScript and build</name>
  <files>src/components/blog/blog-toc.tsx</files>
  <action>
Ensure the TOC component compiles correctly:

1. Verify imports:
   - `import type { Heading } from '@/lib/blog/extract-headings'`
   - `import { cn } from '@/lib/utils'`
   - React hooks from 'react'

2. Run TypeScript check:
   ```bash
   npx tsc --noEmit src/components/blog/blog-toc.tsx
   ```

3. Run build to verify no errors:
   ```bash
   npm run build
   ```

4. Check that Heading type from Plan 01 is correctly imported and used

Fix any TypeScript errors before marking complete.
  </action>
  <verify>
- `npm run build` succeeds
- No TypeScript errors in blog-toc.tsx
- Heading type correctly imported from extract-headings.ts
  </verify>
  <done>
BlogTOC component compiles without errors, ready for integration in Plan 05
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without TypeScript errors
2. BlogTOC uses Intersection Observer (not scroll event listener)
3. Observer properly disconnects on unmount
4. Component hidden on mobile, sticky on desktop
5. Active state styling applies to current section
</verification>

<success_criteria>
- BLOG-03: TOC component exists for long articles
- Scroll spy highlights current section using Intersection Observer
- Fixed sidebar position on desktop (sticky top-24)
- Hidden on mobile per research recommendation
- Smooth scroll with reduced-motion support
</success_criteria>

<output>
After completion, create `.planning/phases/19-blog-page-rebuild/19-04-SUMMARY.md`
</output>
