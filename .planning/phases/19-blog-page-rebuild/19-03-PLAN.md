---
phase: 19-blog-page-rebuild
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/blog/related-articles.ts
  - src/components/blog/related-articles.tsx
  - src/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "User discovers related articles via widget at post end"
    - "Related articles display as visual cards with title and excerpt"
    - "Widget shows 1-3 articles (not hidden if only 1 exists)"
  artifacts:
    - path: "src/lib/blog/related-articles.ts"
      provides: "Content similarity algorithm for related posts"
      exports: ["findRelatedArticles"]
    - path: "src/components/blog/related-articles.tsx"
      provides: "Related articles card grid widget"
      exports: ["RelatedArticles"]
  key_links:
    - from: "src/components/blog/related-articles.tsx"
      to: "src/lib/blog/related-articles.ts"
      via: "import findRelatedArticles"
      pattern: "import.*findRelatedArticles"
    - from: "src/lib/blog/related-articles.ts"
      to: "database query"
      via: "blog posts from queries.ts"
      pattern: "getPublishedBlogPosts|getBlogPosts"
---

<objective>
Create related articles utility and widget for blog post discovery.

Purpose: BLOG-05 requires related articles widget showing contextually relevant posts. This increases engagement and internal linking. User decision specifies visual card grid with 2-3 cards, showing fallback to whatever exists (1-2 cards if that's all available).

Output: findRelatedArticles utility with tag-based similarity, RelatedArticles component with card grid layout.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-blog-page-rebuild/19-CONTEXT.md
@.planning/phases/19-blog-page-rebuild/19-RESEARCH.md

# Existing patterns
@src/app/blog/page.tsx
@src/lib/db/schema.ts
@src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create related articles utility</name>
  <files>src/lib/blog/related-articles.ts</files>
  <action>
Create related articles utility with tag-based similarity (per research: "Tag-based similarity is sufficient for small content sets"):

```typescript
import type { BlogPost } from '@/lib/db/schema';

export interface RelatedArticle {
  id: string;
  slug: string;
  title: string;
  excerpt: string | null;
  contentType: string | null;
  publishedAt: string | null;
}

export function findRelatedArticles(
  currentPost: BlogPost,
  allPosts: BlogPost[],
  limit?: number
): RelatedArticle[]
```

Algorithm (per research recommendation: "tag-based similarity with recency tiebreaker"):

1. **Primary scoring - Content type match**:
   - Same contentType (league_roundup, model_report, analysis) gets +3 points
   - Posts about same competition (competitionId match) get +5 points

2. **Secondary scoring - Tag overlap** (if tags field exists):
   - Each matching tag: +1 point
   - Parse tags from comma-separated string in schema

3. **Recency tiebreaker**:
   - If scores equal, prefer more recent posts (publishedAt)

4. **Filtering**:
   - Exclude current post (by id)
   - Only include published posts (status === 'published')

5. **Limit**:
   - Default to 3 (per user decision)
   - If fewer than 3 related found, backfill with recent posts up to limit

Return RelatedArticle[] with only fields needed for display (id, slug, title, excerpt, contentType, publishedAt).

NOTE: The BlogPost schema has `tags` field (text, comma-separated) and `competitionId` field which are useful for similarity.
  </action>
  <verify>
Test logic:
- Two posts with same competitionId should rank higher than unrelated posts
- Current post should never appear in results
- If only 1 related post exists, return array with 1 item (per user decision: show what exists)
  </verify>
  <done>
findRelatedArticles returns scored, sorted array of related posts with recency tiebreaker
  </done>
</task>

<task type="auto">
  <name>Task 2: Add query for fetching recent blog posts</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add a new query function to fetch blog posts for related articles calculation:

```typescript
export async function getRecentBlogPosts(limit: number = 20): Promise<BlogPost[]>
```

This query should:
- Select all published blog posts
- Order by publishedAt DESC
- Limit to specified count (default 20 is enough for similarity calculation)
- Include all fields needed for similarity: id, slug, title, excerpt, contentType, competitionId, tags, publishedAt, status

Rationale: We need to fetch a pool of posts to calculate similarity against. 20 posts is sufficient for tag-based similarity without fetching entire blog history.

Place near existing `getPublishedBlogPosts` and `getBlogPostBySlug` functions (around line 2277).
  </action>
  <verify>
- Function exists in queries.ts
- TypeScript compiles: `npm run build`
- Returns BlogPost[] type
  </verify>
  <done>
getRecentBlogPosts query function exists and returns blog posts for similarity calculation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RelatedArticles component</name>
  <files>src/components/blog/related-articles.tsx</files>
  <action>
Create RelatedArticles component with card grid layout:

```typescript
import type { RelatedArticle } from '@/lib/blog/related-articles';

interface RelatedArticlesProps {
  articles: RelatedArticle[];
}

export function RelatedArticles({ articles }: RelatedArticlesProps)
```

Design (per user decision: "visual cards with thumbnail, title, excerpt"):

1. **Section wrapper**:
   - `mt-12 pt-8 border-t border-border/50` (consistent with FAQ section)
   - H2: "Related Articles" or "You might also like"

2. **Card grid**:
   - `grid gap-4 md:grid-cols-2 lg:grid-cols-3`
   - Responsive: 1 col on mobile, 2 on tablet, 3 on desktop

3. **Card design** (follow blog index page pattern):
   - Link wrapping entire card for full clickable area
   - Content type badge (small, top of card)
   - Title with `line-clamp-2` for consistent height
   - Excerpt with `line-clamp-3` and muted text
   - Publish date at bottom

4. **Empty state**:
   - If articles.length === 0, return null (don't show section)

5. **Partial state** (per user decision: "show what exists"):
   - If only 1-2 articles, show them (don't require 3)

This is a server component (no 'use client' needed).

Follow the existing card pattern from src/app/blog/page.tsx for visual consistency.
  </action>
  <verify>
- File exists at src/components/blog/related-articles.tsx
- Uses grid layout with responsive columns
- Returns null when articles array is empty
- Card design matches blog index page
  </verify>
  <done>
RelatedArticles component renders card grid, handles partial results, matches site design
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without TypeScript errors
2. findRelatedArticles correctly scores by contentType and competitionId
3. RelatedArticles component renders 1-3 cards responsively
4. Empty array input results in no rendered section
</verification>

<success_criteria>
- BLOG-05: Related articles widget exists with card grid layout
- Shows 1-3 contextually relevant posts (tag/type similarity)
- Graceful handling when fewer than 3 related posts exist
- Visual design consistent with blog index page cards
</success_criteria>

<output>
After completion, create `.planning/phases/19-blog-page-rebuild/19-03-SUMMARY.md`
</output>
