---
phase: 03-stats-ui
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/components/leaderboard/compare-modal.tsx
  - src/components/leaderboard/skeleton.tsx
  - src/components/leaderboard-table.tsx
  - src/app/leaderboard/page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User sees skeleton loading state while data fetches"
    - "User can select multiple models for comparison"
    - "Comparison modal shows side-by-side stats"
  artifacts:
    - path: "src/components/leaderboard/skeleton.tsx"
      provides: "Skeleton loading placeholder"
      min_lines: 30
    - path: "src/components/leaderboard/compare-modal.tsx"
      provides: "Model comparison modal"
      min_lines: 100
    - path: "src/components/leaderboard-table.tsx"
      provides: "Table with row selection for comparison"
      min_lines: 350
  key_links:
    - from: "src/app/leaderboard/page.tsx"
      to: "src/components/leaderboard/skeleton.tsx"
      via: "Suspense fallback"
      pattern: "<Suspense fallback=\\{<.*Skeleton.*>\\}"
    - from: "src/components/leaderboard-table.tsx"
      to: "src/components/leaderboard/compare-modal.tsx"
      via: "Modal trigger on selection"
      pattern: "CompareModal.*open.*onOpenChange"
---

<objective>
Add model comparison modal and skeleton loading states to complete the stats UI phase.

Purpose: Context requires skeleton loaders for perceived performance and comparison modal for detailed side-by-side analysis. TanStack Table (Plan 01) supports row selection natively. This plan adds final UX polish.

Output: Skeleton loaders in Suspense fallbacks, row checkboxes for selection, comparison modal with full stats.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stats-ui/03-CONTEXT.md
@.planning/phases/03-stats-ui/03-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md

# Prior plans (need their outputs)
@.planning/phases/03-stats-ui/03-01-SUMMARY.md
@.planning/phases/03-stats-ui/03-02-SUMMARY.md

# Components to enhance
@src/components/leaderboard-table.tsx
@src/app/leaderboard/page.tsx
@src/app/leaderboard/competition/[id]/page.tsx
@src/app/leaderboard/club/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Install react-loading-skeleton and create skeleton component</name>
  <files>package.json, src/components/leaderboard/skeleton.tsx</files>
  <action>
    1. Install react-loading-skeleton:
    ```bash
    npm install react-loading-skeleton
    ```

    2. Create src/components/leaderboard/skeleton.tsx with:
    - Import Skeleton from 'react-loading-skeleton/dist/skeleton.css'
    - Create LeaderboardTableSkeleton component
    - Render 5 skeleton rows matching table structure:
      - Rank column: 32px circle
      - Model column: 150px rectangle
      - Stats columns: 60px rectangles each
      - Accuracy column: 80px progress bar shape
      - Streak column: 40px rectangle
    - Desktop table structure (hidden on mobile)
    - Mobile: 5 skeleton cards with rounded borders
    - Use existing Skeleton component from @/components/ui/skeleton if it exists, otherwise import from react-loading-skeleton

    Follow research Pattern 3 for skeleton structure.
  </action>
  <verify>
    ```bash
    grep "react-loading-skeleton" package.json
    ls src/components/leaderboard/skeleton.tsx
    grep -E "(Skeleton|LeaderboardTableSkeleton)" src/components/leaderboard/skeleton.tsx
    ```
    All commands should succeed showing package installed and component created.
  </verify>
  <done>react-loading-skeleton installed, LeaderboardTableSkeleton component exists with 5 placeholder rows.</done>
</task>

<task type="auto">
  <name>Create comparison modal</name>
  <files>src/components/leaderboard/compare-modal.tsx</files>
  <action>
    Create src/components/leaderboard/compare-modal.tsx with:

    Structure:
    1. Import Dialog, DialogContent, DialogHeader, DialogTitle from @/components/ui/dialog (Radix UI already in project)
    2. Props: { open: boolean, onOpenChange: (open: boolean) => void, models: LeaderboardEntry[] }
    3. Render side-by-side comparison table:
       - Rows: each stat (Total Points, Avg/Match, Matches, Correct, Exact, Accuracy, Current Streak, Best Streak, Worst Streak)
       - Columns: one per selected model (model name in header)
       - Highlight best value in each row (green text)
    4. Max width: 4xl, max height: 80vh, overflow-y-auto
    5. Close button in dialog (Radix handles ESC key and backdrop click)
    6. Empty state: "Select models to compare" if models.length === 0
    7. Responsive: horizontal scroll on small screens (overflow-x-auto on table)

    Stats to show (all from LeaderboardEntry):
    - Total Points (totalPoints)
    - Average Points (averagePoints, format to 2 decimals)
    - Matches Predicted (totalPredictions)
    - Correct Tendencies (correctTendencies)
    - Exact Scores (exactScores)
    - Accuracy % (calculated: correctTendencies / totalPredictions * 100)
    - Current Streak (currentStreak, show sign +/-)
    - Best Streak (bestStreak)
    - Worst Streak (worstStreak)

    Follow research Pattern 4 for modal structure.
  </action>
  <verify>
    ```bash
    ls src/components/leaderboard/compare-modal.tsx
    grep -E "(Dialog|CompareModal)" src/components/leaderboard/compare-modal.tsx
    npm run build 2>&1 | grep -E "(error|Error)" | head -5
    ```
    File exists, uses Radix Dialog, builds without errors.
  </verify>
  <done>CompareModal component exists with side-by-side stats table, uses Radix Dialog, responsive layout.</done>
</task>

<task type="auto">
  <name>Add row selection and comparison trigger to table</name>
  <files>src/components/leaderboard-table.tsx</files>
  <action>
    Update src/components/leaderboard-table.tsx to add row selection:

    Changes:
    1. Import CompareModal from @/components/leaderboard/compare-modal
    2. Add state: const [rowSelection, setRowSelection] = useState({}) and [compareOpen, setCompareOpen] = useState(false)
    3. Update useReactTable config:
       - Add state: { sorting, rowSelection }
       - Add onRowSelectionChange: setRowSelection
       - Add getRowId: (row) => row.modelId
       - Add enableRowSelection: true
    4. Add checkbox column at start of table (use TanStack Table selection helper):
       - Desktop: show checkbox in header (select all) and each row
       - Mobile: show checkbox in top-right of each card
       - Use input[type="checkbox"] with indeterminate state for header
    5. Add "Compare selected" button below filters:
       - Show only when rowSelection has entries
       - Button text: "Compare {count} models"
       - OnClick: setCompareOpen(true)
       - Position: sticky bottom bar on mobile, inline button on desktop
    6. Render CompareModal:
       - open={compareOpen}
       - onOpenChange={setCompareOpen}
       - models={selectedModels} where selectedModels = entries.filter(e => rowSelection[e.modelId])

    Preserve all existing functionality from Plan 01.

    Follow research guidance on TanStack Table row selection.
  </action>
  <verify>
    ```bash
    grep -E "(rowSelection|CompareModal)" src/components/leaderboard-table.tsx
    npm run build 2>&1 | grep -E "(error|Error)" | head -5
    ```
    File shows row selection state and CompareModal usage, builds without errors.
  </verify>
  <done>LeaderboardTable has row selection checkboxes, compare button, renders CompareModal on trigger.</done>
</task>

<task type="auto">
  <name>Add skeleton fallbacks to all leaderboard pages</name>
  <files>
    src/app/leaderboard/page.tsx
    src/app/leaderboard/competition/[id]/page.tsx
    src/app/leaderboard/club/[id]/page.tsx
  </files>
  <action>
    Update all three leaderboard pages to use skeleton loading:

    Changes for each page:
    1. Import LeaderboardTableSkeleton from @/components/leaderboard/skeleton
    2. Wrap LeaderboardTable in Suspense boundary:
       ```tsx
       <Suspense fallback={<LeaderboardTableSkeleton />}>
         <LeaderboardTable entries={entries} />
       </Suspense>
       ```
    3. If page already has Suspense, update fallback to use LeaderboardTableSkeleton

    Apply to:
    - src/app/leaderboard/page.tsx
    - src/app/leaderboard/competition/[id]/page.tsx
    - src/app/leaderboard/club/[id]/page.tsx

    Preserve existing page structure, only update Suspense fallback.
  </action>
  <verify>
    ```bash
    grep -E "Suspense.*LeaderboardTableSkeleton" src/app/leaderboard/page.tsx
    grep -E "Suspense.*LeaderboardTableSkeleton" src/app/leaderboard/competition/[id]/page.tsx
    grep -E "Suspense.*LeaderboardTableSkeleton" src/app/leaderboard/club/[id]/page.tsx
    ```
    All three commands should return matches showing Suspense with skeleton fallback.
  </verify>
  <done>All leaderboard pages use LeaderboardTableSkeleton in Suspense fallback.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File structure:**
   ```bash
   ls src/components/leaderboard/skeleton.tsx
   ls src/components/leaderboard/compare-modal.tsx
   ```
   Both files exist.

2. **Dependencies:**
   ```bash
   grep "react-loading-skeleton" package.json
   ```
   Package installed.

3. **Integration checks:**
   ```bash
   grep "LeaderboardTableSkeleton" src/app/leaderboard/page.tsx
   grep "CompareModal" src/components/leaderboard-table.tsx
   grep "rowSelection" src/components/leaderboard-table.tsx
   ```
   All show integration of new components.

4. **Build check:** `npm run build` completes without errors

Manual testing (user can verify in browser):
- Visit /leaderboard
- While loading, skeleton rows appear (5 animated placeholders)
- Select 2-3 models using checkboxes
- Click "Compare N models" button
- Modal opens with side-by-side stats
- Best value in each row highlighted green
- Close modal (ESC key or backdrop click)
- Selection persists after modal close
- Mobile: checkboxes in cards, compare button sticky at bottom
</verification>

<success_criteria>
- [ ] react-loading-skeleton installed
- [ ] LeaderboardTableSkeleton component exists
- [ ] CompareModal component exists using Radix Dialog
- [ ] LeaderboardTable has row selection with checkboxes
- [ ] "Compare selected" button appears when rows selected
- [ ] CompareModal renders side-by-side stats for selected models
- [ ] All leaderboard pages use LeaderboardTableSkeleton in Suspense
- [ ] npm run build completes without errors
- [ ] Mobile layout works for comparison (checkboxes in cards, sticky button)
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-ui/03-03-SUMMARY.md` with:
- Files created/modified
- Skeleton loading pattern
- Comparison modal structure
- Row selection implementation
- Any UX decisions made (e.g., max models to compare)
</output>
