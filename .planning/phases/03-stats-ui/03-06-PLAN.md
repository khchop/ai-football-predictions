---
phase: 03-stats-ui
plan: 06
type: execute
wave: 1
depends_on: ["03-05"]
files_modified: ["src/lib/db/queries.ts", "src/app/api/leaderboard/route.ts"]
autonomous: true
gap_closure: true
---

<objective>
Consolidate `getLeaderboard` functions onto the canonical version in `src/lib/db/queries/stats.ts` and remove the redundant implementation in `src/lib/db/queries.ts`.

Purpose: Eliminate code duplication, ensure consistent data aggregation logic across the platform, and reduce maintenance burden.

Output: Redundant `getLeaderboard` removed from `queries.ts`, and all remaining callers migrated to the `stats.ts` version with appropriate data mapping.
</objective>

<execution_context>
@/Users/pieterbos/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Gap to Close: INT-03 - Duplicate getLeaderboard Functions

From .planning/v1-MILESTONE-AUDIT.md:
```
- id: INT-03
  description: Duplicate getLeaderboard functions in queries.ts and stats.ts
  severity: medium
  impact: Inconsistent data shapes, maintenance burden
```

**Canonical Version:** `src/lib/db/queries/stats.ts:262`
**Redundant Version:** `src/lib/db/queries.ts:1695`

**Refactor Strategy:**
1. Update `src/app/api/leaderboard/route.ts` to call the canonical version. Since this is a legacy endpoint, we will map the flat `LeaderboardEntry` structure back to the expected `{ model: Model, ... }` shape to maintain API compatibility.
2. Update internal call in `src/lib/db/queries.ts` (`getTopPerformingModel` around line 1341) to use the canonical version.
3. Delete the redundant `getLeaderboard` and its supporting types/functions from `src/lib/db/queries.ts`.

</context>

<tasks>

<task type="auto">
  <name>Migrate /api/leaderboard to canonical getLeaderboard</name>
  <files>src/app/api/leaderboard/route.ts</files>
  <action>
  Update the legacy leaderboard API route to use the consolidated query function:

  1. Change import:
     - Old: `import { getLeaderboard, getActiveModels } from '@/lib/db/queries';`
     - New: `import { getActiveModels } from '@/lib/db/queries';`
     - Add: `import { getLeaderboard } from '@/lib/db/queries/stats';`

  2. Update the `getLeaderboard` call:
     - The canonical version takes `(limit, metric, filters)`.
     - Update call to: `let canonicalLeaderboard = await getLeaderboard(limit, 'avgPoints', { competitionId });`
     - Note: `timeRange` from the old schema needs to be mapped to `dateFrom` if present, or we can accept that the legacy endpoint might have slightly different filtering behavior during this consolidation.

  3. Map the results back to the legacy shape:
     ```typescript
     let leaderboard = canonicalLeaderboard.map(entry => ({
       model: {
         id: entry.modelId,
         displayName: entry.displayName,
         provider: entry.provider,
         active: true // The query already filters for active: true
       },
       totalPoints: entry.totalPoints,
       totalPredictions: entry.totalPredictions,
       exactScores: entry.exactScores,
       correctTendencies: entry.correctTendencies,
       avgPoints: entry.avgPoints,
       accuracy: entry.accuracy
     }));
     ```

  4. Ensure `activeOnly` filter at line 47 still works with this mapped shape.
  </action>
  <verify>Run `npm run build` or check the route file for type errors.</verify>
  <done>Legacy API endpoint now uses the canonical query while preserving its external data contract.</done>
</task>

<task type="auto">
  <name>Refactor internal usages and remove redundant getLeaderboard</name>
  <files>src/lib/db/queries.ts</files>
  <action>
  1. Locate `getTopPerformingModel` (around line 1341) and update its internal `getLeaderboard` call:
     - Use dynamic import or move it to `stats.ts` if circular dependency occurs.
     - Preferred: Call the canonical version.
     - Update the access to `topModel.model.displayName` based on the new shape.

  2. Remove the redundant `getLeaderboard` function (lines 1695-1783).
  3. Remove the redundant `LeaderboardFilters` interface (lines 1678-1682).
  4. Remove the redundant `getDateCutoff` function (lines 1685-1692) if it's no longer used.
  5. Check if `TimeRange` type is still needed elsewhere in `queries.ts`.
  </action>
  <verify>Verify no "getLeaderboard" implementation remains in `src/lib/db/queries.ts`. Verify no compilation errors in `queries.ts` callers.</verify>
  <done>Codebase consolidated on a single implementation of the leaderboard aggregation logic.</done>
</task>

</tasks>

<verification>
1. `src/lib/db/queries.ts` no longer contains an implementation of `getLeaderboard`.
2. `src/app/api/leaderboard/route.ts` successfully imports and uses `getLeaderboard` from `@/lib/db/queries/stats`.
3. `getTopPerformingModel` in `queries.ts` is updated to work with the canonical data shape.
4. `npm run build` completes without errors.
</verification>

<success_criteria>
- Zero duplicate logic for leaderboard calculation.
- Maintenance burden reduced.
- API compatibility for legacy `/api/leaderboard` preserved via mapping.
- All internal callers updated.
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-ui/03-06-SUMMARY.md` documenting the refactoring and consolidation.
</output>
