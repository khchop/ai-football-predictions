---
phase: 03-stats-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/leaderboard/competition/[id]/page.tsx
  - src/app/leaderboard/club/[id]/page.tsx
  - src/components/leaderboard-filters.tsx
autonomous: true

must_haves:
  truths:
    - "User can view competition-specific leaderboards"
    - "User can view club-specific leaderboards"
    - "Filters work on all leaderboard pages"
  artifacts:
    - path: "src/app/leaderboard/competition/[id]/page.tsx"
      provides: "Competition leaderboard page"
      min_lines: 60
    - path: "src/app/leaderboard/club/[id]/page.tsx"
      provides: "Club leaderboard page"
      min_lines: 60
    - path: "src/components/leaderboard-filters.tsx"
      provides: "Updated filters with club selector"
      min_lines: 150
  key_links:
    - from: "src/app/leaderboard/competition/[id]/page.tsx"
      to: "/api/stats/competition/[id]"
      via: "fetch in server component"
      pattern: "fetch.*api/stats/competition"
    - from: "src/app/leaderboard/club/[id]/page.tsx"
      to: "/api/stats/club/[id]"
      via: "fetch in server component"
      pattern: "fetch.*api/stats/club"
    - from: "src/components/leaderboard-filters.tsx"
      to: "leaderboard pages"
      via: "URL searchParams"
      pattern: "router\\.push.*leaderboard"
---

<objective>
Create competition and club leaderboard pages reusing existing LeaderboardTable and LeaderboardFilters components.

Purpose: Phase 2 created multi-granularity APIs (/api/stats/competition/[id], /api/stats/club/[id]). This plan surfaces those APIs as user-facing pages. Filters need club selector added; pages need Next.js app router structure with proper error boundaries.

Output: Two new page routes with server components fetching from Phase 2 APIs, updated filters with club selector.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stats-ui/03-CONTEXT.md
@.planning/phases/03-stats-ui/03-RESEARCH.md
@.planning/phases/02-stats-api-caching/02-01-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md

# Phase 2 APIs to call
@src/app/api/stats/competition/[id]/route.ts
@src/app/api/stats/club/[id]/route.ts

# Components to reuse
@src/components/leaderboard-table.tsx
@src/components/leaderboard-filters.tsx
@src/app/leaderboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Create competition leaderboard page</name>
  <files>src/app/leaderboard/competition/[id]/page.tsx</files>
  <action>
    Create src/app/leaderboard/competition/[id]/page.tsx with:

    1. Server component (async) pattern matching existing /leaderboard/page.tsx
    2. Parse params.id (competition ID) and searchParams (season, model, dateRange filters)
    3. Fetch from /api/stats/competition/[id] with Authorization: Bearer {CRON_SECRET} header
    4. Pass filters as query params: ?season=2024&model=meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo
    5. Destructure response: { success, data, meta }
    6. Render:
       - Page title: "{Competition Name} Leaderboard"
       - Competition name from API response (meta.filters.competition if exists)
       - LeaderboardFilters (with competition pre-selected, disabled)
       - LeaderboardTable with entries from data
    7. Suspense boundary with skeleton (copy from existing leaderboard page)
    8. Error boundary (create error.tsx with 'use client' and reset button)

    Handle edge cases:
    - Invalid competition ID: return 404 page
    - API error: show error boundary
    - Empty results: LeaderboardTable handles this already

    Metadata: Generate dynamic title/description based on competition name.

    Follow existing pattern from src/app/leaderboard/page.tsx structure.
  </action>
  <verify>
    ```bash
    ls src/app/leaderboard/competition/[id]/page.tsx
    grep -E "(fetch.*api/stats/competition|LeaderboardTable)" src/app/leaderboard/competition/[id]/page.tsx
    ```
    Both commands should succeed showing file exists and uses API + component.
  </verify>
  <done>Competition leaderboard page exists, fetches from Phase 2 API, renders LeaderboardTable.</done>
</task>

<task type="auto">
  <name>Create club leaderboard page</name>
  <files>src/app/leaderboard/club/[id]/page.tsx</files>
  <action>
    Create src/app/leaderboard/club/[id]/page.tsx with:

    1. Server component (async) matching competition page structure
    2. Parse params.id (club ID) and searchParams (season, model, dateRange filters)
    3. Fetch from /api/stats/club/[id] with Authorization: Bearer {CRON_SECRET} header
    4. Pass filters as query params
    5. Render:
       - Page title: "{Club Name} Model Performance"
       - Club name from API response (meta.filters.club if exists)
       - LeaderboardFilters (with club pre-selected, disabled)
       - LeaderboardTable with entries from data
    6. Suspense boundary with skeleton
    7. Error boundary (error.tsx)

    Handle edge cases:
    - Invalid club ID: return 404 page
    - API error: show error boundary
    - Empty results: LeaderboardTable handles this

    Metadata: Generate dynamic title/description based on club name.

    Structure mirrors competition page with club-specific copy.
  </action>
  <verify>
    ```bash
    ls src/app/leaderboard/club/[id]/page.tsx
    grep -E "(fetch.*api/stats/club|LeaderboardTable)" src/app/leaderboard/club/[id]/page.tsx
    ```
    Both commands should succeed showing file exists and uses API + component.
  </verify>
  <done>Club leaderboard page exists, fetches from Phase 2 API, renders LeaderboardTable.</done>
</task>

<task type="auto">
  <name>Add club selector to filters</name>
  <files>src/components/leaderboard-filters.tsx</files>
  <action>
    Update src/components/leaderboard-filters.tsx to add club selector:

    Changes:
    1. Add CLUB_OPTIONS constant with top clubs (Arsenal, Liverpool, Man City, Barcelona, Real Madrid, Bayern, etc.) - use common club names, not IDs (ID lookup happens in API)
    2. Add club Select component after competition filter:
       - Icon: Home or Building icon from lucide-react
       - Label: "Club"
       - Options: "All Clubs" (value: 'all') + CLUB_OPTIONS
       - OnChange: updateParams('club', value)
    3. Read currentClub from searchParams.get('club')
    4. Show active filter chip for club if selected (existing chip pattern)

    Keep existing filters: competition, timeRange, minPredictions.
    Preserve existing URL state sync logic (updateParams function).

    Props: Add optional disabledFilters?: string[] to allow pages to disable specific filters (e.g., competition page disables competition selector).
  </action>
  <verify>
    ```bash
    grep -E "(club|CLUB_OPTIONS)" src/components/leaderboard-filters.tsx
    npm run build 2>&1 | grep -E "(error|Error)" | head -5
    ```
    First command should show club filter code.
    Second command should show no build errors.
  </verify>
  <done>LeaderboardFilters includes club selector, optional disabledFilters prop, URL state sync works.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File structure:**
   ```bash
   ls src/app/leaderboard/competition/[id]/page.tsx
   ls src/app/leaderboard/club/[id]/page.tsx
   ```
   Both files exist.

2. **API integration:**
   ```bash
   grep "api/stats/competition" src/app/leaderboard/competition/[id]/page.tsx
   grep "api/stats/club" src/app/leaderboard/club/[id]/page.tsx
   ```
   Both pages fetch from correct Phase 2 endpoints.

3. **Component reuse:**
   ```bash
   grep "LeaderboardTable" src/app/leaderboard/competition/[id]/page.tsx
   grep "LeaderboardFilters" src/app/leaderboard/club/[id]/page.tsx
   ```
   Both pages import and use existing components.

4. **Build check:** `npm run build` completes without errors

Manual testing (user can verify in browser):
- Visit /leaderboard/competition/39 (Premier League)
- See competition name in title
- Filters work (season, timeRange, model)
- Table displays correctly
- Visit /leaderboard/club/33 (Manchester United)
- See club name in title
- Filters work
- Table displays correctly
</verification>

<success_criteria>
- [ ] src/app/leaderboard/competition/[id]/page.tsx exists
- [ ] src/app/leaderboard/club/[id]/page.tsx exists
- [ ] Both pages are async server components
- [ ] Both fetch from Phase 2 APIs with Bearer token
- [ ] Both render LeaderboardTable with fetched data
- [ ] LeaderboardFilters includes club selector
- [ ] disabledFilters prop allows conditional filter disabling
- [ ] npm run build completes without errors
- [ ] Pages handle empty results and errors gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-ui/03-02-SUMMARY.md` with:
- Files created
- API integration pattern
- Filter additions
- Routing structure
- Any edge cases handled
</output>
