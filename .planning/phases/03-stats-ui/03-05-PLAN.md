---
phase: 03-stats-ui
plan: 05
type: execute
wave: 1
depends_on: ["03-01", "03-02", "03-03", "03-04"]
files_modified: ["src/app/leaderboard/page.tsx"]
autonomous: true
gap_closure: true
---

<objective>
Fix main leaderboard to use API endpoint instead of direct database calls, enabling rate limiting and caching.

Purpose: The main `/leaderboard` page bypasses the API layer that provides authentication, rate limiting (60 req/min), and Redis caching (60s TTL). This creates a potential DDoS vector and inconsistent behavior compared to sub-pages.

Output: Updated leaderboard page that calls `/api/stats/leaderboard` endpoint with proper error handling and loading states.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Gap to Close: INT-01 - Main Leaderboard Bypasses API

From .planning/v1-MILESTONE-AUDIT.md:

```
- id: INT-01
  description: Main leaderboard bypasses API, missing rate limiting and caching
  severity: critical
  impact: Performance and security implications
```

**Current State:**
- File: `src/app/leaderboard/page.tsx:8`
- Import: `import { getLeaderboard } from '@/lib/db/queries';`
- Data fetch: `const leaderboard = await getLeaderboard({ competitionId });`

**Problems:**
1. No Bearer token authentication
2. No 60 req/min rate limiting
3. No 60s cache TTL with stale-while-revalidate
4. Inconsistent with sub-pages (competition/[id] and club/[id] use API)

**Existing API Endpoint (from Phase 2):**
- Route: `/api/stats/leaderboard`
- Auth: Bearer token required (CRON_SECRET)
- Rate limiting: 60 req/min
- Caching: 60s TTL with stale-while-revalidate=300
- Response structure: `{ data: models[], meta: { generatedAt, cached, filters } }`

**Reference Implementation (sub-pages already use API):**

`src/app/leaderboard/competition/[id]/page.tsx`:
```typescript
const response = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/stats/competition/${id}`, {
  headers: { 'Authorization': `Bearer ${process.env.CRON_SECRET}` },
  next: { revalidate: 60 },
});
const { data, meta } = await response.json();
const leaderboard = data.models;
```

**Desired State:**
Main leaderboard page should follow the same pattern as sub-pages:
1. Import and use `fetch` to call `/api/stats/leaderboard` endpoint
2. Add Bearer token authentication header
3. Include `next: { revalidate: 60 }` for ISR
4. Handle API response structure `{ data, meta }`
5. Extract `leaderboard = data.models`
6. Remove direct DB import and call
7. Add loading state if needed
8. Test that page still works correctly

</context>

<tasks>

<task type="auto">
  <name>Replace DB call with API call in main leaderboard</name>
  <files>src/app/leaderboard/page.tsx</files>
  <action>
  Update `src/app/leaderboard/page.tsx` to use API endpoint instead of direct database query:

  1. Remove direct DB import:
     - Delete: `import { getLeaderboard, type TimeRange } from '@/lib/db/queries'`

  2. Add fetch-based data fetching (similar to competition/[id]/page.tsx:44-52):
     ```typescript
     const response = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/stats/leaderboard?${params.toString()}`, {
       headers: { 'Authorization': `Bearer ${process.env.CRON_SECRET}` },
       next: { revalidate: 60 },
     });
     const { data, meta } = await response.json();
     const leaderboard = data.models;
     ```

  3. Update any references to `competitionId` parameter to pass via URL search params instead of function argument

  4. Keep existing LeaderboardFilters and LeaderboardTable components unchanged

  5. Ensure error handling exists (try/catch or use React error boundary)

  6. Verify imports: no remaining imports from '@/lib/db/queries' related to getLeaderboard
  </action>
  <verify>npm run build compiles successfully (no errors)</verify>
  <done>Main leaderboard page now calls `/api/stats/leaderboard` API endpoint with Bearer auth and ISR, removing direct DB dependency and enabling protection layers</done>
</task>

</tasks>

<verification>
1. Build completes without errors (`npm run build`)
2. No imports remain from '@/lib/db/queries' for getLeaderboard
3. Page contains fetch call to `/api/stats/leaderboard` with Bearer auth header
4. ISR revalidate=60 is specified in fetch options
5. Leaderboard data is extracted from `data.models` in API response
</verification>

<success_criteria>
- Main leaderboard uses API endpoint with authentication
- Rate limiting (60 req/min) is now applied
- Caching (60s TTL) is now utilized
- Consistent behavior with sub-pages
- Build and TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-ui/03-05-SUMMARY.md` documenting the API integration changes
</output>
