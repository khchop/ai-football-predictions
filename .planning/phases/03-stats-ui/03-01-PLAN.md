---
phase: 03-stats-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/leaderboard-table.tsx
  - src/lib/table/columns.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can sort leaderboard by any column"
    - "Sort state persists in URL for bookmarking"
    - "Mobile displays card layout, desktop displays table"
  artifacts:
    - path: "src/lib/table/columns.ts"
      provides: "TanStack Table column definitions"
      exports: ["leaderboardColumns"]
    - path: "src/components/leaderboard-table.tsx"
      provides: "Refactored table using TanStack Table"
      min_lines: 300
  key_links:
    - from: "src/components/leaderboard-table.tsx"
      to: "src/lib/table/columns.ts"
      via: "import leaderboardColumns"
      pattern: "import.*leaderboardColumns.*from.*table/columns"
    - from: "src/components/leaderboard-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable"
---

<objective>
Refactor existing leaderboard table to use TanStack Table v8 for maintainable column definitions and sorting logic.

Purpose: Current implementation has 460 lines with inline sorting. TanStack Table separates column definitions from rendering, making it easier to add columns and maintain sort logic. Existing functionality (URL state sync, mobile cards, rank icons, streak indicators) will be preserved.

Output: Leaderboard table with TanStack Table integration, column definitions extracted to separate file, all existing features working.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stats-ui/03-CONTEXT.md
@.planning/phases/03-stats-ui/03-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md

# Existing implementation to refactor
@src/components/leaderboard-table.tsx
@src/components/leaderboard-filters.tsx
</context>

<tasks>

<task type="auto">
  <name>Install TanStack Table v8</name>
  <files>package.json</files>
  <action>
    Install @tanstack/react-table v8:
    ```bash
    npm install @tanstack/react-table@8
    ```

    This is the standard headless table library recommended in research. Do NOT install react-loading-skeleton yet (deferred to Plan 03).
  </action>
  <verify>
    ```bash
    grep "@tanstack/react-table" package.json
    ```
    Should show version ^8.x.x in dependencies.
  </verify>
  <done>Package.json includes @tanstack/react-table v8 as dependency.</done>
</task>

<task type="auto">
  <name>Create column definitions file</name>
  <files>src/lib/table/columns.ts</files>
  <action>
    Create src/lib/table/columns.ts with TanStack Table column definitions for LeaderboardEntry:

    Columns to define (matching existing table):
    1. Rank (display column, not sortable) - show getRankIcon()
    2. Model (accessor: displayName, sortable) - link to /models/{modelId}
    3. Matches (accessor: totalPredictions, sortable)
    4. Correct (accessor: correctTendencies, sortable)
    5. Exact (accessor: exactScores, sortable)
    6. Points (accessor: totalPoints, sortable)
    7. Avg/Match (accessor: averagePoints, sortable, default sort desc)
    8. Accuracy (computed, sortable) - calculate (correctTendencies / totalPredictions) * 100
    9. Streak (display column) - show getStreakIndicator()

    Use createColumnHelper<LeaderboardEntry>() pattern from research.
    Import LeaderboardEntry type from existing component (re-export from this file).
    Cell renderers should match existing styling (trophy icons, color coding, etc.).

    DO NOT import React components (Link, icons) in column definitions - use render functions that accept these as parameters to avoid circular dependencies.
  </action>
  <verify>
    ```bash
    grep -E "(createColumnHelper|ColumnDef)" src/lib/table/columns.ts
    ```
    Should show TanStack Table imports and column array export.
  </verify>
  <done>Column definitions file exists with 9 columns matching existing table structure.</done>
</task>

<task type="auto">
  <name>Refactor leaderboard table to use TanStack Table</name>
  <files>src/components/leaderboard-table.tsx</files>
  <action>
    Refactor src/components/leaderboard-table.tsx to use TanStack Table while preserving ALL existing features:

    Changes:
    1. Import useReactTable, getCoreRowModel, getSortedRowModel from @tanstack/react-table
    2. Import leaderboardColumns from @/lib/table/columns
    3. Replace manual sorting logic with TanStack Table's getSortedRowModel()
    4. Keep URL state sync for sort column/order (existing logic works)
    5. Use table.getHeaderGroups() and table.getRowModel().rows for rendering
    6. Use flexRender for header and cell rendering
    7. Preserve all existing features:
       - getRankIcon() for top 3 positions
       - getStreakIndicator() for hot/cold streaks
       - getAccuracy() calculation
       - Mobile card view (unchanged, not using TanStack for mobile)
       - Desktop table hover states
       - Link to /models/{modelId}
       - Trophy/Medal/Award icons for ranks 1-3
       - Background colors for top 3 rows

    Keep mobile card view AS-IS (existing MobileCard component) - TanStack Table only used for desktop table.

    Memoize column definitions to prevent re-renders: const columns = useMemo(() => leaderboardColumns, [])

    Preserve existing empty state: "No predictions have been scored yet."
  </action>
  <verify>
    ```bash
    grep "useReactTable" src/components/leaderboard-table.tsx
    npm run build 2>&1 | grep -E "(error|Error)" | head -5
    ```
    First command should show TanStack Table hook usage.
    Second command should show no TypeScript errors (or only unrelated warnings).
  </verify>
  <done>Leaderboard table uses TanStack Table for desktop view, all features working, TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check:** `npm run build` completes without errors
2. **Import check:** TanStack Table appears in package.json dependencies
3. **File structure:** src/lib/table/columns.ts exists and exports leaderboardColumns
4. **Integration check:** grep "useReactTable" src/components/leaderboard-table.tsx returns matches
5. **Type safety:** No TypeScript errors related to column definitions or table rendering

Manual testing (user can verify in browser):
- Visit /leaderboard
- Click column headers to sort (URL updates with sort param)
- Refresh page with sort param - sort state preserved
- View on mobile (<768px) - card layout displays
- Top 3 ranks show trophy/medal/award icons
- Streak indicators display (flame for hot, snowflake for cold)
</verification>

<success_criteria>
- [ ] @tanstack/react-table v8 installed in package.json
- [ ] src/lib/table/columns.ts exists with 9 column definitions
- [ ] src/components/leaderboard-table.tsx uses useReactTable hook
- [ ] Desktop table renders using TanStack Table (flexRender)
- [ ] Mobile card view unchanged (not using TanStack)
- [ ] All existing features work: sorting, URL sync, icons, streak indicators
- [ ] npm run build completes without errors
- [ ] No TypeScript errors in leaderboard-table.tsx or columns.ts
</success_criteria>

<output>
After completion, create `.planning/phases/03-stats-ui/03-01-SUMMARY.md` with:
- Files modified
- TanStack Table integration approach
- Column definitions structure
- Any gotchas or edge cases handled
</output>
