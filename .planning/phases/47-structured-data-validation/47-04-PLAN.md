---
phase: 47-structured-data-validation
plan: 04
type: execute
wave: 2
depends_on: ["47-01", "47-02"]
files_modified:
  - scripts/audit-internal-links.ts
autonomous: true

must_haves:
  truths:
    - "Build-time audit catches duplicate Organization/WebSite schemas on any page"
    - "Build-time audit validates SportsEvent required properties (name, startDate, location)"
    - "Build-time audit validates Article required properties (headline, author, publisher with logo)"
    - "Build-time audit validates BreadcrumbList items all have 'item' property"
    - "Build-time audit reports total validation error count targeting <50"
  artifacts:
    - path: "scripts/audit-internal-links.ts"
      provides: "Pass 5 JSON-LD validation function"
      contains: "pass5JsonLdValidation"
  key_links:
    - from: "scripts/audit-internal-links.ts"
      to: "cheerio JSON-LD extraction"
      via: "script[type='application/ld+json'] selector"
      pattern: "application/ld\\+json"
    - from: "scripts/audit-internal-links.ts"
      to: "main runAudit function"
      via: "pass5 variable in aggregate results"
      pattern: "pass5.*failures"
---

<objective>
Add Pass 5 JSON-LD validation to the build-time audit script to prevent schema regressions.

Purpose: SCHEMA-05 requires validation errors reduced from 4365 to <50. A build-time Pass 5 extracts JSON-LD from sampled pages, checks for duplicate Organization/WebSite, validates required properties on SportsEvent/Article/FAQPage/BreadcrumbList, and fails the build if error count exceeds threshold. This catches regressions before deployment.

Output: Extended audit-internal-links.ts with Pass 5 function, integrated into main audit flow, with clear error reporting.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-structured-data-validation/47-RESEARCH.md
@scripts/audit-internal-links.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pass 5 JSON-LD validation function to audit script</name>
  <files>scripts/audit-internal-links.ts</files>
  <action>
Add the following to `scripts/audit-internal-links.ts`:

**1. Add Pass5Result interface** (after the existing Pass4Result interface):
```typescript
interface Pass5Result extends AuditResult {
  totalChecked: number;
  duplicateOrganization: number;
  duplicateWebSite: number;
  invalidSportsEvent: number;
  invalidArticle: number;
  invalidBreadcrumb: number;
  invalidFaq: number;
  totalSchemaErrors: number;
}
```

**2. Add helper functions** (before pass5 function):

```typescript
/**
 * Extract all JSON-LD schemas from HTML, flattening @graph arrays
 */
function extractAllSchemaTypes(html: string): { types: Map<string, number>; entities: Array<Record<string, unknown>> } {
  const $ = cheerio.load(html);
  const types = new Map<string, number>();
  const entities: Array<Record<string, unknown>> = [];

  $('script[type="application/ld+json"]').each((_, element) => {
    try {
      const content = $(element).html();
      if (!content) return;

      const parsed = JSON.parse(content);

      if (parsed['@graph'] && Array.isArray(parsed['@graph'])) {
        for (const item of parsed['@graph']) {
          if (item && typeof item === 'object' && item['@type']) {
            const type = String(item['@type']);
            types.set(type, (types.get(type) || 0) + 1);
            entities.push(item as Record<string, unknown>);
          }
        }
      } else if (parsed['@type']) {
        const type = String(parsed['@type']);
        types.set(type, (types.get(type) || 0) + 1);
        entities.push(parsed as Record<string, unknown>);
      }
    } catch {
      // Invalid JSON-LD - counted as error
    }
  });

  return { types, entities };
}

/**
 * Validate SportsEvent required properties per Google Rich Results
 */
function validateSportsEvent(entity: Record<string, unknown>): string[] {
  const errors: string[] = [];
  if (!entity.name) errors.push('SportsEvent missing name');
  if (!entity.startDate) errors.push('SportsEvent missing startDate');
  if (!entity.location) {
    errors.push('SportsEvent missing location');
  } else if (typeof entity.location === 'object' && entity.location !== null) {
    const loc = entity.location as Record<string, unknown>;
    if (loc['@type'] !== 'Place') errors.push('SportsEvent location not @type Place');
  }
  return errors;
}

/**
 * Validate Article required properties per Google Rich Results
 */
function validateArticle(entity: Record<string, unknown>): string[] {
  const errors: string[] = [];
  if (!entity.headline) errors.push('Article missing headline');
  if (!entity.author) errors.push('Article missing author');
  if (!entity.publisher) {
    errors.push('Article missing publisher');
  } else if (typeof entity.publisher === 'object' && entity.publisher !== null) {
    const pub = entity.publisher as Record<string, unknown>;
    // Publisher needs logo as ImageObject (unless it's an @id reference to root)
    if (!pub['@id'] && !pub.logo) {
      errors.push('Article publisher missing logo');
    } else if (pub.logo && typeof pub.logo === 'string') {
      errors.push('Article publisher.logo must be ImageObject, not string');
    }
  }
  return errors;
}

/**
 * Validate BreadcrumbList - all items must have 'item' property
 */
function validateBreadcrumbList(entity: Record<string, unknown>): string[] {
  const errors: string[] = [];
  const items = entity.itemListElement;
  if (!items || !Array.isArray(items)) {
    errors.push('BreadcrumbList missing itemListElement');
    return errors;
  }
  for (const listItem of items) {
    if (typeof listItem === 'object' && listItem !== null) {
      const item = listItem as Record<string, unknown>;
      if (!item.item) {
        errors.push(`BreadcrumbList position ${item.position || '?'} missing item URL`);
      }
    }
  }
  return errors;
}

/**
 * Validate FAQPage - minimum 2 questions recommended
 */
function validateFAQPage(entity: Record<string, unknown>): string[] {
  const errors: string[] = [];
  const questions = entity.mainEntity;
  if (!questions || !Array.isArray(questions)) {
    errors.push('FAQPage missing mainEntity');
    return errors;
  }
  if (questions.length < 2) {
    errors.push(`FAQPage has ${questions.length} question(s), recommend 2+`);
  }
  return errors;
}
```

**3. Add pass5JsonLdValidation function:**
```typescript
async function pass5JsonLdValidation(baseUrl: string): Promise<Pass5Result> {
  const result: Pass5Result = {
    pass: true,
    failures: [],
    warnings: [],
    totalChecked: 0,
    duplicateOrganization: 0,
    duplicateWebSite: 0,
    invalidSportsEvent: 0,
    invalidArticle: 0,
    invalidBreadcrumb: 0,
    invalidFaq: 0,
    totalSchemaErrors: 0,
  };

  try {
    // Reuse sitemap URL collection from Pass 4 pattern
    const indexUrl = `${baseUrl}/sitemap.xml`;
    const indexResponse = await fetch(indexUrl);
    if (!indexResponse.ok) {
      result.failures.push(`Failed to fetch sitemap index: ${indexResponse.status}`);
      result.pass = false;
      return result;
    }

    const indexXml = await indexResponse.text();
    const sitemapUrlMatches = indexXml.matchAll(/<loc>(.*?)<\/loc>/g);
    const sitemapUrls = Array.from(sitemapUrlMatches).map(m => m[1]);

    // Collect all page URLs from sub-sitemaps
    const allUrls: string[] = [];
    for (const sitemapUrl of sitemapUrls) {
      const response = await fetch(sitemapUrl);
      if (!response.ok) continue;
      const xml = await response.text();
      const urlMatches = xml.matchAll(/<loc>(.*?)<\/loc>/g);
      allUrls.push(...Array.from(urlMatches).map(m => m[1]));
    }

    // Sample URLs (reuse AUDIT_SAMPLE env var from Pass 4)
    const auditSample = process.env.AUDIT_SAMPLE ? parseInt(process.env.AUDIT_SAMPLE) : 50;
    const urlsToCheck = allUrls.length > auditSample
      ? allUrls.sort(() => Math.random() - 0.5).slice(0, auditSample)
      : allUrls;

    result.totalChecked = urlsToCheck.length;

    for (let i = 0; i < urlsToCheck.length; i++) {
      const url = urlsToCheck[i];

      if ((i + 1) % 10 === 0 || i === 0) {
        console.log(`  Checking ${i + 1}/${urlsToCheck.length}: ${url}`);
      }

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const response = await fetch(url, {
          signal: controller.signal,
          headers: { 'User-Agent': 'Kroam-Audit/1.0' },
        });
        clearTimeout(timeoutId);
        if (!response.ok) continue;

        const html = await response.text();
        const { types, entities } = extractAllSchemaTypes(html);

        // SCHEMA-01: Check for duplicate Organization/WebSite
        const orgCount = types.get('Organization') || 0;
        if (orgCount > 1) {
          result.duplicateOrganization++;
          result.totalSchemaErrors++;
          result.failures.push(`Duplicate Organization (${orgCount}x): ${url}`);
          result.pass = false;
        }

        const wsCount = types.get('WebSite') || 0;
        if (wsCount > 1) {
          result.duplicateWebSite++;
          result.totalSchemaErrors++;
          result.failures.push(`Duplicate WebSite (${wsCount}x): ${url}`);
          result.pass = false;
        }

        // SCHEMA-02: Validate SportsEvent
        for (const entity of entities) {
          if (entity['@type'] === 'SportsEvent') {
            const errors = validateSportsEvent(entity);
            if (errors.length > 0) {
              result.invalidSportsEvent++;
              result.totalSchemaErrors += errors.length;
              errors.forEach(e => result.failures.push(`${e}: ${url}`));
              result.pass = false;
            }
          }
        }

        // SCHEMA-03: Validate Article/NewsArticle
        for (const entity of entities) {
          if (entity['@type'] === 'Article' || entity['@type'] === 'NewsArticle') {
            const errors = validateArticle(entity);
            if (errors.length > 0) {
              result.invalidArticle++;
              result.totalSchemaErrors += errors.length;
              errors.forEach(e => result.failures.push(`${e}: ${url}`));
              result.pass = false;
            }
          }
        }

        // SCHEMA-04: Validate BreadcrumbList
        for (const entity of entities) {
          if (entity['@type'] === 'BreadcrumbList') {
            const errors = validateBreadcrumbList(entity);
            if (errors.length > 0) {
              result.invalidBreadcrumb++;
              result.totalSchemaErrors += errors.length;
              errors.forEach(e => result.failures.push(`${e}: ${url}`));
              result.pass = false;
            }
          }
        }

        // SCHEMA-03: Validate FAQPage (warn, not fail - Google recommends 2+)
        for (const entity of entities) {
          if (entity['@type'] === 'FAQPage') {
            const errors = validateFAQPage(entity);
            if (errors.length > 0) {
              result.invalidFaq++;
              // FAQ minimum questions is a warning, not failure
              errors.forEach(e => result.warnings.push(`${e}: ${url}`));
            }
          }
        }

      } catch (error) {
        if (error instanceof Error && error.name === 'AbortError') {
          result.warnings.push(`Timeout checking JSON-LD: ${url}`);
        }
      }
    }

  } catch (error) {
    result.failures.push(`Pass 5 error: ${error instanceof Error ? error.message : String(error)}`);
    result.pass = false;
  }

  return result;
}
```

**4. Integrate Pass 5 into main runAudit() function:**

After the Pass 4 section (around line 532), add:
```typescript
// Pass 5: JSON-LD Validation (only if AUDIT_BASE_URL is set)
let pass5: Pass5Result | null = null;
if (baseUrl) {
  console.log('Pass 5: JSON-LD Structured Data Validation');
  pass5 = await pass5JsonLdValidation(baseUrl);

  if (pass5.pass) {
    console.log(`  ✓ No duplicate Organization schemas (${pass5.totalChecked} pages checked)`);
    console.log(`  ✓ No duplicate WebSite schemas`);
    console.log(`  ✓ SportsEvent schemas valid`);
    console.log(`  ✓ Article schemas valid`);
    console.log(`  ✓ BreadcrumbList schemas valid`);
    console.log(`  ✓ Total schema errors: ${pass5.totalSchemaErrors}`);
  } else {
    pass5.failures.forEach(f => console.log(`  ✗ ${f}`));
  }

  pass5.warnings.forEach(w => console.log(`  ⚠ ${w}`));
  console.log('');
} else {
  console.log('Pass 5: SKIPPED (set AUDIT_BASE_URL to run JSON-LD validation)\n');
}
```

**5. Add pass5 to aggregate results:**
Update the allFailures and allWarnings arrays to include pass5:
```typescript
const allFailures = [
  ...(pass1?.failures || []),
  ...pass2.failures,
  ...pass3.failures,
  ...(pass4?.failures || []),
  ...(pass5?.failures || []),
];

const allWarnings = [
  ...(pass1?.warnings || []),
  ...pass2.warnings,
  ...pass3.warnings,
  ...(pass4?.warnings || []),
  ...(pass5?.warnings || []),
];
```

**6. Update the script header comment** to include Pass 5 in the list.
  </action>
  <verify>
1. `npx tsc --noEmit scripts/audit-internal-links.ts` compiles (or build passes)
2. `grep 'pass5JsonLdValidation' scripts/audit-internal-links.ts` returns matches
3. `grep 'Pass 5' scripts/audit-internal-links.ts` returns matches
4. `grep 'duplicateOrganization' scripts/audit-internal-links.ts` returns matches
5. `grep 'validateSportsEvent' scripts/audit-internal-links.ts` returns matches
6. `grep 'validateBreadcrumbList' scripts/audit-internal-links.ts` returns matches
7. If AUDIT_BASE_URL is set and site is running, `npx tsx scripts/audit-internal-links.ts` runs Pass 5 successfully
  </verify>
  <done>Pass 5 JSON-LD validation added to audit script. Checks for duplicate Organization/WebSite, validates SportsEvent/Article/BreadcrumbList/FAQPage required properties. Integrated into aggregate pass/fail logic. Reports totalSchemaErrors count.</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Audit script has Pass 5 function and integration
3. Pass 5 validates all 5 SCHEMA requirements:
   - SCHEMA-01: Duplicate Organization/WebSite detection
   - SCHEMA-02: SportsEvent property validation
   - SCHEMA-03: Article/FAQPage property validation
   - SCHEMA-04: BreadcrumbList item property validation
   - SCHEMA-05: Total error count tracking
4. Pass 5 only runs when AUDIT_BASE_URL is set (consistent with Pass 1 and Pass 4)
5. FAQPage minimum questions is a warning (not build failure)
</verification>

<success_criteria>
- SCHEMA-05 addressed: Build-time validation catches schema errors, targeting <50 total
- All 5 schema requirements have corresponding validation checks
- Audit script compiles and runs without errors
- Pass 5 integrated into aggregate pass/fail logic
</success_criteria>

<output>
After completion, create `.planning/phases/47-structured-data-validation/47-04-SUMMARY.md`
</output>
