---
phase: 47-structured-data-validation
plan: 03
type: execute
wave: 2
depends_on: ["47-01", "47-02"]
files_modified:
  - src/components/WebPageSchema.tsx
  - src/components/SportsEventSchema.tsx
  - src/components/FaqSchema.tsx
  - src/app/models/[id]/page.tsx
  - src/app/leaderboard/page.tsx
  - src/app/blog/[slug]/page.tsx
  - src/app/leagues/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "No page renders multiple separate JSON-LD scripts for the same conceptual entity"
    - "All pages use @id references for Organization and WebSite (not inline duplicates)"
    - "BreadcrumbList schema is valid on all page types (all items have 'item' property)"
    - "Model, leaderboard, blog, and league pages use consolidated @graph or minimal JSON-LD"
  artifacts:
    - path: "src/components/WebPageSchema.tsx"
      provides: "WebPage schema component using @id reference for WebSite"
      contains: "WEBSITE_ID"
    - path: "src/app/models/[id]/page.tsx"
      provides: "Model page with consolidated single @graph"
      contains: "@graph"
    - path: "src/app/leaderboard/page.tsx"
      provides: "Leaderboard page with consolidated single @graph"
      contains: "@graph"
  key_links:
    - from: "src/components/WebPageSchema.tsx"
      to: "src/lib/seo/schema/root.ts"
      via: "import WEBSITE_ID"
      pattern: "WEBSITE_ID"
    - from: "src/app/models/[id]/page.tsx"
      to: "src/lib/seo/schema/root.ts"
      via: "@id references in consolidated @graph"
      pattern: "ORGANIZATION_ID|WEBSITE_ID"
---

<objective>
Consolidate all remaining page-level schema rendering to use @id references and single @graph patterns, eliminating duplicate entities across the site.

Purpose: SCHEMA-01 (no duplicates) and SCHEMA-04 (valid BreadcrumbList on all pages) require every page to reference root entities via @id instead of rendering inline copies. Currently model, leaderboard, blog, and league pages render multiple separate JSON-LD scripts and inline WebSite/Organization objects.

Output: All page types use consolidated @graph patterns with @id cross-references. WebPageSchema component updated to use WEBSITE_ID. No page renders duplicate Organization or WebSite entities.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-structured-data-validation/47-RESEARCH.md
@.planning/phases/47-structured-data-validation/47-01-SUMMARY.md
@src/components/WebPageSchema.tsx
@src/components/SportsEventSchema.tsx
@src/components/FaqSchema.tsx
@src/app/models/[id]/page.tsx
@src/app/leaderboard/page.tsx
@src/app/blog/[slug]/page.tsx
@src/app/leagues/[slug]/page.tsx
@src/lib/seo/schema/root.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema components to use @id references</name>
  <files>src/components/WebPageSchema.tsx, src/components/SportsEventSchema.tsx, src/components/FaqSchema.tsx</files>
  <action>
**WebPageSchema.tsx changes:**

1. Import `WEBSITE_ID` from `@/lib/seo/schema/root`
2. Replace the inline `isPartOf` WebSite object (lines 44-48):
   ```typescript
   // BEFORE:
   "isPartOf": {
     "@type": "WebSite",
     "name": "kroam.xyz",
     "url": "https://kroam.xyz",
   },

   // AFTER:
   "isPartOf": { "@id": WEBSITE_ID },
   ```
   This eliminates a duplicate WebSite entity on every page that uses WebPageSchema.

3. Keep the breadcrumb rendering as-is (it's valid BreadcrumbList with item on all positions including last - SCHEMA-04 compliant).

**SportsEventSchema.tsx changes:**

This standalone component renders a separate `<script type="application/ld+json">` with its own @context. It's a simpler version of what MatchPageSchema.tsx does. Check if it's still used anywhere:

1. Search for imports of SportsEventSchema in the codebase
2. If NOT imported anywhere (likely superseded by MatchPageSchema.tsx), mark it as deprecated with a comment but don't delete (to avoid breaking potential dynamic imports)
3. If still imported somewhere, update its location to include `address` property and fix EventStatus mapping to match the corrected sports-event.ts pattern

**FaqSchema.tsx changes:**

1. The FaqSchema component is simple and correct - it calls `generateFAQPageSchema()` and renders a JSON-LD script. No changes needed for validation.
2. However, add a guard for minimum 2 questions per Google recommendation:
   ```typescript
   export function FaqSchema({ faqs }: FaqSchemaProps) {
     // Google recommends minimum 2 questions for FAQ rich results
     if (!faqs || faqs.length < 2) {
       return null;
     }
     // ... rest unchanged
   }
   ```
   This changes the threshold from `faqs.length === 0` to `faqs.length < 2`.
  </action>
  <verify>
1. `npx tsc --noEmit src/components/WebPageSchema.tsx` compiles
2. `grep 'WEBSITE_ID' src/components/WebPageSchema.tsx` returns a match
3. `grep '"WebSite"' src/components/WebPageSchema.tsx` returns NO matches (inline WebSite removed)
4. `grep 'length < 2' src/components/FaqSchema.tsx` returns a match (min 2 questions guard)
  </verify>
  <done>WebPageSchema uses WEBSITE_ID reference instead of inline WebSite. FaqSchema requires minimum 2 FAQs. SportsEventSchema either deprecated or updated.</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate page-level JSON-LD on model, leaderboard, blog, and league pages</name>
  <files>src/app/models/[id]/page.tsx, src/app/leaderboard/page.tsx, src/app/blog/[slug]/page.tsx, src/app/leagues/[slug]/page.tsx</files>
  <action>
**models/[id]/page.tsx changes:**

Currently renders TWO separate JSON-LD scripts:
1. An @graph containing only breadcrumbs (line 176-178)
2. A WebPageSchema component (line 180-189) that renders a SEPARATE JSON-LD script with inline WebSite

Consolidate into a single @graph:
1. Import `WEBSITE_ID` from `@/lib/seo/schema/root`
2. Build a single @graph combining the WebPage and BreadcrumbList:
   ```typescript
   const schema = {
     '@context': 'https://schema.org',
     '@graph': [
       {
         '@type': 'WebPage',
         '@id': `${BASE_URL}/models/${id}#webpage`,
         url: `${BASE_URL}/models/${id}`,
         name: `${model.displayName} - AI Football Prediction Model`,
         description: `...`,
         isPartOf: { '@id': WEBSITE_ID },
       },
       breadcrumbs,
     ],
   };
   ```
3. Remove the `<WebPageSchema>` component usage
4. Keep the single `<script type="application/ld+json">` rendering the consolidated schema

**leaderboard/page.tsx changes:**

Currently renders TWO separate JSON-LD scripts:
1. FAQPage schema (line 132-137)
2. BreadcrumbList @graph (line 191-194)

Consolidate into a single @graph:
1. Build combined schema with BreadcrumbList, FAQPage, and optionally WebPage:
   ```typescript
   const schema = {
     '@context': 'https://schema.org',
     '@graph': [breadcrumbs, faqSchema],
   };
   ```
   Note: `faqSchema` from `generateFAQPageSchema()` has its own `@context` - strip it before adding to @graph. Either call the generator and remove `@context`, or build FAQ inline.
2. Remove the first separate JSON-LD script for FAQ
3. Render single `<script type="application/ld+json">` in one location

**blog/[slug]/page.tsx changes:**

Currently uses `buildRoundupSchema()` for roundup posts (which already builds @graph) and `generateArticleSchema()` + `WebPageSchema` for other posts. Fix:
1. For non-roundup posts: consolidate article schema and breadcrumbs into a single @graph instead of separate scripts. Remove `<WebPageSchema>` component usage and build WebPage inline in the @graph.
2. For roundup posts: `buildRoundupSchema()` already uses @graph - this was fixed in Plan 02 to use @id references. Just ensure the page doesn't ALSO render WebPageSchema alongside it.
3. Import `WEBSITE_ID` from `@/lib/seo/schema/root` for WebPage.isPartOf reference.

**leagues/[slug]/page.tsx changes:**

Currently renders a single @graph with competitionSchema, breadcrumbs, faqSchema (line 174-177). This is already a good pattern. Fix:
1. The `faqSchema` from `generateFAQPageSchema()` includes `@context` property which is wrong inside an @graph. Strip the `@context` from faqSchema before adding to @graph, or destructure: `const { '@context': _, ...faqSchemaClean } = faqSchema;`
2. Verify breadcrumbs include `item` property on ALL positions including last (already correct per breadcrumb.ts line 14).

**Common pattern for stripping @context:**
When using `generateFAQPageSchema()` or `generateBreadcrumbSchema()` inside an @graph, the returned objects have `@context: 'https://schema.org'` which must be removed since the parent @graph already provides `@context`. Create a small helper or use destructuring:
```typescript
function stripContext(schema: Record<string, unknown>): Record<string, unknown> {
  const { '@context': _, ...rest } = schema;
  return rest;
}
```
Put this in `src/lib/seo/schema/root.ts` (already created by Plan 01) as an exported utility.

Wait - root.ts is from Plan 01 which this depends on. But adding to root.ts would be a file conflict with Plan 01. Instead, add this utility inline in the pages that need it, or better, add it to schemas.ts. Actually, just use destructuring inline - it's a one-liner.
  </action>
  <verify>
1. `npm run build` succeeds (or `npx next build --webpack` as fallback)
2. For each modified page, count JSON-LD scripts:
   - `grep -c 'application/ld+json' src/app/models/\[id\]/page.tsx` returns 1
   - `grep -c 'application/ld+json' src/app/leaderboard/page.tsx` returns 1
   - `grep -c 'application/ld+json' src/app/leagues/\[slug\]/page.tsx` returns 1
3. `grep 'WebPageSchema' src/app/models/\[id\]/page.tsx` returns only the import (if kept) or no matches
4. No page has inline `"@type": "WebSite"` or `"@type": "Organization"` objects (only @id references)
  </verify>
  <done>Model page has 1 JSON-LD script (not 2). Leaderboard page has 1 JSON-LD script (not 2). Blog page uses consolidated @graph. League page @graph has no nested @context. All use @id references for Organization/WebSite.</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Every page type renders at most 1 JSON-LD `<script>` tag (plus root layout's 1)
3. No page renders inline Organization or WebSite objects (only @id references)
4. BreadcrumbList on all pages has `item` property on every position
5. FAQPage only renders when 2+ questions exist
6. No nested `@context` inside @graph arrays
</verification>

<success_criteria>
- SCHEMA-01 fully resolved: No duplicate Organization or WebSite on any page
- SCHEMA-04 addressed: BreadcrumbList valid on all page types
- Page-level JSON-LD consolidated from multiple scripts to single @graph per page
- WebPageSchema component uses @id reference instead of inline WebSite
</success_criteria>

<output>
After completion, create `.planning/phases/47-structured-data-validation/47-03-SUMMARY.md`
</output>
