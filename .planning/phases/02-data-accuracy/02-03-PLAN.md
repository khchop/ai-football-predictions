---
phase: 02-data-accuracy
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/queries.ts
  - src/lib/queue/workers/scoring.worker.ts
autonomous: true

must_haves:
  truths:
    - "Model streaks correctly reset on wrong predictions"
    - "Model streaks ignore voided matches (no change)"
    - "Model streaks ignore cancelled matches (no change)"
    - "Model streaks ignore postponed matches (no change)"
    - "Draws are handled correctly in streak calculation"
  artifacts:
    - path: "src/lib/db/queries.ts"
      provides: "Streak update with match status validation"
      contains: "shouldUpdateStreak"
  key_links:
    - from: "src/lib/queue/workers/scoring.worker.ts"
      to: "src/lib/db/queries.ts"
      via: "streak update with match status check"
      pattern: "shouldUpdateStreak|status.*finished"
---

<objective>
Fix streak tracking to correctly handle edge cases: voided matches, cancelled matches, postponed matches, and ensure draws are processed correctly.

Purpose: Prevent streak corruption where models incorrectly lose streaks due to voided/cancelled matches, or where draws cause unexpected streak behavior.

Output: Robust streak tracking that only updates for valid finished matches with real outcomes.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-accuracy/02-RESEARCH.md

@src/lib/db/queries.ts
@src/lib/queue/workers/scoring.worker.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shouldUpdateStreak validation function</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add a validation function that determines whether a match result should affect model streaks:

```typescript
/**
 * Determine if a match result should update model streaks
 *
 * Rules:
 * - Only finished matches with valid scores count
 * - Voided, cancelled, postponed matches do NOT affect streaks
 * - Predictions with 'void' status do NOT affect streaks
 */
export function shouldUpdateStreak(
  matchStatus: string,
  homeScore: number | null,
  awayScore: number | null,
  predictionStatus: string
): boolean {
  // Only finished matches count
  if (matchStatus !== 'finished') {
    return false;
  }

  // Must have valid scores
  if (homeScore === null || awayScore === null) {
    return false;
  }

  // Voided predictions don't count
  if (predictionStatus === 'void') {
    return false;
  }

  // Valid match with valid prediction - update streak
  return true;
}
```

Place this function near the `updateModelStreak` function for logical grouping.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit src/lib/db/queries.ts`
2. Function exists: `grep -n "shouldUpdateStreak" src/lib/db/queries.ts`
  </verify>
  <done>
`shouldUpdateStreak` function exists in queries.ts with proper validation logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Update scoring worker to use shouldUpdateStreak</name>
  <files>src/lib/queue/workers/scoring.worker.ts</files>
  <action>
Modify the scoring worker to check `shouldUpdateStreak` before calling streak update:

1. Import the function:
```typescript
import {
  // ... existing imports ...
  shouldUpdateStreak,
} from '@/lib/db/queries';
```

2. In the streak update section (after scoring predictions), wrap the call:

```typescript
// Update model streak based on result type
// Only if match status and prediction are valid for streak tracking
if (shouldUpdateStreak(match.status, actualHome, actualAway, prediction.status)) {
  let resultType: 'exact' | 'tendency' | 'wrong' = 'wrong';
  if (breakdown.total > 0) {
    if (breakdown.exactScoreBonus > 0) {
      resultType = 'exact';
    } else {
      resultType = 'tendency';
    }
  }

  try {
    await updateModelStreak(prediction.modelId, resultType);
  } catch (streakError: any) {
    log.warn({
      modelId: prediction.modelId,
      resultType,
      error: streakError.message,
    }, 'Failed to update model streak (prediction was scored successfully)');
  }
} else {
  log.debug({
    modelId: prediction.modelId,
    matchStatus: match.status,
    predictionStatus: prediction.status,
  }, 'Skipping streak update - match/prediction not valid for streak tracking');
}
```

3. Add logging for skipped streak updates to aid debugging
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit src/lib/queue/workers/scoring.worker.ts`
2. Check is in place: `grep "shouldUpdateStreak" src/lib/queue/workers/scoring.worker.ts`
  </verify>
  <done>
Scoring worker checks `shouldUpdateStreak` before updating model streak
  </done>
</task>

<task type="auto">
  <name>Task 3: Add row-level locking to updateModelStreak</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Update the existing `updateModelStreak` function to use FOR UPDATE locking to prevent lost updates during concurrent scoring:

Find the `updateModelStreak` function (around line 620) and modify the select query to include FOR UPDATE:

```typescript
// Change from:
const modelResult = await tx
  .select()
  .from(models)
  .where(eq(models.id, modelId))
  .limit(1);

// To:
const modelResult = await tx
  .select()
  .from(models)
  .where(eq(models.id, modelId))
  .for('update')  // Add row-level lock
  .limit(1);
```

This ensures that when multiple predictions for the same model are scored concurrently, streak updates are serialized and no updates are lost.

The transaction already exists in this function, we just need to add the locking.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit src/lib/db/queries.ts`
2. Lock is present: `grep -A 5 "updateModelStreak" src/lib/db/queries.ts | grep "for.*update"`
  </verify>
  <done>
`updateModelStreak` uses FOR UPDATE row lock to prevent concurrent update conflicts
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Validation function exists:**
```bash
grep -A 15 "shouldUpdateStreak" src/lib/db/queries.ts
```

2. **Worker uses validation:**
```bash
grep "shouldUpdateStreak" src/lib/queue/workers/scoring.worker.ts
```

3. **Row locking in place:**
```bash
grep -B 3 -A 3 "for.*'update'" src/lib/db/queries.ts | grep -A 3 "updateModelStreak"
```

4. **Build passes:**
```bash
npm run build
```
</verification>

<success_criteria>
- `shouldUpdateStreak` function validates match status (finished), scores (not null), and prediction status (not void)
- Scoring worker calls `shouldUpdateStreak` before `updateModelStreak`
- `updateModelStreak` uses FOR UPDATE lock on model row
- Voided/cancelled/postponed matches do not affect streaks
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-accuracy/02-03-SUMMARY.md`
</output>
