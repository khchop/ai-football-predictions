---
phase: 02-data-accuracy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/utils/scoring.ts
autonomous: true

must_haves:
  truths:
    - "Quota points match Kicktipp standard formula (2-6 points based on prediction rarity)"
    - "Rare correct predictions earn more points (up to 6)"
    - "Common correct predictions earn fewer points (minimum 2)"
    - "Unpredicted outcomes award maximum quota (6 points)"
  artifacts:
    - path: "src/lib/utils/scoring.ts"
      provides: "Kicktipp-accurate quota calculation"
      contains: "MAX_QUOTA / (10 * P)"
  key_links:
    - from: "src/lib/utils/scoring.ts"
      to: "src/lib/queue/workers/scoring.worker.ts"
      via: "calculateQuotas called during settlement"
      pattern: "calculateQuotas"
---

<objective>
Correct the quota calculation formula to match Kicktipp's documented standard formula: `Points = (MAX / (10 * P)) - (MAX / 10) + MIN`, where P = predictions_for_tendency / total_predictions.

Purpose: Ensure quota points accurately reward rare predictions and penalize consensus predictions per the Kicktipp system, which is the documented scoring methodology for this platform.

Output: Corrected `calculateQuotas` function that produces accurate 2-6 point quotas.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-accuracy/02-RESEARCH.md

@src/lib/utils/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix calculateQuotas to use Kicktipp formula</name>
  <files>src/lib/utils/scoring.ts</files>
  <action>
Update the `calculateQuotas` function (around lines 88-122) to use the correct Kicktipp formula:

**Current (incorrect) formula:**
```typescript
// Wrong: rawQuota = total / count
const rawHomeQuota = homeCount > 0 ? total / homeCount : MAX_QUOTA;
```

**Correct Kicktipp formula:**
```typescript
// Kicktipp: Points = (MAX / (10 * P)) - (MAX / 10) + MIN
// Where P = count / total (proportion of predictions for that tendency)

function computeQuotaKicktipp(count: number, total: number): number {
  if (count === 0) return MAX_QUOTA; // Unpredicted outcome = max points

  const P = count / total;  // Proportion
  const rawQuota = (MAX_QUOTA / (10 * P)) - (MAX_QUOTA / 10) + MIN_QUOTA;

  // Clamp to [MIN_QUOTA, MAX_QUOTA] and round to nearest integer
  return Math.round(Math.min(MAX_QUOTA, Math.max(MIN_QUOTA, rawQuota)));
}
```

Replace the existing `calculateQuotas` function body with:

```typescript
export function calculateQuotas(
  predictions: Array<{ predictedHome: number; predictedAway: number }>
): QuotaResult {
  const total = predictions.length;

  if (total === 0) {
    // Default quotas if no predictions
    return { home: MIN_QUOTA, draw: MIN_QUOTA, away: MIN_QUOTA };
  }

  // Count predictions by tendency
  let homeCount = 0;
  let drawCount = 0;
  let awayCount = 0;

  for (const pred of predictions) {
    const result = getResult(pred.predictedHome, pred.predictedAway);
    if (result === 'H') homeCount++;
    else if (result === 'D') drawCount++;
    else awayCount++;
  }

  // Kicktipp formula: Points = (MAX / (10 * P)) - (MAX / 10) + MIN
  // Where P = predictions_for_tendency / total_predictions
  function computeQuota(count: number): number {
    if (count === 0) return MAX_QUOTA; // Max points for unpredicted outcome

    const P = count / total;
    const rawQuota = (MAX_QUOTA / (10 * P)) - (MAX_QUOTA / 10) + MIN_QUOTA;

    // Clamp then round (per research recommendation)
    return Math.round(Math.min(MAX_QUOTA, Math.max(MIN_QUOTA, rawQuota)));
  }

  return {
    home: computeQuota(homeCount),
    draw: computeQuota(drawCount),
    away: computeQuota(awayCount),
  };
}
```

**Key changes:**
1. Formula changed from `total / count` to `(MAX / (10 * P)) - (MAX / 10) + MIN`
2. P is now `count / total` (proportion) not `total / count` (inverse ratio)
3. Round AFTER clamping to MIN/MAX
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit src/lib/utils/scoring.ts`
2. Formula present: `grep "10 \* P" src/lib/utils/scoring.ts`
  </verify>
  <done>
`calculateQuotas` function uses correct Kicktipp formula with P = count/total
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for quota calculation edge cases</name>
  <files>src/lib/utils/__tests__/scoring.test.ts</files>
  <action>
Create a test file to verify quota calculation correctness:

```typescript
import { describe, test, expect } from 'vitest';
import { calculateQuotas } from '../scoring';

describe('calculateQuotas - Kicktipp formula', () => {
  test('returns MIN_QUOTA for all tendencies when empty', () => {
    const result = calculateQuotas([]);
    expect(result).toEqual({ home: 2, draw: 2, away: 2 });
  });

  test('returns MAX_QUOTA for unpredicted outcomes', () => {
    // All 10 predictions are home wins - draw and away get max quota
    const predictions = Array(10).fill({ predictedHome: 2, predictedAway: 1 });
    const result = calculateQuotas(predictions);

    expect(result.home).toBe(2); // All predicted home = low quota
    expect(result.draw).toBe(6); // None predicted draw = max quota
    expect(result.away).toBe(6); // None predicted away = max quota
  });

  test('evenly distributed predictions get mid-range quotas', () => {
    // 10 home, 10 draw, 10 away = 33% each
    const predictions = [
      ...Array(10).fill({ predictedHome: 2, predictedAway: 1 }), // Home wins
      ...Array(10).fill({ predictedHome: 1, predictedAway: 1 }), // Draws
      ...Array(10).fill({ predictedHome: 1, predictedAway: 2 }), // Away wins
    ];
    const result = calculateQuotas(predictions);

    // With P = 0.33, rawQuota = (6 / (10 * 0.33)) - (6/10) + 2 = 1.82 - 0.6 + 2 = 3.22
    // Clamped and rounded = 3
    expect(result.home).toBe(3);
    expect(result.draw).toBe(3);
    expect(result.away).toBe(3);
  });

  test('rare predictions get higher quotas', () => {
    // 28 home, 1 draw, 1 away
    const predictions = [
      ...Array(28).fill({ predictedHome: 2, predictedAway: 1 }), // Home wins
      { predictedHome: 1, predictedAway: 1 }, // 1 draw
      { predictedHome: 1, predictedAway: 2 }, // 1 away
    ];
    const result = calculateQuotas(predictions);

    // Home: P = 28/30 = 0.93, quota = (6 / (10 * 0.93)) - 0.6 + 2 = 0.65 - 0.6 + 2 = 2.05 -> 2
    expect(result.home).toBe(2);
    // Draw/Away: P = 1/30 = 0.033, quota = (6 / (10 * 0.033)) - 0.6 + 2 = 18.18 - 0.6 + 2 = 19.58 -> clamped to 6
    expect(result.draw).toBe(6);
    expect(result.away).toBe(6);
  });

  test('quotas are always between MIN (2) and MAX (6)', () => {
    // Test with various distributions
    const distributions = [
      Array(35).fill({ predictedHome: 2, predictedAway: 1 }), // All home
      Array(1).fill({ predictedHome: 2, predictedAway: 1 }),  // Single prediction
      [
        ...Array(20).fill({ predictedHome: 2, predictedAway: 1 }),
        ...Array(10).fill({ predictedHome: 1, predictedAway: 1 }),
        ...Array(5).fill({ predictedHome: 1, predictedAway: 2 }),
      ],
    ];

    for (const predictions of distributions) {
      const result = calculateQuotas(predictions);
      expect(result.home).toBeGreaterThanOrEqual(2);
      expect(result.home).toBeLessThanOrEqual(6);
      expect(result.draw).toBeGreaterThanOrEqual(2);
      expect(result.draw).toBeLessThanOrEqual(6);
      expect(result.away).toBeGreaterThanOrEqual(2);
      expect(result.away).toBeLessThanOrEqual(6);
    }
  });
});
```

Create the test directory if it doesn't exist: `mkdir -p src/lib/utils/__tests__`
  </action>
  <verify>
1. Test file exists: `ls src/lib/utils/__tests__/scoring.test.ts`
2. Tests pass: `npx vitest run src/lib/utils/__tests__/scoring.test.ts`
  </verify>
  <done>
Unit tests for quota calculation exist and pass, verifying Kicktipp formula edge cases
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Formula verification:**
```bash
grep -A 3 "Kicktipp formula" src/lib/utils/scoring.ts
# Should show: (MAX_QUOTA / (10 * P)) - (MAX_QUOTA / 10) + MIN_QUOTA
```

2. **Tests pass:**
```bash
npx vitest run src/lib/utils/__tests__/scoring.test.ts
```

3. **Build passes:**
```bash
npm run build
```
</verification>

<success_criteria>
- `calculateQuotas` uses formula: `(MAX / (10 * P)) - (MAX / 10) + MIN`
- P is calculated as `count / total` (proportion)
- Quotas are always clamped to [2, 6] range
- Unit tests pass verifying edge cases
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-accuracy/02-02-SUMMARY.md`
</output>
