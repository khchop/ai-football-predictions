---
phase: 46-content-tags-meta-optimization
plan: 03
type: execute
wave: 2
depends_on: ["46-01", "46-02"]
files_modified:
  - src/app/leagues/page.tsx
  - src/app/models/page.tsx
  - scripts/audit-internal-links.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "/leagues page has CollectionPage structured data with ItemList of all 17 leagues"
    - "/models page has CollectionPage structured data with ItemList of all active models"
    - "Build-time audit validates title tags, meta descriptions, H1 count, and OG completeness"
    - "Build fails if meta tag violations exist (title >60, desc <100 or >160, H1 != 1)"
  artifacts:
    - path: "scripts/audit-internal-links.ts"
      provides: "Pass 4: Meta tag validation using cheerio"
      contains: "pass4MetaTagValidation"
    - path: "src/app/leagues/page.tsx"
      provides: "CollectionPage JSON-LD structured data"
      contains: "CollectionPage"
    - path: "src/app/models/page.tsx"
      provides: "CollectionPage JSON-LD structured data"
      contains: "CollectionPage"
  key_links:
    - from: "scripts/audit-internal-links.ts"
      to: "cheerio"
      via: "import for HTML parsing"
      pattern: "cheerio"
    - from: "src/app/leagues/page.tsx"
      to: "schema.org"
      via: "JSON-LD script tag"
      pattern: "application/ld\\+json"
---

<objective>
Add CollectionPage structured data to /leagues and /models index pages, and extend the build-time audit script with a meta tag validation pass.

Purpose: INDEX-05 and INDEX-06 require CollectionPage structured data for discovery by search engines. The build-time audit (Pass 4) creates a safety net ensuring meta tag regressions from Plan 01 don't reach production. Cheerio parses rendered HTML to validate title length, description length, H1 count, and OG tag completeness.

Output: Structured data on two index pages + extended audit script with Pass 4.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-content-tags-meta-optimization/46-CONTEXT.md
@.planning/phases/46-content-tags-meta-optimization/46-RESEARCH.md
@scripts/audit-internal-links.ts
@src/app/leagues/page.tsx
@src/app/models/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CollectionPage structured data to /leagues and /models index pages</name>
  <files>
    src/app/leagues/page.tsx
    src/app/models/page.tsx
  </files>
  <action>
**src/app/leagues/page.tsx:**

Add a `<script type="application/ld+json">` tag with CollectionPage schema inside the page component's return JSX (before the main content). The schema uses the three-tier hierarchy: CollectionPage -> ItemList -> ListItem.

```typescript
// Build inside LeaguesPage component body (before return)
const allCompetitions = [
  ...getCompetitionsByCategory('club-europe'),
  ...getCompetitionsByCategory('club-domestic'),
  ...getCompetitionsByCategory('international'),
];

const collectionPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Football League AI Predictions',
  description: 'AI predictions across 17 major football competitions including Champions League, Premier League, La Liga, and more.',
  url: 'https://kroam.xyz/leagues',
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: allCompetitions.length,
    itemListElement: allCompetitions.map((comp, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      item: {
        '@type': 'SportsOrganization',
        name: comp.name,
        url: `https://kroam.xyz/leagues/${comp.id}`,
        description: `AI predictions for ${comp.name}`,
        sport: 'Football',
      },
    })),
  },
};
```

Add the JSON-LD script tag as the FIRST child inside the return's root `<div>`:
```tsx
<script
  type="application/ld+json"
  dangerouslySetInnerHTML={{ __html: JSON.stringify(collectionPageSchema) }}
/>
```

Use `SportsOrganization` as the item type (leagues are sports organizations, more semantic than `Thing`).

**src/app/models/page.tsx:**

Add CollectionPage schema similarly. This page uses `generateMetadata` and fetches `leaderboard` data. Build the schema from the leaderboard data already fetched.

```typescript
// Build inside ModelsPage component body (after leaderboard fetch)
const collectionPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'AI Model Football Predictions',
  description: `${modelCount} open-source AI models compete to predict football matches across 17 competitions.`,
  url: 'https://kroam.xyz/models',
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: leaderboard.length,
    itemListElement: leaderboard.map((model, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      item: {
        '@type': 'SoftwareApplication',
        name: model.displayName,
        url: `https://kroam.xyz/models/${model.modelId}`,
        description: `${model.displayName} AI football prediction model`,
        applicationCategory: 'SportsApplication',
        operatingSystem: 'Web',
      },
    })),
  },
};
```

Use `SoftwareApplication` for AI models (more semantic than `Thing`, signals computational tools to search engines).

Add the JSON-LD script tag in BOTH the empty state and the main content branches (so the schema is always present, even with 0 models -- though the ItemList will be empty).

**Important:** These pages were already modified by Plan 01 (metadata/H1 changes). This plan builds on top of those changes -- it only ADDS the structured data script tags, it does not re-modify metadata or H1 tags.
  </action>
  <verify>
Start dev server. Visit /leagues and /models. View page source and search for `"CollectionPage"` to confirm structured data is present. Validate the JSON-LD is parseable by pasting into Google's Rich Results Test (https://search.google.com/test/rich-results) or Schema.org validator.
  </verify>
  <done>
/leagues page has CollectionPage structured data listing all 17 leagues. /models page has CollectionPage structured data listing all active models as SoftwareApplication items. Both use three-tier hierarchy (CollectionPage -> ItemList -> ListItem).
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend build-time audit with Pass 4 meta tag validation</name>
  <files>
    scripts/audit-internal-links.ts
    package.json
  </files>
  <action>
**Install cheerio:**
```bash
npm install cheerio
```

**Extend scripts/audit-internal-links.ts:**

Add a new Pass 4 function `pass4MetaTagValidation` that fetches rendered HTML pages and validates meta tags using cheerio. This pass ONLY runs when `AUDIT_BASE_URL` is set (same as Pass 1), since it needs to fetch live pages.

Add interface:
```typescript
interface Pass4Result extends AuditResult {
  totalChecked: number;
  titleViolations: number;
  descriptionViolations: number;
  h1Violations: number;
  ogIncomplete: number;
}
```

Implementation of `pass4MetaTagValidation(baseUrl: string)`:

1. Fetch sitemap URLs (reuse Pass 1 logic -- extract all `<loc>` URLs from sitemap index and sub-sitemaps)
2. If >50 URLs, sample 50 random URLs for speed (controlled by `AUDIT_SAMPLE` env var; default: audit all when <=50, sample when >50)
3. For each URL:
   a. Fetch the full HTML page
   b. Parse with cheerio: `const $ = cheerio.load(html)`
   c. **Title check (CTAG-04):** `$('title').text()` -- FAIL if >60 chars
   d. **Description check (CTAG-02/03):** `$('meta[name="description"]').attr('content')` -- FAIL if <100 or >160 chars
   e. **H1 check (CTAG-01/06):** `$('h1').length` -- FAIL if 0 or >1
   f. **OG check (CTAG-05):** Check for og:title, og:description, og:image, og:url -- WARN (not FAIL) if incomplete
4. Return Pass4Result with counts

Add to `runAudit()`:
- After Pass 3, add Pass 4 (only when `baseUrl` is set, same conditional as Pass 1)
- Print results following same format as other passes
- Add Pass 4 failures to `allFailures` array so build fails on violations

Update the aggregate section:
```typescript
const allFailures = [
  ...(pass1?.failures || []),
  ...pass2.failures,
  ...pass3.failures,
  ...(pass4?.failures || []),
];
```

**package.json:**
Add cheerio to dependencies (npm install handles this). No script changes needed -- the existing build script already runs the audit.

**Important implementation details:**
- Import cheerio: `import * as cheerio from 'cheerio';` (ESM import)
- Add type for cheerio at top if needed: cheerio has built-in types
- Fetch with a timeout (5s per URL) to avoid hanging on slow pages
- Log progress: `Checking ${index + 1}/${total}: ${url}` every 10 URLs
- The audit script already exits with code 1 on failures, which fails the build
  </action>
  <verify>
Run audit script manually to verify:
```bash
AUDIT_BASE_URL=http://localhost:3000 npx tsx scripts/audit-internal-links.ts
```
Confirm Pass 4 output shows title, description, H1, and OG tag checks. Verify it catches violations (temporarily break a title to test). Run full build to ensure audit integrates properly.
  </verify>
  <done>
Build-time audit has Pass 4 that validates meta tags using cheerio. Title >60 chars, description <100 or >160 chars, and H1 count != 1 cause build failures. OG tag completeness is warned but does not fail build. Script works with `AUDIT_BASE_URL` env var.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /leagues page source contains `"@type":"CollectionPage"` with 17 items
3. /models page source contains `"@type":"CollectionPage"` with model items
4. `AUDIT_BASE_URL=http://localhost:3000 npx tsx scripts/audit-internal-links.ts` completes with Pass 4 output
5. `npm run build` succeeds with all 4 audit passes
</verification>

<success_criteria>
- INDEX-05: /leagues page has CollectionPage structured data
- INDEX-06: /models page has CollectionPage structured data
- Build-time validation catches title, description, H1, and OG tag violations
- Build fails on meta tag violations (CTAG-01 through CTAG-06 enforced)
- All 8 requirements (CTAG-01 through CTAG-06, INDEX-05, INDEX-06) covered across Plans 01-03
</success_criteria>

<output>
After completion, create `.planning/phases/46-content-tags-meta-optimization/46-03-SUMMARY.md`
</output>
