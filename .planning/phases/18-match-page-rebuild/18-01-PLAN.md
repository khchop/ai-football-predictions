---
phase: 18-match-page-rebuild
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/match/match-header-sticky.tsx
  - src/hooks/use-intersection-observer.ts
  - src/components/match/match-page-header.tsx
  - src/app/leagues/[slug]/[match]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Score appears exactly in hero + sticky header only (no other occurrences)"
    - "Sticky header appears only when hero scrolls out of viewport"
    - "Score removed from MatchStats predictions panel"
  artifacts:
    - path: "src/hooks/use-intersection-observer.ts"
      provides: "Reusable Intersection Observer hook"
      exports: ["useIntersectionObserver"]
    - path: "src/components/match/match-page-header.tsx"
      provides: "Combined hero + sticky with observer"
      exports: ["MatchPageHeader"]
  key_links:
    - from: "src/components/match/match-page-header.tsx"
      to: "src/hooks/use-intersection-observer.ts"
      via: "import useIntersectionObserver"
      pattern: "useIntersectionObserver"
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "src/components/match/match-page-header.tsx"
      via: "MatchPageHeader replaces MatchHeaderSticky"
      pattern: "MatchPageHeader"
---

<objective>
Implement score deduplication so score appears exactly in hero section and sticky header only

Purpose: Requirement MTCH-01 - User sees match score exactly once on page (plus compact reference in sticky). Currently score appears in MatchStats predictions panel and potentially other sections.

Output: MatchPageHeader component with Intersection Observer triggering sticky only when hero scrolls out, score removed from all other sections
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-match-page-rebuild/18-CONTEXT.md
@.planning/phases/18-match-page-rebuild/18-RESEARCH.md
@src/components/match/match-header.tsx
@src/components/match/match-header-sticky.tsx
@src/components/match/MatchStats.tsx
@src/app/leagues/[slug]/[match]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Intersection Observer hook</name>
  <files>src/hooks/use-intersection-observer.ts</files>
  <action>
Create a reusable hook that:
1. Takes optional IntersectionObserverInit options
2. Returns { ref, isIntersecting } where ref is RefObject<HTMLElement>
3. Uses threshold: 0 and rootMargin: '-1px 0px' to trigger exactly when element exits viewport
4. Handles cleanup with observer.disconnect() in useEffect cleanup
5. Includes 'use client' directive

Pattern from research:
```typescript
'use client'
import { useEffect, useState, useRef } from 'react'

export function useIntersectionObserver(options?: IntersectionObserverInit) {
  const [isIntersecting, setIsIntersecting] = useState(true)
  const ref = useRef<HTMLElement>(null)

  useEffect(() => {
    const element = ref.current
    if (!element) return

    const observer = new IntersectionObserver(
      ([entry]) => setIsIntersecting(entry.isIntersecting),
      { threshold: 0, rootMargin: '-1px 0px', ...options }
    )

    observer.observe(element)
    return () => observer.disconnect()
  }, [options])

  return { ref, isIntersecting }
}
```
  </action>
  <verify>File exists at src/hooks/use-intersection-observer.ts with 'use client' directive and exports useIntersectionObserver</verify>
  <done>Hook created with proper cleanup and configurable options</done>
</task>

<task type="auto">
  <name>Task 2: Create MatchPageHeader combining hero + observer-triggered sticky</name>
  <files>src/components/match/match-page-header.tsx</files>
  <action>
Create client component that:
1. Imports useIntersectionObserver hook
2. Wraps existing MatchHeader in a div with ref from hook
3. Conditionally renders MatchHeaderSticky ONLY when !isIntersecting
4. Accepts same props as current MatchHeaderSticky (match, competition, isLive, isFinished)
5. Sticky header wrapper uses: sticky top-0 z-50 bg-background/95 backdrop-blur-sm border-b

Structure:
```tsx
'use client'
import { useIntersectionObserver } from '@/hooks/use-intersection-observer'
import { MatchHeader } from './match-header'
import { MatchHeaderSticky } from './match-header-sticky'

interface MatchPageHeaderProps {
  match: Match
  competition: Competition
  isLive: boolean
  isFinished: boolean
}

export function MatchPageHeader({ match, competition, isLive, isFinished }: MatchPageHeaderProps) {
  const { ref, isIntersecting } = useIntersectionObserver()

  return (
    <>
      <div ref={ref as React.RefObject<HTMLDivElement>}>
        <MatchHeader match={match} competition={competition} isLive={isLive} isFinished={isFinished} />
      </div>
      {!isIntersecting && (
        <div className="sticky top-0 z-50 bg-background/95 backdrop-blur-sm border-b">
          <MatchHeaderSticky match={match} competition={competition} isLive={isLive} isFinished={isFinished} />
        </div>
      )}
    </>
  )
}
```

Import types from @/lib/db/schema for Match and Competition.
  </action>
  <verify>File exists at src/components/match/match-page-header.tsx with 'use client' directive and exports MatchPageHeader</verify>
  <done>MatchPageHeader wraps hero with ref and conditionally shows sticky based on Intersection Observer</done>
</task>

<task type="auto">
  <name>Task 3: Update match page to use MatchPageHeader and deduplicate scores</name>
  <files>src/app/leagues/[slug]/[match]/page.tsx</files>
  <action>
Update the main match page:

1. Replace separate MatchHeaderSticky usage with new MatchPageHeader component
   - Change import from MatchHeaderSticky to MatchPageHeader
   - Remove the direct MatchHeaderSticky component call
   - Use MatchPageHeader which internally handles both hero and sticky

2. Audit for score duplication - remove scores from:
   - MatchStats component call if it renders scores (check the roundupStats display)
   - Any other section outside hero/sticky

3. In the desktop layout section, MatchPageHeader now replaces both:
   - The manual MatchHeader call
   - The separate MatchHeaderSticky

4. In mobile layout, ensure MatchTabsMobile receives data without duplicate score display
   - SummaryTab should NOT show score (hero visible above tabs)

5. Update imports:
   - Add: import { MatchPageHeader } from '@/components/match/match-page-header'
   - Remove: direct MatchHeader import if only used through MatchPageHeader
   - Keep: MatchHeaderSticky import only if mobile needs it separately

Key changes to existing structure:
- Line ~185: Replace MatchHeaderSticky with MatchPageHeader
- Line ~262: Desktop section already has hero via MatchStats - verify no duplicate
- Ensure only TWO score occurrences: hero (in MatchPageHeader) and sticky (when visible)
  </action>
  <verify>
1. `grep -c "homeScore.*awayScore\|awayScore.*homeScore" src/app/leagues/[slug]/[match]/page.tsx` should show minimal occurrences
2. `grep "MatchPageHeader" src/app/leagues/[slug]/[match]/page.tsx` returns match
3. Page still renders without errors: `npm run build` succeeds
  </verify>
  <done>Match page uses MatchPageHeader, score appears only in hero + sticky header</done>
</task>

</tasks>

<verification>
1. Score deduplication check:
   ```bash
   # Should only find score in match-header.tsx and match-header-sticky.tsx
   grep -rn "homeScore" src/components/match/ | grep -v "\.test\." | grep -v node_modules
   ```

2. Sticky behavior manual test:
   - Load any match page
   - Scroll down until hero exits viewport
   - Sticky header should appear
   - Scroll back up
   - Sticky header should disappear when hero visible

3. Build verification:
   ```bash
   npm run build
   ```
</verification>

<success_criteria>
- Score appears exactly twice: large in hero, compact in sticky header
- Sticky header appears only when hero scrolls out of viewport (not always visible)
- No score in MatchStats, predictions panel, or other sections
- Build passes without errors
- Intersection Observer properly cleans up on unmount
</success_criteria>

<output>
After completion, create `.planning/phases/18-match-page-rebuild/18-01-SUMMARY.md`
</output>
