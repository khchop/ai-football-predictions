---
phase: 12-internal-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/queries.ts
  - src/components/match/related-matches-widget.tsx
  - src/components/model/related-models-widget.tsx
  - src/app/leagues/[slug]/[match]/page.tsx
  - src/app/models/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Match pages display 3-5 related matches from same competition or involving same teams"
    - "Model pages display top 5 performing models with links"
    - "All related content links use descriptive anchor text (team names, model names)"
    - "Widgets render server-side (crawlable by search engines)"
  artifacts:
    - path: "src/lib/db/queries.ts"
      provides: "getRelatedMatches and getTopModels query functions"
      contains: "getRelatedMatches"
    - path: "src/components/match/related-matches-widget.tsx"
      provides: "Server component for related matches"
      exports: ["RelatedMatchesWidget"]
    - path: "src/components/model/related-models-widget.tsx"
      provides: "Server component for top models"
      exports: ["RelatedModelsWidget"]
  key_links:
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "RelatedMatchesWidget"
      via: "import and render"
      pattern: "RelatedMatchesWidget"
    - from: "src/app/models/[id]/page.tsx"
      to: "RelatedModelsWidget"
      via: "import and render"
      pattern: "RelatedModelsWidget"
    - from: "RelatedMatchesWidget"
      to: "/leagues/{slug}/{match}"
      via: "Next.js Link"
      pattern: "href=.*leagues"
---

<objective>
Add related content widgets to match and model pages for SEO internal linking.

Purpose: Reduce crawl depth, eliminate orphan pages, and improve topic clustering for SEO (addresses SEO-T11, SEO-T12).
Output: Two new server components (RelatedMatchesWidget, RelatedModelsWidget) integrated into their respective pages.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-linking/12-RESEARCH.md

# Source files to modify
@src/lib/db/queries.ts
@src/app/leagues/[slug]/[match]/page.tsx
@src/app/models/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database query functions for related content</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add two new query functions to src/lib/db/queries.ts:

1. `getRelatedMatches(matchId: string, limit: number = 5)`:
   - First query the current match to get competitionId, homeTeam, awayTeam
   - Return empty array if match not found
   - Query related matches where:
     - NOT the current match (ne(matches.id, matchId))
     - AND (same competition OR involves same teams in any position)
     - Order by kickoffTime descending
     - Limit to specified amount
   - Return match with competition join for URL building
   - Use existing indexes (competitionId, homeTeam, awayTeam)

2. `getTopModelsForWidget(excludeModelId: string | null, limit: number = 5)`:
   - Query models ordered by total points from predictions
   - Exclude the specified modelId if provided (for model detail pages)
   - Only include active models (eq(models.active, true))
   - Return id, displayName, totalPoints, scoredPredictions count
   - Use existing leaderboard query pattern from getLeaderboard

Follow existing query patterns in the file:
- Use getDb() for database instance
- Use drizzle-orm operators (eq, and, or, ne, desc)
- Join competitions table for match queries
- Use sql template for aggregations

DO NOT add caching (withCache) - these queries are fast enough with existing indexes.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- getRelatedMatches function returns matches from same competition or involving same teams
- getTopModelsForWidget function returns top models by total points
- Both functions use proper drizzle-orm patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RelatedMatchesWidget and integrate into match pages</name>
  <files>src/components/match/related-matches-widget.tsx, src/app/leagues/[slug]/[match]/page.tsx</files>
  <action>
Create src/components/match/related-matches-widget.tsx as a React Server Component:

```typescript
import Link from 'next/link';
import { format, parseISO } from 'date-fns';
import { getRelatedMatches } from '@/lib/db/queries';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Calendar, ChevronRight } from 'lucide-react';

interface RelatedMatchesWidgetProps {
  matchId: string;
  competitionSlug: string;
}

export async function RelatedMatchesWidget({ matchId, competitionSlug }: RelatedMatchesWidgetProps) {
  const relatedMatches = await getRelatedMatches(matchId, 5);

  if (relatedMatches.length === 0) return null;

  return (
    <Card className="bg-card/50 border-border/50">
      <CardHeader>
        <CardTitle className="text-lg">Related Matches</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {relatedMatches.map(({ match, competition }) => {
            const kickoff = parseISO(match.kickoffTime);
            const matchUrl = match.slug
              ? `/leagues/${competition.slug || competition.id}/${match.slug}`
              : `/matches/${match.id}`;

            return (
              <Link
                key={match.id}
                href={matchUrl}
                className="block p-3 rounded-lg border border-border/50 hover:bg-accent transition-colors"
              >
                <div className="flex items-start justify-between gap-2">
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-sm leading-tight">
                      {match.homeTeam} vs {match.awayTeam}
                    </p>
                    <p className="text-xs text-muted-foreground mt-1">
                      {competition.name}
                    </p>
                  </div>
                  <div className="flex items-center gap-1 text-xs text-muted-foreground flex-shrink-0">
                    <Calendar className="h-3 w-3" />
                    {format(kickoff, 'MMM d')}
                  </div>
                </div>
                {match.status === 'finished' && match.homeScore !== null && match.awayScore !== null && (
                  <p className="text-xs font-mono text-muted-foreground mt-2">
                    Final: {match.homeScore}-{match.awayScore}
                  </p>
                )}
              </Link>
            );
          })}
        </div>
      </CardContent>
    </Card>
  );
}
```

Then integrate into src/app/leagues/[slug]/[match]/page.tsx:

1. Add import at top:
   ```typescript
   import { RelatedMatchesWidget } from '@/components/match/related-matches-widget';
   ```

2. Add the widget after the "Upcoming Fixtures" card section (around line 485, after the last grid of cards):
   ```typescript
   {/* Related Matches */}
   <RelatedMatchesWidget matchId={matchData.id} competitionSlug={competitionSlug} />
   ```

Use descriptive anchor text: "{homeTeam} vs {awayTeam}" (not "View match" or "Click here").
  </action>
  <verify>
1. Build succeeds: `npm run build`
2. Visit a match page in dev mode and verify:
   - Related matches widget appears at bottom
   - Shows matches from same competition or teams
   - Links use descriptive anchor text
   - Widget renders in page source (not client-side only)
  </verify>
  <done>
- RelatedMatchesWidget component created as RSC
- Widget integrated into match detail page
- Links use descriptive "{team} vs {team}" anchor text
- Widget is server-rendered (visible in page source)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RelatedModelsWidget and integrate into model pages</name>
  <files>src/components/model/related-models-widget.tsx, src/app/models/[id]/page.tsx</files>
  <action>
First create the directory if it doesn't exist:
```bash
mkdir -p src/components/model
```

Create src/components/model/related-models-widget.tsx as a React Server Component:

```typescript
import Link from 'next/link';
import { getTopModelsForWidget } from '@/lib/db/queries';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Trophy } from 'lucide-react';

interface RelatedModelsWidgetProps {
  currentModelId: string;
}

export async function RelatedModelsWidget({ currentModelId }: RelatedModelsWidgetProps) {
  const topModels = await getTopModelsForWidget(currentModelId, 5);

  if (topModels.length === 0) return null;

  return (
    <Card className="bg-card/50 border-border/50">
      <CardHeader>
        <CardTitle className="text-lg flex items-center gap-2">
          <Trophy className="h-5 w-5 text-yellow-500" />
          Top Performing Models
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {topModels.map((model, index) => (
            <Link
              key={model.id}
              href={`/models/${model.id}`}
              className="block p-3 rounded-lg border border-border/50 hover:bg-accent transition-colors"
            >
              <div className="flex items-center justify-between gap-3">
                <div className="flex items-center gap-3 flex-1 min-w-0">
                  <div className="flex-shrink-0 w-6 text-center">
                    <span className="text-sm font-bold text-muted-foreground">
                      #{index + 1}
                    </span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-sm truncate">
                      {model.displayName}
                    </p>
                    <p className="text-xs text-muted-foreground">
                      {model.scoredPredictions} predictions
                    </p>
                  </div>
                </div>
                <div className="text-right flex-shrink-0">
                  <p className="text-sm font-bold">{model.totalPoints} pts</p>
                </div>
              </div>
            </Link>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

Then integrate into src/app/models/[id]/page.tsx:

1. Add import at top:
   ```typescript
   import { RelatedModelsWidget } from '@/components/model/related-models-widget';
   ```

2. Add the widget after the "Performance by League" section (after line 407, before closing div):
   ```typescript
   {/* Related Models */}
   <section>
     <RelatedModelsWidget currentModelId={id} />
   </section>
   ```

Use descriptive anchor text: model.displayName (not "View model").
  </action>
  <verify>
1. Build succeeds: `npm run build`
2. Visit a model page in dev mode and verify:
   - Related models widget appears at bottom
   - Shows top 5 models excluding current model
   - Links use model names as anchor text
   - Widget renders in page source (not client-side only)
  </verify>
  <done>
- RelatedModelsWidget component created as RSC
- Widget integrated into model detail page
- Current model excluded from list
- Links use model display names as anchor text
- Widget is server-rendered (visible in page source)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. Match pages show "Related Matches" widget with 3-5 contextual links
3. Model pages show "Top Performing Models" widget with 5 links
4. All links use descriptive anchor text (team names, model names)
5. View page source confirms widgets render server-side (links visible in HTML)
6. No console errors in browser
</verification>

<success_criteria>
- [ ] getRelatedMatches query returns matches from same competition/teams
- [ ] getTopModelsForWidget query returns top models by points
- [ ] RelatedMatchesWidget renders on match pages with descriptive links
- [ ] RelatedModelsWidget renders on model pages with model name links
- [ ] All widgets are server-rendered (crawlable)
- [ ] SEO-T11 requirement satisfied (match cross-links)
- [ ] SEO-T12 requirement satisfied (related models section)
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-linking/12-01-SUMMARY.md`
</output>
