---
phase: 40-model-specific-prompt-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/llm/prompt-variants.ts
  - src/lib/llm/response-handlers.ts
autonomous: true

must_haves:
  truths:
    - "Prompt variants can be referenced by enum name at compile time"
    - "Response handlers transform raw LLM output before JSON parsing"
    - "Invalid variant names cause TypeScript compilation errors"
  artifacts:
    - path: "src/lib/llm/prompt-variants.ts"
      provides: "PromptVariant enum, PROMPT_VARIANTS constant, PromptConfig interface"
      exports: ["PromptVariant", "PROMPT_VARIANTS", "PromptConfig"]
    - path: "src/lib/llm/response-handlers.ts"
      provides: "ResponseHandler enum and handler functions"
      exports: ["ResponseHandler", "RESPONSE_HANDLERS", "ResponseHandlerFn"]
  key_links:
    - from: "src/lib/llm/prompt-variants.ts"
      to: "PromptVariant enum"
      via: "TypeScript enum export"
      pattern: "export enum PromptVariant"
    - from: "src/lib/llm/response-handlers.ts"
      to: "RESPONSE_HANDLERS record"
      via: "TypeScript const export"
      pattern: "export const RESPONSE_HANDLERS"
---

<objective>
Create the prompt variant and response handler infrastructure for model-specific configurations.

Purpose: Establish type-safe enums and constants that provider classes will use to customize prompts and post-process responses for failing models (GLM, Kimi, DeepSeek, Qwen thinking).

Output: Two new TypeScript files with compile-time validated configuration types.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-model-specific-prompt-selection/40-CONTEXT.md
@.planning/phases/40-model-specific-prompt-selection/40-RESEARCH.md

# Key existing files to reference
@src/lib/llm/prompt.ts
@src/lib/llm/providers/together.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt variants configuration</name>
  <files>src/lib/llm/prompt-variants.ts</files>
  <action>
Create a new TypeScript file with:

1. **PromptVariant enum** with these values (per CONTEXT.md decisions):
   - `BASE = 'base'` - No additional instructions
   - `ENGLISH_ENFORCED = 'english-enforced'` - For GLM models returning Chinese
   - `JSON_STRICT = 'json-strict'` - For DeepSeek V3.2 adding explanations
   - `THINKING_STRIPPED = 'thinking-stripped'` - For thinking models with `<think>` tags
   - `ENGLISH_THINKING_STRIPPED = 'english-thinking-stripped'` - Combo variant for models needing both

2. **PROMPT_VARIANTS constant** (Record of PromptVariant to string):
   - BASE: Empty string (no additions)
   - ENGLISH_ENFORCED: `\n\nCRITICAL: Respond ONLY in English. Do not output Chinese or any other language.`
   - JSON_STRICT: `\n\nOUTPUT FORMAT - CRITICAL:\n- Return ONLY valid JSON\n- No explanations before or after the JSON\n- No markdown code blocks\n- No natural language\n- Just the raw JSON object`
   - THINKING_STRIPPED: `\n\nOUTPUT FORMAT - CRITICAL:\n- Do NOT use <think>, <thinking>, or <reasoning> tags\n- Output ONLY the JSON prediction\n- No thinking process in the response`
   - ENGLISH_THINKING_STRIPPED: Combines English enforcement + thinking stripped instructions

3. **PromptConfig interface**:
   ```typescript
   export interface PromptConfig {
     promptVariant?: PromptVariant;
     responseHandler?: ResponseHandler;  // Import from response-handlers.ts
     timeoutMs?: number;
   }
   ```

4. **Helper function** `getEnhancedSystemPrompt(basePrompt: string, variant: PromptVariant): string`:
   - Appends the variant's additional instructions to the base prompt
   - Returns basePrompt + PROMPT_VARIANTS[variant]

Export all types and constants.
  </action>
  <verify>
Run TypeScript compilation:
```bash
cd /Users/pieterbos/Documents/bettingsoccer && npx tsc --noEmit src/lib/llm/prompt-variants.ts
```
No compilation errors. Enum values accessible.
  </verify>
  <done>
- PromptVariant enum has 5 values (BASE, ENGLISH_ENFORCED, JSON_STRICT, THINKING_STRIPPED, ENGLISH_THINKING_STRIPPED)
- PROMPT_VARIANTS maps each enum value to its instruction additions
- PromptConfig interface defines optional fields for promptVariant, responseHandler, timeoutMs
- getEnhancedSystemPrompt function concatenates base prompt with variant additions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create response handler functions</name>
  <files>src/lib/llm/response-handlers.ts</files>
  <action>
Create a new TypeScript file with:

1. **ResponseHandler enum** (per CONTEXT.md decisions):
   - `DEFAULT = 'default'` - Pass-through, no processing
   - `EXTRACT_JSON = 'extract-json'` - Remove markdown, extract JSON object
   - `STRIP_THINKING_TAGS = 'strip-thinking-tags'` - Remove `<think>` etc. tags

2. **ResponseHandlerFn type**: `(response: string) => string`

3. **RESPONSE_HANDLERS constant** (Record of ResponseHandler to ResponseHandlerFn):

   **DEFAULT handler:**
   - Simply returns the input unchanged

   **EXTRACT_JSON handler:**
   - Remove markdown code blocks: replace `/```json\n?/gi` and `/```\n?/g` with empty string
   - Trim the result
   - Try to extract first JSON object with regex `/\{[\s\S]*\}/`
   - Try to extract first JSON array with regex `/\[[\s\S]*\]/`
   - Prefer object over array (single prediction format)
   - Return the extracted JSON string, or cleaned input if no match

   **STRIP_THINKING_TAGS handler:**
   - Remove `<think>...</think>` tags and content: replace `/<think>[\s\S]*?<\/think>/gi` with empty
   - Remove `<thinking>...</thinking>` tags and content
   - Remove `<reasoning>...</reasoning>` tags and content
   - Trim the result
   - IMPORTANT: This runs BEFORE JSON extraction (order matters per RESEARCH.md pitfalls)

4. Add JSDoc comments explaining:
   - When to use each handler
   - Processing order (strip tags BEFORE extracting JSON)
   - That handlers are applied before existing parseBatchPredictionEnhanced

Export all types and constants.
  </action>
  <verify>
Run TypeScript compilation:
```bash
cd /Users/pieterbos/Documents/bettingsoccer && npx tsc --noEmit src/lib/llm/response-handlers.ts
```
No compilation errors.

Test handler logic manually in Node REPL:
```bash
cd /Users/pieterbos/Documents/bettingsoccer && node -e "
const response = '<think>Let me analyze...</think>{\"home_score\": 2, \"away_score\": 1}';
const stripped = response.replace(/<think>[\\s\\S]*?<\\/think>/gi, '').trim();
console.log('Stripped:', stripped);
console.log('Expected: {\"home_score\": 2, \"away_score\": 1}');
console.log('Match:', stripped === '{\"home_score\": 2, \"away_score\": 1}');
"
```
Output shows thinking tags removed correctly.
  </verify>
  <done>
- ResponseHandler enum has 3 values (DEFAULT, EXTRACT_JSON, STRIP_THINKING_TAGS)
- RESPONSE_HANDLERS maps each enum to its handler function
- DEFAULT handler returns input unchanged
- EXTRACT_JSON handler removes markdown and extracts JSON objects
- STRIP_THINKING_TAGS handler removes `<think>`, `<thinking>`, `<reasoning>` tags
- All handlers are pure functions (input string -> output string)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation passes:**
```bash
cd /Users/pieterbos/Documents/bettingsoccer && npx tsc --noEmit
```

2. **Both files exist and export correctly:**
```bash
ls -la src/lib/llm/prompt-variants.ts src/lib/llm/response-handlers.ts
```

3. **Exports are accessible:**
```bash
cd /Users/pieterbos/Documents/bettingsoccer && node -e "
const pv = require('./src/lib/llm/prompt-variants');
const rh = require('./src/lib/llm/response-handlers');
console.log('PromptVariant values:', Object.values(pv.PromptVariant));
console.log('ResponseHandler values:', Object.values(rh.ResponseHandler));
console.log('PROMPT_VARIANTS keys:', Object.keys(pv.PROMPT_VARIANTS));
console.log('RESPONSE_HANDLERS keys:', Object.keys(rh.RESPONSE_HANDLERS));
"
```
</verification>

<success_criteria>
- PRMT-01 partially satisfied: Model-specific prompt templates exist (variants defined)
- PromptVariant enum compiles with all 5 variants
- ResponseHandler enum compiles with all 3 handlers
- PROMPT_VARIANTS constant provides instruction additions for each variant
- RESPONSE_HANDLERS constant provides handler functions
- PromptConfig interface defines configuration shape
- getEnhancedSystemPrompt helper concatenates prompts correctly
- No new dependencies added (pure TypeScript)
</success_criteria>

<output>
After completion, create `.planning/phases/40-model-specific-prompt-selection/40-01-SUMMARY.md`
</output>
