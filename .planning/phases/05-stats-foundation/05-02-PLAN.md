---
phase: 05-stats-foundation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "getTopModelsByCompetition uses tendencyPoints > 0 for accuracy"
    - "getModelPredictionStats uses tendencyPoints > 0 for correctTendencies"
    - "All accuracy denominators use scored predictions only"
  artifacts:
    - path: "src/lib/db/queries.ts"
      provides: "Fixed query functions with correct formulas"
      contains: "tendencyPoints > 0"
  key_links:
    - from: "src/lib/db/queries.ts"
      to: "src/lib/services/stats.ts"
      via: "Imports SQL fragments"
      pattern: "from.*services/stats"
---

<objective>
Fix the two query functions with incorrect accuracy formulas to use the standardized formula from the stats service.

Purpose: Eliminates the IS NOT NULL vs > 0 mismatch that causes different accuracy numbers on different pages. After this, `getTopModelsByCompetition()` (competition pages) and `getModelPredictionStats()` (model detail page) will show the same accuracy as the leaderboard.

Output: Updated `src/lib/db/queries.ts` with correct formulas imported from stats service.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-stats-foundation/05-RESEARCH.md
@.planning/phases/05-stats-foundation/05-01-SUMMARY.md

# Stats service created in Plan 01
@src/lib/services/stats.ts

# File to modify
@src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix getTopModelsByCompetition accuracy formula</name>
  <files>src/lib/db/queries.ts</files>
  <action>
In `src/lib/db/queries.ts`, find the `getTopModelsByCompetition` function (around line 264-290).

Current WRONG code (lines 273-275):
```typescript
correctTendencies: sql<number>`SUM(CASE WHEN ${predictions.tendencyPoints} IS NOT NULL THEN 1 ELSE 0 END)`,
avgPoints: sql<number>`COALESCE(ROUND(AVG(${predictions.totalPoints})::numeric, 2), 0)`,
accuracy: sql<number>`COALESCE(ROUND(100.0 * SUM(CASE WHEN ${predictions.tendencyPoints} IS NOT NULL THEN 1 ELSE 0 END) / NULLIF(COUNT(${predictions.id}), 0)::numeric, 1), 0)`,
```

Problems:
1. `IS NOT NULL` includes predictions with tendencyPoints = 0 (wrong tendency)
2. Denominator uses `COUNT(predictions.id)` which includes unscored predictions

Fix to use correct formula:
```typescript
correctTendencies: sql<number>`SUM(CASE WHEN ${predictions.tendencyPoints} > 0 THEN 1 ELSE 0 END)`,
avgPoints: sql<number>`COALESCE(ROUND(AVG(${predictions.totalPoints})::numeric, 2), 0)`,
accuracy: sql<number>`COALESCE(ROUND(100.0 * SUM(CASE WHEN ${predictions.tendencyPoints} > 0 THEN 1 ELSE 0 END) / NULLIF(SUM(CASE WHEN ${predictions.status} = 'scored' THEN 1 ELSE 0 END), 0)::numeric, 1), 0)`,
```

Changes:
1. `IS NOT NULL` -> `> 0` (only count correct predictions)
2. `COUNT(${predictions.id})` -> `SUM(CASE WHEN status = 'scored' THEN 1 ELSE 0 END)` (only count scored predictions)

Note: The function already has `eq(predictions.status, 'scored')` in the join condition, but keep the explicit denominator for consistency and safety.
  </action>
  <verify>
Grep for the fix: `grep -A2 "correctTendencies:" src/lib/db/queries.ts | grep -q "> 0" && echo "Fixed" || echo "Still wrong"`
Verify no IS NOT NULL in accuracy calculation: `grep -n "tendencyPoints.*IS NOT NULL" src/lib/db/queries.ts | grep -v "//" | wc -l` should be 0
  </verify>
  <done>getTopModelsByCompetition uses `tendencyPoints > 0` and scored predictions denominator</done>
</task>

<task type="auto">
  <name>Task 2: Fix getModelPredictionStats formula</name>
  <files>src/lib/db/queries.ts</files>
  <action>
In `src/lib/db/queries.ts`, find the `getModelPredictionStats` function (around line 2012-2032).

Current WRONG code (line 2022):
```typescript
correctTendencies: sql<number>`SUM(CASE WHEN ${predictions.tendencyPoints} IS NOT NULL THEN 1 ELSE 0 END)`,
```

Problem: `IS NOT NULL` includes predictions where tendencyPoints = 0 (wrong tendency, no points)

Fix:
```typescript
correctTendencies: sql<number>`SUM(CASE WHEN ${predictions.tendencyPoints} > 0 THEN 1 ELSE 0 END)`,
```

Also fix line 2023 which has the inverse bug:
```typescript
// WRONG - looking for NULL when scored, but scored predictions have tendencyPoints = 0, not NULL
wrongTendencies: sql<number>`SUM(CASE WHEN ${predictions.status} = 'scored' AND ${predictions.tendencyPoints} IS NULL THEN 1 ELSE 0 END)`,
```

Fix:
```typescript
// CORRECT - wrong tendency means scored but tendencyPoints = 0
wrongTendencies: sql<number>`SUM(CASE WHEN ${predictions.status} = 'scored' AND (${predictions.tendencyPoints} = 0 OR ${predictions.tendencyPoints} IS NULL) THEN 1 ELSE 0 END)`,
```

Note: tendencyPoints can be 0 (wrong tendency) or NULL (not yet scored). For wrongTendencies, we want scored predictions where tendency was wrong (= 0) or somehow NULL.
  </action>
  <verify>
Verify correctTendencies fix: `grep -A1 "correctTendencies:" src/lib/db/queries.ts | tail -1 | grep -q "> 0" && echo "Fixed" || echo "Check line"`
Count remaining IS NOT NULL in predictions queries: `grep "tendencyPoints.*IS NOT NULL" src/lib/db/queries.ts | grep -v "//" | wc -l`
  </verify>
  <done>getModelPredictionStats uses `tendencyPoints > 0` for correctTendencies and handles wrongTendencies correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add import comment for stats service reference</name>
  <files>src/lib/db/queries.ts</files>
  <action>
Add a documentation comment at the top of `src/lib/db/queries.ts` (after imports) to reference the stats service as the canonical source:

```typescript
/**
 * Database queries for the application.
 *
 * STATS ACCURACY FORMULA:
 * For accuracy calculations, use the canonical formula from src/lib/services/stats.ts
 * - Numerator: tendencyPoints > 0 (correct predictions only)
 * - Denominator: predictions with status = 'scored' (not total predictions)
 * - Division protection: NULLIF(denominator, 0) + COALESCE(result, 0)
 *
 * DO NOT use `tendencyPoints IS NOT NULL` - it includes 0-point wrong predictions.
 */
```

This ensures future developers know about the service layer and the correct formula.
  </action>
  <verify>`grep -q "tendencyPoints > 0" src/lib/db/queries.ts && grep -q "STATS ACCURACY FORMULA" src/lib/db/queries.ts && echo "Documented"`</verify>
  <done>Documentation comment added referencing stats service and correct formula</done>
</task>

</tasks>

<verification>
1. No `tendencyPoints IS NOT NULL` in accuracy calculations: `grep "tendencyPoints.*IS NOT NULL" src/lib/db/queries.ts | grep -v "//" | wc -l` = 0
2. correctTendencies uses `> 0`: `grep "correctTendencies.*> 0" src/lib/db/queries.ts | wc -l` >= 2
3. Documentation comment exists: `grep -q "STATS ACCURACY FORMULA" src/lib/db/queries.ts`
4. TypeScript compiles: `npx tsc --noEmit src/lib/db/queries.ts`
</verification>

<success_criteria>
- getTopModelsByCompetition accuracy matches leaderboard formula
- getModelPredictionStats correctTendencies counts only tendencyPoints > 0
- Documentation warns against IS NOT NULL pattern
- Competition pages will now show same accuracy as leaderboard for same model
</success_criteria>

<output>
After completion, create `.planning/phases/05-stats-foundation/05-02-SUMMARY.md`
</output>
