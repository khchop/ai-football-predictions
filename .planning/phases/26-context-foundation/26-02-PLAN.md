---
phase: 26-context-foundation
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - src/app/matches/[id]/page.tsx
  - src/app/leagues/[slug]/[match]/page.tsx
autonomous: true
must_haves:
  truths:
    - "MatchDataProvider wraps all page content in both match pages"
    - "Match/Competition/Analysis data passed to provider via props from server fetch"
    - "JSON-LD scripts and schema components remain outside provider (at root)"
    - "No component fetches match data independently (verified by grep)"
  artifacts:
    - path: "src/app/matches/[id]/page.tsx"
      provides: "Server Component with MatchDataProvider wrapping content"
      contains: "MatchDataProvider, match={match}, competition={competition}, analysis={analysis}"
    - path: "src/app/leagues/[slug]/[match]/page.tsx"
      provides: "Server Component with MatchDataProvider wrapping content"
      contains: "MatchDataProvider, match={matchData}, competition={competition}, analysis={analysis}"
  key_links:
    - from: "src/app/matches/[id]/page.tsx"
      to: "src/components/match/match-data-provider.tsx"
      via: "import MatchDataProvider"
      pattern: "import.*MatchDataProvider.*from.*@/components/match"
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "src/components/match/match-data-provider.tsx"
      via: "import MatchDataProvider"
      pattern: "import.*MatchDataProvider.*from.*@/components/match"
---

<objective>
Integrate MatchDataProvider into both match pages for single-source-of-truth data flow

Purpose: Complete ARCH-01 (single provider), ARCH-02 (no independent fetching), ARCH-03 (state derived at page level)
Output: Both match page routes use MatchDataProvider, data flows from server fetch to client context
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/26-context-foundation/26-RESEARCH.md
@.planning/phases/26-context-foundation/26-01-SUMMARY.md

# Pages to modify
@src/app/matches/[id]/page.tsx
@src/app/leagues/[slug]/[match]/page.tsx

# Provider created in Plan 01
@src/components/match/match-data-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate MatchDataProvider into matches/[id]/page.tsx</name>
  <files>src/app/matches/[id]/page.tsx</files>
  <action>
    Update matches/[id]/page.tsx to wrap content with MatchDataProvider:

    1. Add import at top: import { MatchDataProvider } from '@/components/match/match-data-provider';

    2. In the return statement (around line 105), restructure JSX:
       - Keep JSON-LD script OUTSIDE MatchDataProvider (remains first child of fragment)
       - Wrap the div.max-w-4xl container and all its children with MatchDataProvider
       - Pass props: match={match}, competition={competition}, analysis={analysis}

    Target structure:
    ```tsx
    return (
      <>
        <script type="application/ld+json" ... />

        <MatchDataProvider
          match={match}
          competition={competition}
          analysis={analysis}
        >
          <div className="max-w-4xl mx-auto space-y-8">
            <MatchHeader ... />
            {/* Match Events card */}
            <MatchOddsPanel ... />
            <Suspense fallback={...}>
              <PredictionsSection ... />
            </Suspense>
          </div>
        </MatchDataProvider>
      </>
    );
    ```

    Note: analysis comes from analysisData?.analysis (already destructured as analysis on line 77)

    DO NOT:
    - Move JSON-LD script inside MatchDataProvider (metadata belongs at root)
    - Remove existing isLive/isFinished variables (child components still use them as props)
    - Try to use useMatch in this Server Component (only Client Components can use hooks)
    - Remove getMatchWithAnalysis call (data still fetched server-side, passed to provider)
  </action>
  <verify>
    grep -E "import.*MatchDataProvider.*from.*@/components/match" src/app/matches/[id]/page.tsx
    grep -E "<MatchDataProvider" src/app/matches/[id]/page.tsx
    grep -E "match=\{match\}" src/app/matches/[id]/page.tsx
    grep -E "competition=\{competition\}" src/app/matches/[id]/page.tsx
    grep -E "analysis=\{analysis\}" src/app/matches/[id]/page.tsx
  </verify>
  <done>MatchDataProvider wraps page content, receives match/competition/analysis props from server fetch, JSON-LD remains at root level</done>
</task>

<task type="auto">
  <name>Task 2: Integrate MatchDataProvider into leagues/[slug]/[match]/page.tsx</name>
  <files>src/app/leagues/[slug]/[match]/page.tsx</files>
  <action>
    Update leagues/[slug]/[match]/page.tsx to wrap content with MatchDataProvider:

    1. Add import at top: import { MatchDataProvider } from '@/components/match/match-data-provider';

    2. In the return statement (around line 167), restructure JSX:
       - Keep MatchPageSchema OUTSIDE MatchDataProvider (schema at root)
       - Keep BreadcrumbsWithSchema OUTSIDE MatchDataProvider (navigation at root)
       - Wrap remaining content (from MatchH1 through closing div) with MatchDataProvider
       - Pass props: match={matchData}, competition={competition}, analysis={analysis}

    Target structure:
    ```tsx
    return (
      <div className="max-w-4xl mx-auto space-y-8">
        <MatchPageSchema match={matchData} ... />
        <BreadcrumbsWithSchema items={breadcrumbs} />

        <MatchDataProvider
          match={matchData}
          competition={competition}
          analysis={analysis}
        >
          <MatchH1 ... />
          <Link href={...}>Back to league</Link>
          <MatchTLDR ... />
          <MatchPageHeader ... />
          <div className="space-y-8">
            {/* All remaining content */}
          </div>
        </MatchDataProvider>
      </div>
    );
    ```

    Note: This page uses matchData (not match) for the match variable. analysis comes from analysisData?.analysis.

    DO NOT:
    - Move MatchPageSchema inside provider (schema belongs at root for SSR)
    - Move BreadcrumbsWithSchema inside provider (navigation at root)
    - Rename matchData to match (keep variable names consistent with existing code)
    - Remove isLive/isFinished variables (child components still use them)
  </action>
  <verify>
    grep -E "import.*MatchDataProvider.*from.*@/components/match" src/app/leagues/[slug]/[match]/page.tsx
    grep -E "<MatchDataProvider" src/app/leagues/[slug]/[match]/page.tsx
    grep -E "match=\{matchData\}" src/app/leagues/[slug]/[match]/page.tsx
    grep -E "competition=\{competition\}" src/app/leagues/[slug]/[match]/page.tsx
    grep -E "analysis=\{analysis\}" src/app/leagues/[slug]/[match]/page.tsx
  </verify>
  <done>MatchDataProvider wraps page content, receives matchData/competition/analysis props, MatchPageSchema and BreadcrumbsWithSchema remain at root level</done>
</task>

<task type="auto">
  <name>Task 3: Verify single source of truth (ARCH-02)</name>
  <files>(verification only - no files modified)</files>
  <action>
    Verify ARCH-02 requirement: No component fetches match data independently.

    Run grep searches to find any child components that call data fetching functions:

    1. Check for getMatchWithAnalysis calls outside page.tsx:
       grep -r "getMatchWithAnalysis" src/components/ --include="*.tsx" --include="*.ts"

    2. Check for getMatchBySlug calls outside page.tsx:
       grep -r "getMatchBySlug" src/components/ --include="*.tsx" --include="*.ts"

    3. Check for direct database imports in match components:
       grep -r "from '@/lib/db/queries'" src/components/match/ --include="*.tsx" --include="*.ts"

    Expected results:
    - No results (components don't fetch data directly)
    - OR results only in components that will be migrated in future phases (document these)

    If components DO fetch data independently:
    - Document which components and what they fetch
    - Note: Migration to useMatch happens in Phase 27+ (this phase establishes infrastructure)
    - This verification task should PASS as informational (not fail the plan)

    Build verification:
    - Run npm run build to ensure TypeScript compiles
    - Run npm run lint to check for errors
  </action>
  <verify>
    npm run build 2>&1 | tail -20
    echo "---"
    echo "Checking for independent data fetching in components..."
    grep -r "getMatchWithAnalysis\|getMatchBySlug" src/components/ --include="*.tsx" --include="*.ts" || echo "No independent fetching found in components"
    grep -r "from '@/lib/db/queries'" src/components/match/ --include="*.tsx" --include="*.ts" || echo "No direct db imports in match components"
  </verify>
  <done>Verification confirms: page.tsx files are single source of data, components receive data via props (future phases will migrate to useMatch hook)</done>
</task>

</tasks>

<verification>
After completion:
1. Both page.tsx files import and use MatchDataProvider
2. MatchDataProvider receives match, competition, analysis props in both pages
3. JSON-LD/MatchPageSchema/BreadcrumbsWithSchema remain OUTSIDE provider
4. Build passes: npm run build
5. Grep confirms no components fetch match data independently
6. Data flow: Server Component fetch -> MatchDataProvider props -> Context available to children
</verification>

<success_criteria>
Phase 26 requirements complete:
- ARCH-01: MatchDataProvider context wraps both match page contents
- ARCH-02: No component fetches match data independently (verified by grep)
- ARCH-03: Match state derived once in provider (matchState from Plan 01)

Data flow established:
- Server Components (page.tsx) fetch data via getMatchWithAnalysis/getMatchBySlug
- Data passed as props to MatchDataProvider (Client Component)
- Future components will consume via useMatch hook (Phase 27+)
- Schema/metadata components remain at root level (SSR optimization)
</success_criteria>

<output>
After completion, create `.planning/phases/26-context-foundation/26-02-SUMMARY.md` with:
- Which pages were updated with file paths
- How MatchDataProvider was integrated (wrapping strategy)
- What remains outside provider (JSON-LD, schemas, breadcrumbs)
- Verification results from grep searches
- Child components still using props (ready for Phase 27 migration)
</output>
