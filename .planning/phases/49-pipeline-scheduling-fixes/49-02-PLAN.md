---
phase: 49-pipeline-scheduling-fixes
plan: 02
type: execute
wave: 2
depends_on: ["49-01"]
files_modified:
  - src/lib/queue/workers/backfill.worker.ts
  - src/lib/queue/setup.ts
  - src/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "Backfill worker checks 48h window for missing analysis (not 12h)"
    - "Backfill worker checks 12h window for missing predictions (not 2h)"
    - "Backfill worker checks 12h window for missing lineups (not 2h)"
    - "Matches missing analysis get analysis scheduled before lineups/predictions are attempted"
    - "Matches missing lineups (but with analysis) get lineups scheduled before predictions are attempted"
    - "All matches within 48h of kickoff have correct delayed jobs after backfill runs"
  artifacts:
    - path: "src/lib/queue/workers/backfill.worker.ts"
      provides: "Wider time windows and dependency chain validation"
      contains: "hoursAhead"
    - path: "src/lib/queue/setup.ts"
      provides: "Updated repeatable job config with 48h window"
      contains: "hoursAhead: 48"
    - path: "src/lib/db/queries.ts"
      provides: "Gap detection queries unchanged (callers pass wider windows)"
  key_links:
    - from: "src/lib/queue/setup.ts"
      to: "src/lib/queue/workers/backfill.worker.ts"
      via: "Repeatable job passes hoursAhead: 48 to backfill worker"
      pattern: "hoursAhead.*48"
    - from: "src/lib/queue/workers/backfill.worker.ts"
      to: "src/lib/db/queries.ts"
      via: "Backfill calls getMatchesMissing* with wider windows"
      pattern: "getMatchesMissing"
---

<objective>
Widen backfill time windows from 12h/2h to 48h/12h, add dependency chain validation so the backfill worker ensures analysis completes before scheduling lineups/predictions, and update the repeatable job configuration.

Purpose: The current narrow windows (12h for analysis, 2h for predictions/lineups) miss matches that should have been scheduled 24-48h ago but weren't due to server restarts. The lack of chain validation means backfill can schedule predictions for matches that don't yet have lineups, causing failures. These fixes address PIPE-03, PIPE-04, and PIPE-05.

Output: Updated backfill.worker.ts with wider windows and chain-aware scheduling, updated setup.ts repeatable job config.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-pipeline-scheduling-fixes/49-RESEARCH.md
@.planning/phases/49-pipeline-scheduling-fixes/49-01-SUMMARY.md
@src/lib/queue/workers/backfill.worker.ts
@src/lib/queue/setup.ts
@src/lib/db/queries.ts
@src/lib/queue/scheduler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Widen backfill time windows and add dependency chain validation</name>
  <files>src/lib/queue/workers/backfill.worker.ts, src/lib/queue/setup.ts</files>
  <action>
    **In `backfill.worker.ts`:**

    1. **Widen the analysis window** — change the `hoursAhead` parameter passed to `getMatchesMissingAnalysis()`. Currently it uses the job's `hoursAhead` parameter (default 12 from setup.ts). The function already accepts the parameter, so this is configuration-driven. However, add an explicit override for analysis to always check 48h regardless of the job parameter:
       ```typescript
       // 1. Find matches missing analysis (ALWAYS check full 48h window)
       const analysisHoursAhead = Math.max(hoursAhead, 48);
       const missingAnalysis = await getMatchesMissingAnalysis(analysisHoursAhead);
       ```

    2. **Widen the lineups window** from 2h to 12h:
       ```typescript
       // 3. Find matches missing lineups (12h window, not 2h)
       const missingLineups = await getMatchesMissingLineups(12);
       ```

    3. **Widen the predictions window** from 2h to 12h:
       ```typescript
       // 4. Find matches missing predictions (12h window, not 2h)
       const missingPredictions = await getMatchesMissingPredictions(12);
       ```

    4. **Add dependency chain validation** — after the analysis section (step 1) and before lineups (step 3), add a chain-aware check. The goal: if a match needs analysis AND lineups, don't schedule lineups until analysis completes. The current code already does this implicitly because `getMatchesMissingLineups` joins on `matchAnalysis` (requires analysis to exist). Similarly, `getMatchesMissingPredictions` requires `lineupsAvailable: true`. So the dependency chain is already enforced by the DB queries. BUT we should add logging to make the chain visible:

       After the analysis loop, add:
       ```typescript
       // Log chain status for debugging
       if (results.analysisTriggered > 0) {
         log.info({ analysisTriggered: results.analysisTriggered }, 'Analysis jobs triggered - lineups/predictions will be backfilled on next cycle after analysis completes');
       }
       ```

    5. **Add a summary of the chain status** to the backfill return value. After the existing results object, add a `chainStatus` field:
       ```typescript
       const results = {
         analysisTriggered: 0,
         oddsTriggered: 0,
         lineupsTriggered: 0,
         predictionsTriggered: 0,
         scoringsTriggered: 0,
         errors: [] as string[],
         windows: { analysis: analysisHoursAhead, lineups: 12, predictions: 12 }, // Track actual windows used
       };
       ```

    **In `setup.ts`:**

    6. **Update the repeatable backfill job** (line 170-181) to use 48h window:
       ```typescript
       // Backfill missing data every hour
       await registerRepeatableJob(
         backfillQueue,
         JOB_TYPES.BACKFILL_MISSING,
         { manual: false, hoursAhead: 48 },  // Was 12, now 48 for full coverage
         {
           repeat: {
             pattern: '5 * * * *',
             tz: 'Europe/Berlin',
           },
           jobId: 'backfill-missing-repeatable',
         }
       );
       ```

    7. **Update the startup backfill job** (line 226-233) to use 48h window:
       ```typescript
       await backfillQueue.add(
         JOB_TYPES.BACKFILL_MISSING,
         { manual: false, hoursAhead: 48 },  // Was 24, now 48 for full coverage
         {
           delay: 5000,
           jobId: STARTUP_BACKFILL_JOB_ID,
         }
       );
       ```

    **Do NOT modify `src/lib/db/queries.ts`** — the query functions already accept `hoursAhead` as a parameter. The callers (backfill worker) pass the wider windows.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Grep backfill.worker.ts for `getMatchesMissingAnalysis` and verify it uses `analysisHoursAhead` (48h minimum).
    Grep backfill.worker.ts for `getMatchesMissingLineups(12)` and `getMatchesMissingPredictions(12)`.
    Grep setup.ts for `hoursAhead: 48` in both the repeatable and startup backfill jobs.
  </verify>
  <done>
    Backfill worker uses 48h window for analysis, 12h for lineups, 12h for predictions. Setup.ts passes 48h to repeatable and startup backfill jobs. Chain validation is inherently enforced by DB query join logic (lineups requires analysis, predictions requires lineups).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build verification and end-to-end validation</name>
  <files>src/lib/queue/scheduler.ts, src/lib/queue/workers/backfill.worker.ts, src/lib/queue/workers/fixtures.worker.ts, src/lib/queue/setup.ts</files>
  <action>
    Perform comprehensive verification of all Phase 49 changes:

    1. **Type check:** Run `npx tsc --noEmit` and verify zero errors.

    2. **Production build:** Run `npx next build --webpack` and verify successful compilation.

    3. **Verify PIPE-01 (catch-up handles past-due):**
       - Grep `scheduler.ts` to confirm NO `if (kickoff <= now)` early exit exists
       - Grep `scheduler.ts` to confirm status-based guard: `match.status === 'finished'`
       - Confirm `const shouldRun = true;` in the lateRunnableJobs block

    4. **Verify PIPE-02 (fixtures schedules existing matches):**
       - Grep `fixtures.worker.ts` to confirm `scheduleMatchJobs` is called without `isNewMatch &&` gate
       - Grep to confirm `isNewMatch` is still referenced (for IndexNow only)

    5. **Verify PIPE-03 (wider windows):**
       - Grep `backfill.worker.ts` for `getMatchesMissingAnalysis` to confirm 48h+ window
       - Grep `backfill.worker.ts` for `getMatchesMissingLineups(12)`
       - Grep `backfill.worker.ts` for `getMatchesMissingPredictions(12)`
       - Grep `setup.ts` for `hoursAhead: 48` (should appear twice: repeatable + startup)

    6. **Verify PIPE-04 (chain validation):**
       - Read `queries.ts` to confirm `getMatchesMissingLineups` uses `innerJoin(matchAnalysis, ...)` (analysis required)
       - Read `queries.ts` to confirm `getMatchesMissingPredictions` uses `eq(matchAnalysis.lineupsAvailable, true)` (lineups required)
       - This confirms the chain: analysis must exist for lineups backfill, lineups must be available for predictions backfill

    7. **Verify PIPE-05 (delayed jobs visible):**
       - Confirm catch-up.ts still calls `getUpcomingMatches(48)` (not narrower)
       - Confirm instrumentation.ts calls `catchUpScheduling()` at startup
       - Confirm setup.ts registers stuck-matches check every 2 minutes

    If any verification fails, fix the issue before proceeding. If the build fails, investigate and fix the root cause (likely a type error from the changes).
  </action>
  <verify>
    `npx tsc --noEmit` exits 0.
    `npx next build --webpack 2>&1 | tail -5` shows "Build completed successfully" or similar.
    All 5 PIPE requirements have passing grep checks as described above.
  </verify>
  <done>
    All 5 PIPE requirements verified. Production build succeeds. Type checking passes. Phase 49 changes are ready for deployment.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes with zero errors
2. `npx next build --webpack` succeeds
3. PIPE-01: scheduleMatchJobs handles past-due matches (no early exit on kickoff <= now)
4. PIPE-02: Fixtures worker schedules all scheduled matches (not just new)
5. PIPE-03: Backfill uses 48h/12h/12h windows (not 12h/2h/2h)
6. PIPE-04: Chain validation enforced by DB query joins (analysis -> lineups -> predictions)
7. PIPE-05: Catch-up (48h) + backfill (48h repeatable) + stuck-match check (2min) ensure coverage
</verification>

<success_criteria>
- Backfill worker checks 48h for analysis, 12h for lineups, 12h for predictions
- Setup.ts configures hoursAhead: 48 for repeatable and startup backfill
- Dependency chain (analysis -> lineups -> predictions) is validated via DB query joins
- Production build passes without errors
- All 5 PIPE requirements are verifiably addressed
</success_criteria>

<output>
After completion, create `.planning/phases/49-pipeline-scheduling-fixes/49-02-SUMMARY.md`
</output>
