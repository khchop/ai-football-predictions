---
phase: 51-retroactive-backfill-script
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queue/types.ts
  - src/lib/queue/workers/predictions.worker.ts
  - src/lib/queue/workers/analysis.worker.ts
autonomous: true

must_haves:
  truths:
    - "Predictions worker generates predictions for finished/live matches when allowRetroactive flag is set"
    - "Analysis worker fetches analysis data for finished/live matches when allowRetroactive flag is set"
    - "Normal pipeline behavior unchanged - workers still skip non-scheduled matches without the flag"
  artifacts:
    - path: "src/lib/queue/types.ts"
      provides: "allowRetroactive flag on PredictMatchPayload and AnalyzeMatchPayload"
      contains: "allowRetroactive"
    - path: "src/lib/queue/workers/predictions.worker.ts"
      provides: "Retroactive prediction generation bypass"
      contains: "allowRetroactive"
    - path: "src/lib/queue/workers/analysis.worker.ts"
      provides: "Retroactive analysis generation bypass"
      contains: "allowRetroactive"
  key_links:
    - from: "src/lib/queue/workers/predictions.worker.ts"
      to: "src/lib/queue/types.ts"
      via: "PredictMatchPayload type import"
      pattern: "allowRetroactive"
    - from: "src/lib/queue/workers/analysis.worker.ts"
      to: "src/lib/queue/types.ts"
      via: "AnalyzeMatchPayload type import"
      pattern: "allowRetroactive"
---

<objective>
Add `allowRetroactive` flag to analysis and predictions worker payloads so both workers can process finished/live matches for retroactive backfill.

Purpose: The existing workers reject non-scheduled matches (analysis.worker.ts line 36, predictions.worker.ts line 104). Phase 51's backfill script needs to generate analysis and predictions for matches that have already finished. Adding an explicit opt-in flag is safer than modifying match status or bypassing checks entirely.

Output: Modified type definitions and worker files that support retroactive processing while preserving normal pipeline behavior.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-retroactive-backfill-script/51-RESEARCH.md
@src/lib/queue/types.ts
@src/lib/queue/workers/predictions.worker.ts
@src/lib/queue/workers/analysis.worker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allowRetroactive flag to queue payload types</name>
  <files>src/lib/queue/types.ts</files>
  <action>
Add `allowRetroactive?: boolean` to both `PredictMatchPayload` and `AnalyzeMatchPayload` interfaces in `src/lib/queue/types.ts`.

For `PredictMatchPayload` (currently at line 33-38):
```typescript
export interface PredictMatchPayload {
  matchId: string;
  attempt: 1 | 2 | 3;
  skipIfDone?: boolean;
  force?: boolean;
  allowRetroactive?: boolean; // Skip status check for retroactive backfill
}
```

For `AnalyzeMatchPayload` (currently at line 11-16):
```typescript
export interface AnalyzeMatchPayload {
  matchId: string;
  externalId: string;
  homeTeam: string;
  awayTeam: string;
  allowRetroactive?: boolean; // Skip status check for retroactive backfill
}
```

These are optional fields so all existing callers continue to work without changes.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors introduced. Grep for `PredictMatchPayload` and `AnalyzeMatchPayload` across the codebase to confirm existing callers don't need updates (optional field addition is backward-compatible).</verify>
  <done>Both payload types include `allowRetroactive?: boolean` field. No existing callers affected.</done>
</task>

<task type="auto">
  <name>Task 2: Update analysis and predictions workers to respect allowRetroactive flag</name>
  <files>src/lib/queue/workers/analysis.worker.ts, src/lib/queue/workers/predictions.worker.ts</files>
  <action>
**In `src/lib/queue/workers/analysis.worker.ts`:**

Modify the job data destructuring (line 20) to extract `allowRetroactive`:
```typescript
const { matchId, externalId, homeTeam, awayTeam, allowRetroactive } = job.data;
```

Modify the status check (line 36-39) to allow retroactive processing:
```typescript
if (match.status !== 'scheduled' && !allowRetroactive) {
  log.info(`Match ${matchId} is ${match.status}, skipping`);
  return { skipped: true, reason: 'match_not_scheduled', status: match.status };
}

if (allowRetroactive) {
  log.info(`Match ${matchId} is ${match.status}, processing retroactively`);
}
```

**In `src/lib/queue/workers/predictions.worker.ts`:**

Modify the job data destructuring (line 75) to extract `allowRetroactive`:
```typescript
const { matchId, skipIfDone = false, allowRetroactive } = job.data;
```

Modify the status check (line 104-107) to allow retroactive processing:
```typescript
if (match.status !== 'scheduled' && !allowRetroactive) {
  log.info(`Match ${matchId} is ${match.status}, skipping`);
  return { skipped: true, reason: 'match_not_scheduled', status: match.status };
}

if (allowRetroactive) {
  log.info(`Match ${matchId} is ${match.status}, generating predictions retroactively`);
}
```

IMPORTANT: Only change the status check condition. Do NOT modify any other worker logic. The rest of the prediction flow (analysis lookup, standings, prompt building, LLM calls, scoring) works identically for retroactive predictions.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Run `npx next build --webpack 2>&1 | tail -20` to verify production build succeeds. Grep for "allowRetroactive" to confirm it appears in both worker files and the types file (3 files total).</verify>
  <done>Both workers check `allowRetroactive` flag before status rejection. When flag is true, workers process matches regardless of status. When flag is false or absent, behavior is unchanged from before.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx next build --webpack` succeeds (production build)
3. `grep -r "allowRetroactive" src/lib/queue/` shows the flag in types.ts, analysis.worker.ts, and predictions.worker.ts
4. No other files need changes (grep confirms no callers pass the flag yet - that happens in Plan 02)
</verification>

<success_criteria>
- PredictMatchPayload and AnalyzeMatchPayload types include `allowRetroactive?: boolean`
- predictions.worker.ts line 104 condition reads `match.status !== 'scheduled' && !allowRetroactive`
- analysis.worker.ts line 36 condition reads `match.status !== 'scheduled' && !allowRetroactive`
- Both workers log retroactive processing when flag is set
- Production build passes
- No existing pipeline behavior affected (flag defaults to undefined/false)
</success_criteria>

<output>
After completion, create `.planning/phases/51-retroactive-backfill-script/51-01-SUMMARY.md`
</output>
