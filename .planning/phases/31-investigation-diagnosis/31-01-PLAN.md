---
phase: 31-investigation-diagnosis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md
autonomous: true

must_haves:
  truths:
    - "Worker process status is verified (running or crashed)"
    - "Queue counts and DLQ entries are documented"
    - "Count of matches missing content since deployment is known"
    - "Root cause is confirmed with confidence level (high/medium/low)"
  artifacts:
    - path: ".planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md"
      provides: "Complete diagnostic report"
      contains: "## Root Cause"
  key_links:
    - from: "Database queries"
      to: "INVESTIGATION.md"
      via: "Query outputs pasted with timestamps"
    - from: "Redis/BullMQ inspection"
      to: "INVESTIGATION.md"
      via: "Queue state documented"
---

<objective>
Run diagnostic queries and commands to investigate the content generation pipeline failure, documenting all findings in INVESTIGATION.md.

Purpose: Confirm root cause of missing content and quantify affected matches before Phase 32 code changes.
Output: Complete diagnostic report at .planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-investigation-diagnosis/31-CONTEXT.md

# Key source files to understand the system
@src/lib/queue/workers/content.worker.ts
@src/lib/content/match-content.ts
@src/lib/content/queries.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database content audit</name>
  <files>.planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md</files>
  <action>
Run database queries to audit match content completeness. Execute these queries against the production database (use `npx tsx` or `psql` as available):

**Query 1: Total matches by status in last 7 days**
```sql
SELECT status, COUNT(*) as count
FROM matches
WHERE kickoff_time >= NOW() - INTERVAL '7 days'
GROUP BY status
ORDER BY count DESC;
```

**Query 2: Matches missing ANY content (summary OR FAQ) since deployment**
Look back at least 7 days. Track separately:
- Matches missing pre-match content
- Matches missing betting content
- Matches missing post-match content
- Matches missing FAQ content

```sql
SELECT
  m.status,
  COUNT(*) as total_matches,
  COUNT(mc.id) as has_content_record,
  COUNT(mc.pre_match_content) as has_pre_match,
  COUNT(mc.betting_content) as has_betting,
  COUNT(mc.post_match_content) as has_post_match,
  COUNT(mc.faq_content) as has_faq
FROM matches m
LEFT JOIN match_content mc ON m.id = mc.match_id
WHERE m.kickoff_time >= NOW() - INTERVAL '7 days'
GROUP BY m.status;
```

**Query 3: Timeline analysis - when did content generation stop working?**
```sql
SELECT
  DATE(mc.created_at) as date,
  COUNT(*) as content_records_created,
  COUNT(mc.pre_match_content) as pre_match_count,
  COUNT(mc.post_match_content) as post_match_count
FROM match_content mc
GROUP BY DATE(mc.created_at)
ORDER BY date DESC
LIMIT 14;
```

**Query 4: Content generation timestamps - last successful generation**
```sql
SELECT
  MAX(pre_match_generated_at) as last_pre_match,
  MAX(betting_generated_at) as last_betting,
  MAX(post_match_generated_at) as last_post_match,
  MAX(faq_generated_at) as last_faq
FROM match_content;
```

**Query 5: Quality audit - check for HTML artifacts, truncation, placeholder text**
```sql
SELECT
  id, match_id,
  LEFT(pre_match_content, 100) as pre_match_sample,
  LEFT(post_match_content, 100) as post_match_sample
FROM match_content
WHERE
  pre_match_content LIKE '%<%'
  OR pre_match_content LIKE '%&lt;%'
  OR post_match_content LIKE '%<%'
  OR post_match_content LIKE '%&lt;%'
LIMIT 10;
```

Create the INVESTIGATION.md file and document:
1. Timestamp when queries were executed
2. Full query outputs (not just summaries)
3. Summary statistics derived from results
  </action>
  <verify>
INVESTIGATION.md exists and contains:
- Section "## Database Audit" with timestamp
- All 5 query results pasted
- Summary of affected match counts
  </verify>
  <done>
Database audit complete with counts for:
- Total matches in each status
- Matches missing each content type
- Last successful content generation timestamp
- Quality issues identified (HTML artifacts)
  </done>
</task>

<task type="auto">
  <name>Task 2: Queue and worker health check</name>
  <files>.planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md</files>
  <action>
Investigate BullMQ queue state and worker process health.

**Queue inspection (use Bull Board admin UI or Redis CLI):**

1. Check queue counts via Redis:
```bash
# Connect to Redis and inspect content queue
redis-cli KEYS "bull:content:*" | head -20
redis-cli LLEN "bull:content:wait"
redis-cli LLEN "bull:content:active"
redis-cli LLEN "bull:content:completed"
redis-cli LLEN "bull:content:failed"
redis-cli LLEN "bull:content:delayed"
```

2. Check Dead Letter Queue (DLQ):
```bash
# Get failed job count and sample
redis-cli ZCARD "bull:content:failed"
redis-cli ZRANGE "bull:content:failed" 0 4 WITHSCORES
```

3. Check worker heartbeat (if available):
```bash
# Look for active workers
redis-cli KEYS "bull:content:meta:*"
redis-cli HGETALL "bull:content:meta"
```

**Worker process inspection:**

1. Check if content worker process is running:
```bash
# Look for node processes running queue workers
ps aux | grep -E "worker|queue" | grep -v grep
```

2. Check recent logs for content worker (if logs accessible):
```bash
# Search for recent content worker activity
grep -i "content" logs/*.log 2>/dev/null | tail -50
# Or check pm2/systemd logs if that's how workers run
pm2 logs content-worker --lines 100 2>/dev/null || echo "No pm2 process found"
```

3. Check for error patterns in logs:
```bash
# Look for rate limit errors, API failures, silent failures
grep -E "rate.limit|429|API.*fail|content.*fail" logs/*.log 2>/dev/null | tail -30
```

**Update INVESTIGATION.md with:**
- Queue state (waiting, active, completed, failed counts)
- DLQ contents (sample of failed jobs with error messages)
- Worker process status (running/stopped/crashed)
- Recent error patterns from logs
- Memory/uptime if available
  </action>
  <verify>
INVESTIGATION.md contains:
- Section "## Queue Health" with Redis queue counts
- Section "## Worker Status" with process check results
- Any DLQ entries documented with error messages
  </verify>
  <done>
Queue and worker health documented:
- BullMQ queue state captured
- DLQ entries inspected
- Worker process status verified
- Error patterns identified (if any)
  </done>
</task>

<task type="auto">
  <name>Task 3: Root cause analysis and conclusions</name>
  <files>.planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md</files>
  <action>
Analyze all gathered data to determine root cause. Add the following sections to INVESTIGATION.md:

**Timeline Correlation:**
Correlate when content stopped generating with:
- Deployment dates (git log for relevant commits)
- Worker restart times (from logs/process info)
- Queue state changes

**Root Cause Hypothesis Testing:**

Test each likely cause against the evidence:

1. **Silent failures (return false instead of throw):**
   - Evidence: Check match-content.ts code - functions return false on error instead of throwing
   - Impact: BullMQ doesn't retry because job "completes" successfully with false return
   - Confidence: HIGH if code shows return false pattern AND DLQ is empty

2. **Scheduling issues (jobs not being added to queue):**
   - Evidence: Check if scan_match_content jobs are being triggered
   - Impact: No jobs = no content generation
   - Confidence: Check queue for recent scan jobs

3. **Rate limits (Together AI 429 errors):**
   - Evidence: Look for 429 errors in logs
   - Impact: Would cause failures but jobs would retry and eventually succeed (or go to DLQ)
   - Confidence: Check DLQ for rate limit errors

4. **Worker death (process crashed and didn't restart):**
   - Evidence: Process check, uptime, last heartbeat
   - Impact: Queue accumulates jobs but nothing processes them
   - Confidence: Check active worker count

**Write conclusions section:**

```markdown
## Root Cause

**Primary Cause:** [One sentence stating the root cause]

**Confidence Level:** [HIGH | MEDIUM | LOW]

**Evidence:**
1. [Evidence point 1]
2. [Evidence point 2]
3. [Evidence point 3]

**Ruling Out Alternative Causes:**
- [Alternative 1]: Ruled out because [reason]
- [Alternative 2]: Ruled out because [reason]

**Affected Scope:**
- Total matches affected: [N]
- Date range: [start] to [end]
- Content types affected: [list]

**Data Gaps/Limitations:**
- [Any incomplete data or logs that limited analysis]
```

NOTE: This phase is diagnosis only. Do NOT include fix recommendations - that's Phase 32+.
  </action>
  <verify>
INVESTIGATION.md contains:
- Section "## Root Cause" with confidence level
- Evidence supporting the diagnosis
- Alternative causes ruled out with reasoning
- Affected scope quantified
- Data gaps acknowledged
  </verify>
  <done>
Root cause confirmed with:
- Primary cause identified
- Confidence level stated (HIGH/MEDIUM/LOW)
- Evidence documented
- Alternatives ruled out
- Affected scope quantified
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. INVESTIGATION.md exists at .planning/phases/31-investigation-diagnosis/31-INVESTIGATION.md
2. Contains all required sections:
   - Database Audit (with timestamps and full query outputs)
   - Queue Health (with Redis queue counts)
   - Worker Status (with process check results)
   - Root Cause (with confidence level and evidence)
3. All four success criteria from ROADMAP.md are addressed:
   - Worker process status is verified
   - Queue counts and DLQ entries are documented
   - Count of matches missing content in last 7 days is known
   - Root cause is confirmed with reasoning
</verification>

<success_criteria>
Phase 31 success when INVESTIGATION.md contains:

1. **Worker verification:** "Worker is [running/stopped/crashed] - evidence: [process check output]"
2. **Queue documentation:** "Waiting: N, Active: N, Failed: N, DLQ: N jobs"
3. **Missing content count:** "X matches missing content out of Y total (Z%)"
4. **Root cause:** "Primary cause: [cause] - Confidence: [HIGH/MEDIUM/LOW]"

All findings must include execution timestamps for audit trail.
</success_criteria>

<output>
After completion, create `.planning/phases/31-investigation-diagnosis/31-01-SUMMARY.md` following the summary template.

The INVESTIGATION.md file is the primary deliverable and will inform Phase 32 (Make Failures Visible) implementation.
</output>
