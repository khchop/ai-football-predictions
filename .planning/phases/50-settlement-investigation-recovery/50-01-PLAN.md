---
phase: 50-settlement-investigation-recovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/investigate-settlement-failures.ts
  - src/lib/queue/workers/scoring.worker.ts
  - src/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "Root cause of all 43 failed settlement jobs is identified and logged to a JSON file"
    - "Settlement worker distinguishes between 'no predictions yet' (retry) and 'no predictions by design' (skip)"
    - "Finished match with analysis but zero predictions triggers BullMQ retry (not silent skip)"
    - "Finished match with no analysis and no predictions is skipped gracefully (expected state)"
  artifacts:
    - path: "scripts/investigate-settlement-failures.ts"
      provides: "DLQ + queue investigation script"
      min_lines: 50
    - path: "src/lib/queue/workers/scoring.worker.ts"
      provides: "Fixed zero-prediction handling"
      contains: "getMatchAnalysisByMatchId"
    - path: "src/lib/db/queries.ts"
      provides: "getFinishedMatchesWithZeroPredictions query"
      contains: "getFinishedMatchesWithZeroPredictions"
  key_links:
    - from: "src/lib/queue/workers/scoring.worker.ts"
      to: "src/lib/db/queries.ts"
      via: "getMatchAnalysisByMatchId call"
      pattern: "getMatchAnalysisByMatchId\\(matchId\\)"
    - from: "scripts/investigate-settlement-failures.ts"
      to: "src/lib/queue/dead-letter.ts"
      via: "getDeadLetterJobs import"
      pattern: "getDeadLetterJobs"
---

<objective>
Investigate all 43 failed settlement jobs to identify root cause, then fix the scoring worker to handle zero-prediction matches gracefully instead of silently skipping them.

Purpose: Root cause analysis prevents blind retry, and the scoring worker fix ensures the settlement pipeline correctly distinguishes retriable errors from expected skips (SETTLE-01, SETTLE-02).
Output: Investigation script with exported JSON results, fixed scoring worker with conditional retry logic, new query for finding finished matches with zero predictions.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-settlement-investigation-recovery/50-RESEARCH.md

@src/lib/queue/dead-letter.ts
@src/lib/queue/workers/scoring.worker.ts
@src/lib/queue/index.ts
@src/lib/queue/types.ts
@src/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settlement failure investigation script</name>
  <files>scripts/investigate-settlement-failures.ts</files>
  <action>
Create a standalone investigation script at `scripts/investigate-settlement-failures.ts` that:

1. Connects to Redis using the REDIS_URL environment variable (same pattern as other scripts in `/scripts/`)
2. Queries the DLQ via `getDeadLetterJobs(100, 0)` and `getDeadLetterCount()` from `@/lib/queue/dead-letter`
3. Queries the settlement queue's failed jobs via `settlementQueue.getFailed(0, -1)` and `settlementQueue.getFailedCount()`
4. For each failed job (from both DLQ and queue), extracts:
   - jobId, matchId (from data), failedReason, attemptsMade, timestamp
   - First 3 lines of stacktrace (if available)
5. Groups failures by error reason/pattern to identify root cause categories
6. Outputs a summary to stdout:
   - Total DLQ entries, total queue failed entries
   - Failure reason breakdown (count per unique reason)
   - List of affected match IDs
7. Writes detailed results to `scripts/output/settlement-investigation.json`

Use `dotenv` to load .env for REDIS_URL. Pattern after existing scripts like `scripts/check-fallback-rate.ts`.

Include a `mkdir -p scripts/output` at the start to ensure the output directory exists.

The script should be runnable with `npx tsx scripts/investigate-settlement-failures.ts`.
  </action>
  <verify>
Run `npx tsc --noEmit scripts/investigate-settlement-failures.ts` (or verify TypeScript compiles cleanly).
Verify the script structure matches the pattern of existing scripts in `/scripts/`.
  </verify>
  <done>
Investigation script exists, compiles without errors, and is ready to run against production Redis to identify root cause of 43 failed settlement jobs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix scoring worker zero-prediction handling and add query</name>
  <files>src/lib/queue/workers/scoring.worker.ts, src/lib/db/queries.ts</files>
  <action>
**In `src/lib/db/queries.ts`:**

1. Add a new exported function `getFinishedMatchesWithZeroPredictions(daysBehind: number = 7)` that finds finished matches with zero predictions from the last N days:
   - Query matches where `status = 'finished'`
   - AND `kickoffTime >= (now - daysBehind * 24h)`
   - AND `homeScore IS NOT NULL` and `awayScore IS NOT NULL`
   - LEFT JOIN predictions on matchId
   - GROUP BY match columns
   - HAVING `COUNT(predictions.id) = 0`
   - Order by kickoffTime DESC
   - Return `Match[]`

2. Import `getMatchAnalysisByMatchId` (already exists at line ~1363 in queries.ts).

**In `src/lib/queue/workers/scoring.worker.ts`:**

1. Import `getMatchAnalysisByMatchId` from `@/lib/db/queries`
2. Replace the zero-prediction handling block (lines 64-67) from:
   ```typescript
   if (predictions.length === 0) {
     log.info(`No predictions found for match ${matchId}`);
     return { skipped: true, reason: 'no_predictions' };
   }
   ```
   To the conditional retry pattern:
   ```typescript
   if (predictions.length === 0) {
     // Check if match was analyzed - if so, predictions SHOULD exist (pipeline failure)
     const analysisData = await getMatchAnalysisByMatchId(matchId);

     if (analysisData?.analysis) {
       // Match was analyzed but has no predictions - upstream pipeline failure
       // Throw to trigger BullMQ retry with exponential backoff
       log.warn({ matchId }, 'Match has analysis but zero predictions - upstream pipeline issue');
       throw new Error(
         `Settlement deferred: match ${matchId} has analysis but zero predictions. ` +
         `Prediction worker may not have run yet.`
       );
     } else {
       // Match never analyzed - won't have predictions (expected for old/imported matches)
       log.info({ matchId }, 'Match skipped settlement - no analysis or predictions (by design)');
       return {
         skipped: true,
         reason: 'no_analysis_or_predictions',
         expected: true,
       };
     }
   }
   ```

This ensures:
- Matches with analysis but no predictions are retried (BullMQ exponential backoff: 30s, 60s, 120s, 240s, 480s)
- Matches without analysis are skipped cleanly (these are old/imported matches that were never in the pipeline)
- After 5 retries, if predictions still don't exist, the job moves to DLQ for manual investigation
  </action>
  <verify>
1. `npm run build` passes (no TypeScript errors)
2. Verify the scoring worker now imports `getMatchAnalysisByMatchId`
3. Verify `getFinishedMatchesWithZeroPredictions` exists in queries.ts and returns Match[]
  </verify>
  <done>
Scoring worker handles zero-prediction matches with conditional retry logic. Matches with analysis but no predictions throw an error (triggering BullMQ retry). Matches with no analysis are skipped gracefully. New query `getFinishedMatchesWithZeroPredictions` is available for backfill use.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `scoring.worker.ts` contains `getMatchAnalysisByMatchId` import and conditional retry logic
3. `queries.ts` contains `getFinishedMatchesWithZeroPredictions` function
4. `scripts/investigate-settlement-failures.ts` exists and compiles
5. The zero-prediction handling distinguishes retry vs skip based on analysis data presence
</verification>

<success_criteria>
- Investigation script ready to run against production Redis (SETTLE-01 preparation)
- Scoring worker correctly retries when analysis exists but predictions don't (SETTLE-02)
- Scoring worker correctly skips when no analysis exists (expected state)
- New query available for finding finished matches with zero predictions (foundation for SETTLE-03)
- Build passes with all changes
</success_criteria>

<output>
After completion, create `.planning/phases/50-settlement-investigation-recovery/50-01-SUMMARY.md`
</output>
