---
phase: 50-settlement-investigation-recovery
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - src/app/api/admin/settlement/retry/route.ts
  - src/lib/queue/workers/backfill.worker.ts
  - scripts/backfill-settlement.ts
autonomous: true

must_haves:
  truths:
    - "Admin can retry failed settlement jobs via API endpoint"
    - "Admin can clear failed settlement jobs from DLQ after successful retry"
    - "Backfill worker catches finished matches that need scoring (including zero-prediction edge case)"
    - "All finished matches from last 7 days with predictions have settlement records"
    - "Running backfill twice produces no duplicate scoring (idempotent via jobId)"
  artifacts:
    - path: "src/app/api/admin/settlement/retry/route.ts"
      provides: "Admin retry API for failed settlement jobs"
      exports: ["POST", "DELETE"]
    - path: "src/lib/queue/workers/backfill.worker.ts"
      provides: "Extended backfill with zero-prediction match detection"
      contains: "getFinishedMatchesWithZeroPredictions"
    - path: "scripts/backfill-settlement.ts"
      provides: "One-shot settlement backfill for last 7 days"
      min_lines: 40
  key_links:
    - from: "src/app/api/admin/settlement/retry/route.ts"
      to: "src/lib/queue/index.ts"
      via: "getSettlementQueue + settlementQueue.getFailed"
      pattern: "getSettlementQueue|settlementQueue"
    - from: "src/lib/queue/workers/backfill.worker.ts"
      to: "src/lib/db/queries.ts"
      via: "getFinishedMatchesWithZeroPredictions import"
      pattern: "getFinishedMatchesWithZeroPredictions"
    - from: "scripts/backfill-settlement.ts"
      to: "src/lib/db/queries.ts"
      via: "getMatchesNeedingScoring + getFinishedMatchesWithZeroPredictions"
      pattern: "getMatchesNeedingScoring|getFinishedMatchesWithZeroPredictions"
---

<objective>
Create admin retry API, extend backfill worker to catch zero-prediction matches, and create a one-shot settlement backfill script that settles all finished matches from the last 7 days.

Purpose: Provides the tools to clear failed jobs (SETTLE-04), extends backfill coverage (SETTLE-03), and ensures all recent finished matches have settlement records (success criteria 5).
Output: Admin retry endpoint, extended backfill worker, settlement backfill script.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-settlement-investigation-recovery/50-RESEARCH.md
@.planning/phases/50-settlement-investigation-recovery/50-01-SUMMARY.md

@src/lib/queue/dead-letter.ts
@src/lib/queue/workers/scoring.worker.ts
@src/lib/queue/workers/backfill.worker.ts
@src/lib/queue/index.ts
@src/lib/queue/types.ts
@src/lib/db/queries.ts
@src/app/api/admin/dlq/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin settlement retry API and extend backfill worker</name>
  <files>src/app/api/admin/settlement/retry/route.ts, src/lib/queue/workers/backfill.worker.ts</files>
  <action>
**Create `src/app/api/admin/settlement/retry/route.ts`:**

Admin API endpoint for retrying failed settlement jobs and clearing them from DLQ. Follow the exact pattern of `src/app/api/admin/dlq/route.ts`:

1. **POST /api/admin/settlement/retry** - Retry failed settlement jobs:
   - Rate limited using `RATE_LIMIT_PRESETS.admin`
   - Admin auth via `requireAdminAuth(req)`
   - Gets failed jobs from settlement queue via `getSettlementQueue().getFailed(0, -1)`
   - For each failed job:
     a. Remove the failed job from queue (`await job.remove()`)
     b. Re-queue with fresh data: fetch match from DB via `getMatchById(job.data.matchId)`
     c. Skip if match not found or not finished
     d. Use idempotent jobId: `settle-retry-${matchId}`
   - Also check DLQ via `getDeadLetterJobs()` for settlement-queue entries
   - For DLQ entries, re-queue the match and delete from DLQ via `deleteDeadLetterEntry()`
   - Return JSON: `{ retriedFromQueue: N, retriedFromDlq: M, skipped: K, errors: [] }`

2. **DELETE /api/admin/settlement/retry** - Clear failed settlement jobs without retrying:
   - Same auth + rate limiting
   - Removes failed jobs from queue (`job.remove()`)
   - Clears settlement entries from DLQ
   - Return JSON: `{ clearedFromQueue: N, clearedFromDlq: M }`

Import from existing modules:
- `getSettlementQueue` from `@/lib/queue/index`
- `getDeadLetterJobs, deleteDeadLetterEntry` from `@/lib/queue/dead-letter`
- `getMatchById` from `@/lib/db/queries`
- `checkRateLimit, getRateLimitKey, createRateLimitHeaders, RATE_LIMIT_PRESETS` from `@/lib/utils/rate-limiter`
- `requireAdminAuth` from `@/lib/utils/admin-auth`
- `sanitizeError` from `@/lib/utils/error-sanitizer`
- `JOB_TYPES` from `@/lib/queue/index`

**Extend `src/lib/queue/workers/backfill.worker.ts`:**

After the existing scoring section (step 5, around line 371), add a new section (step 6):

```typescript
// 6. Find finished matches with zero predictions (may need upstream pipeline re-run)
const zeroPredictionMatches = await getFinishedMatchesWithZeroPredictions(7);

for (const match of zeroPredictionMatches) {
  try {
    // Queue settlement job - the scoring worker will handle the conditional
    // retry logic (check analysis, throw if has analysis but no predictions)
    const jobId = `settle-zero-pred-${match.id}`;
    const existingJob = await settlementQueue.getJob(jobId);

    if (!existingJob) {
      await settlementQueue.add(
        JOB_TYPES.SETTLE_MATCH,
        {
          matchId: match.id,
          homeScore: match.homeScore ?? 0,
          awayScore: match.awayScore ?? 0,
          status: match.status,
        },
        {
          delay: 1000,
          priority: 2, // Lower priority than normal settlement
          jobId,
        }
      );
      results.scoringsTriggered++;
    }
  } catch (error: any) {
    if (!error.message?.includes('already exists')) {
      addError(`Zero-pred settlement ${match.id}: ${error.message}`);
    }
  }
}
```

Add `getFinishedMatchesWithZeroPredictions` to the import from `@/lib/db/queries`.

This ensures the hourly backfill worker automatically detects and attempts to settle finished matches with zero predictions.
  </action>
  <verify>
1. `npm run build` passes
2. New file exists: `src/app/api/admin/settlement/retry/route.ts`
3. Backfill worker imports and uses `getFinishedMatchesWithZeroPredictions`
4. Settlement retry endpoint follows same auth/rate-limit pattern as DLQ endpoint
  </verify>
  <done>
Admin can POST to `/api/admin/settlement/retry` to retry all failed settlement jobs (from queue and DLQ). Backfill worker now also catches finished matches with zero predictions and queues them for settlement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create one-shot settlement backfill script</name>
  <files>scripts/backfill-settlement.ts</files>
  <action>
Create `scripts/backfill-settlement.ts` - a one-shot script to settle all finished matches from last 7 days. This is the manual trigger for SETTLE-03 / success criteria 5.

The script should:

1. Load environment via `dotenv/config`
2. Connect to database and Redis
3. Call `getMatchesNeedingScoring()` to find finished matches with pending (unscored) predictions
4. Call `getFinishedMatchesWithZeroPredictions(7)` to find finished matches with no predictions at all
5. For matches needing scoring (have pending predictions):
   - Queue settlement job with idempotent jobId `settle-backfill-${matchId}`
   - Use priority 1 (high)
6. For zero-prediction matches:
   - Queue settlement job with idempotent jobId `settle-backfill-zero-${matchId}`
   - Use priority 2 (lower, since scoring worker will retry/skip based on analysis)
7. Print summary:
   - Total matches needing scoring: N
   - Total matches with zero predictions: M
   - Jobs queued: K
   - Duplicates skipped: L
8. Wait 2 seconds for jobs to be dispatched, then exit cleanly

Pattern after `scripts/trigger-rescore.ts` for database and queue initialization.

Make it runnable via `npx tsx scripts/backfill-settlement.ts`.

Add optional CLI argument `--days N` (default 7) to control the lookback window.
  </action>
  <verify>
1. `npx tsc --noEmit scripts/backfill-settlement.ts` compiles without errors
2. Script imports from correct modules
3. Script uses idempotent jobIds to prevent duplicate settlement
  </verify>
  <done>
Settlement backfill script exists and can be run to settle all finished matches from the last 7 days. Uses idempotent jobIds so running twice produces no duplicates. Covers both matches with pending predictions and matches with zero predictions.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with all changes
2. Admin settlement retry API exists with POST and DELETE handlers
3. Backfill worker detects zero-prediction finished matches
4. Settlement backfill script compiles and follows existing script patterns
5. All new queue jobs use idempotent jobIds (no duplicate processing)
6. Admin endpoint follows existing auth + rate-limit patterns (same as DLQ API)
</verification>

<success_criteria>
- Failed settlement jobs can be retried via admin API (SETTLE-04)
- Failed settlement jobs can be cleared from DLQ after retry (SETTLE-04)
- Backfill worker catches zero-prediction finished matches (SETTLE-03)
- One-shot backfill script can settle all finished matches from last 7 days (success criteria 5)
- All operations are idempotent (safe to run multiple times)
- Build passes with all changes
</success_criteria>

<output>
After completion, create `.planning/phases/50-settlement-investigation-recovery/50-02-SUMMARY.md`
</output>
