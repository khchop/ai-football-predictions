---
phase: 09-critical-seo-errors
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/matches/[id]/page.tsx
  - src/app/leagues/[slug]/[match]/page.tsx
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "/matches/{uuid} redirects to /leagues/{competition.id}/{match-slug} with 301"
    - "No redirect chains exist (single hop from alias to canonical)"
    - "500 error on Genoa vs Bologna page is resolved or identified as data issue"
    - "All redirects are permanent (301/308) not temporary (307)"
  artifacts:
    - path: "src/app/matches/[id]/page.tsx"
      provides: "Legacy match page with corrected redirect URL"
      contains: "competition.id"
    - path: "next.config.ts"
      provides: "Redirect rules for legacy long-form URLs if needed"
  key_links:
    - from: "src/app/matches/[id]/page.tsx"
      to: "/leagues/{id}/{slug}"
      via: "redirect call"
      pattern: "redirect\\(.*leagues.*competition\\.id"
---

<objective>
Fix redirect chain issues and investigate 500 error, ensuring all redirects use correct canonical URLs and are permanent.

Purpose: Eliminates broken redirect chains (SEO-T02), investigates 500 error on Genoa vs Bologna page (SEO-T01), and ensures legacy /matches/{uuid} URLs redirect correctly.
Output: Clean redirect paths with no chains, 500 error resolved or documented.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-critical-seo-errors/09-CONTEXT.md
@.planning/phases/09-critical-seo-errors/09-01-SUMMARY.md

@src/app/matches/[id]/page.tsx
@src/app/leagues/[slug]/[match]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix legacy match page redirect to use competition.id</name>
  <files>src/app/matches/[id]/page.tsx</files>
  <action>
1. Current code (line ~81-83):
   ```typescript
   if (match.slug && competition.slug) {
     redirect(`/leagues/${competition.slug}/${match.slug}`);
   }
   ```
   This redirects to database slug (premier-league) which then triggers another redirect to ID (epl).

2. Fix to use competition.id directly:
   ```typescript
   if (match.slug && competition.id) {
     redirect(`/leagues/${competition.id}/${match.slug}`);
   }
   ```

   Note: `competition` here comes from database join. The database competition record has an `id` field that matches the static config ID.

3. Verify the redirect is permanent:
   - Next.js `redirect()` uses 307 by default
   - For SEO, we want 308 (permanent redirect for POST/GET)
   - Import and use: `redirect(url, RedirectType.permanent)` from 'next/navigation'

4. If competition.id from DB doesn't match static config:
   - Query returns competition record which should have id = 'epl', 'ucl', etc.
   - Verify by checking database schema or existing query output
  </action>
  <verify>
1. `npx tsc --noEmit src/app/matches/[id]/page.tsx`
2. Test with a known match UUID:
   `curl -I http://localhost:3000/matches/{some-uuid}`
   Should return 308 redirect to /leagues/{short-id}/{match-slug}
  </verify>
  <done>
Legacy /matches/{uuid} URLs redirect directly to canonical /leagues/{competition.id}/{match-slug}.
No intermediate redirect through long-form slug.
Redirect is permanent (308).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add explicit redirects for legacy long-form URLs in next.config</name>
  <files>next.config.ts</files>
  <action>
1. Add redirects array to next.config.ts for explicit SEO handling:
   ```typescript
   async redirects() {
     return [
       // Long-form to short-form league redirects
       { source: '/leagues/premier-league/:path*', destination: '/leagues/epl/:path*', permanent: true },
       { source: '/leagues/champions-league/:path*', destination: '/leagues/ucl/:path*', permanent: true },
       { source: '/leagues/europa-league/:path*', destination: '/leagues/uel/:path*', permanent: true },
       { source: '/leagues/la-liga/:path*', destination: '/leagues/laliga/:path*', permanent: true },
       { source: '/leagues/serie-a/:path*', destination: '/leagues/seriea/:path*', permanent: true },
       { source: '/leagues/ligue-1/:path*', destination: '/leagues/ligue1/:path*', permanent: true },
     ];
   },
   ```

2. This provides edge-level redirects that:
   - Happen before page routing (faster)
   - Return proper 308 permanent redirects
   - Handle both league index and match URLs via :path* wildcard

3. Note: This is complementary to the application-level redirects in 09-01.
   The config redirects handle the case faster, the app redirects are fallback.

4. Check if redirects already exist in next.config.ts and merge appropriately.
  </action>
  <verify>
1. `npm run build` or `npx next build` - verify no config errors
2. `curl -I http://localhost:3000/leagues/premier-league` - should return 308 redirect (may need production build)
  </verify>
  <done>
Edge-level redirects configured for all long-form to short-form mappings.
Redirects are permanent (308).
Config builds without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Investigate and fix 500 error on Genoa vs Bologna page</name>
  <files>src/app/leagues/[slug]/[match]/page.tsx</files>
  <action>
1. The 500 error reported by Ahrefs on `/leagues/seriea/genoa-vs-bologna-2026-01-25`:
   - Currently returns 404 per research, suggesting data issue not code error
   - Could have been transient DB connection error during Ahrefs crawl

2. Add defensive error handling to match page:
   - Wrap database queries in try/catch
   - Return meaningful error or notFound() on database failures
   - Log errors for debugging

3. Check if the match exists in database:
   ```bash
   # In dev console or via script
   SELECT * FROM matches WHERE slug LIKE '%genoa-vs-bologna-2026-01-25%';
   ```

4. If match doesn't exist:
   - This is expected 404, not 500
   - The 500 may have been temporary infrastructure issue
   - Document as "resolved - transient error"

5. If match exists but page errors:
   - Check for null handling issues in the page
   - Add null checks on match data fields (homeTeamLogo, analysis, etc.)

6. Add error boundary or try/catch to prevent 500s:
   ```typescript
   try {
     const result = await getMatchBySlug(slug, match);
     if (!result) notFound();
     // ... rest of page
   } catch (error) {
     console.error('Match page error:', error);
     notFound(); // Graceful degradation to 404 instead of 500
   }
   ```
  </action>
  <verify>
1. `npx tsc --noEmit src/app/leagues/[slug]/[match]/page.tsx`
2. Check database for the specific match
3. Test a valid match page loads without error
4. Test an invalid match returns 404 not 500
  </verify>
  <done>
Match page has defensive error handling.
Invalid/missing matches return 404 not 500.
Specific Genoa vs Bologna issue documented (either fixed or identified as transient).
Requirement SEO-T01 addressed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Test redirect chain: `curl -IL http://localhost:3000/leagues/premier-league/some-match`
   - Should be single 308 redirect to /leagues/epl/some-match
2. Test legacy match URL: `curl -IL http://localhost:3000/matches/{uuid}`
   - Should redirect directly to canonical URL, not through intermediate
3. Test invalid match: `curl -I http://localhost:3000/leagues/seriea/nonexistent-match`
   - Should return 404, not 500
4. Run `grep -n "307" src/` to ensure no temporary redirects remain
</verification>

<success_criteria>
- Legacy /matches/{uuid} redirects use competition.id directly (no chain)
- All redirects are permanent (301/308)
- No redirect goes through long-form slug intermediary
- 500 error is resolved or documented as transient
- Invalid match URLs return 404 not 500
- Requirements SEO-T01 and SEO-T02 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/09-critical-seo-errors/09-03-SUMMARY.md`
</output>
