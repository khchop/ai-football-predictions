---
phase: 09-critical-seo-errors
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/sitemap/leagues.xml/route.ts
  - src/app/sitemap/matches/[id]/route.ts
  - src/components/match-card.tsx
  - src/app/leagues/[slug]/league-hub-content.tsx
autonomous: true

must_haves:
  truths:
    - "Sitemap at /sitemap/leagues.xml lists only canonical short-form URLs"
    - "Match sitemap URLs use competition.id not database slug"
    - "Match card links use /leagues/{competition.id}/{match-slug} format"
    - "No internal links point to long-form league slugs"
  artifacts:
    - path: "src/app/sitemap/leagues.xml/route.ts"
      provides: "Sitemap generating canonical league URLs from static config"
      contains: "COMPETITIONS"
    - path: "src/components/match-card.tsx"
      provides: "Match card with corrected link URLs"
      contains: "competition.id"
  key_links:
    - from: "src/app/sitemap/leagues.xml/route.ts"
      to: "COMPETITIONS"
      via: "import from competitions.ts"
      pattern: "from '@/lib/football/competitions'"
    - from: "src/components/match-card.tsx"
      to: "competition.id"
      via: "URL construction"
      pattern: "leagues/\\$\\{.*competition\\.id"
---

<objective>
Update sitemap generation and internal links to use canonical competition IDs instead of database slugs.

Purpose: Ensures sitemap contains valid URLs that won't 404, and all internal links use the canonical short-form URLs (epl, ucl) rather than database slugs (premier-league, champions-league).
Output: Sitemap with canonical URLs, all internal links corrected.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-critical-seo-errors/09-CONTEXT.md
@.planning/phases/09-critical-seo-errors/09-01-SUMMARY.md

@src/app/sitemap/leagues.xml/route.ts
@src/app/sitemap/matches/[id]/route.ts
@src/components/match-card.tsx
@src/app/leagues/[slug]/league-hub-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix league sitemap to use static config IDs</name>
  <files>src/app/sitemap/leagues.xml/route.ts</files>
  <action>
1. Replace database query with static config import:
   - Remove `getDb`, `competitions`, `eq` imports from drizzle
   - Import `COMPETITIONS` from '@/lib/football/competitions'

2. Generate sitemap from static config:
   - Filter to only include active/relevant competitions (e.g., exclude 'international' category if desired, or include all)
   - Map each competition to URL using `competition.id` not database slug:
     ```typescript
     const urls = COMPETITIONS
       .filter(comp => comp.category !== 'international') // Optional: exclude tournaments
       .map(comp => ({
         url: `${BASE_URL}/leagues/${comp.id}`,
         lastmod: today,
         changefreq: 'hourly',
         priority: 0.9,
       }));
     ```

3. Keep same XML generation logic

Note: This approach has one advantage: sitemap always matches what routes accept, since both use static config as source of truth.
  </action>
  <verify>
Start dev server and fetch sitemap:
`curl http://localhost:3000/sitemap/leagues.xml`
Verify URLs use short IDs (epl, ucl, etc.) not long-form slugs
  </verify>
  <done>
League sitemap generated from static COMPETITIONS config.
All URLs use canonical competition.id format.
No 404-prone long-form slugs in sitemap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix match sitemap to use competition ID</name>
  <files>src/app/sitemap/matches/[id]/route.ts</files>
  <action>
1. Current issue: Match sitemap likely uses `competition.slug` from database join

2. Options:
   a) Join with static config to get ID (complex)
   b) Query for competitions.id column instead of slug (simpler if DB has id)
   c) Build a slug-to-id mapping and transform

3. Recommended approach:
   - The database competitions table has an `id` column that matches static config
   - Modify the query to select `competitions.id` and use that for URL generation
   - Change URL template from `/leagues/${comp.slug}/${match.slug}` to `/leagues/${comp.id}/${match.slug}`

4. Verify the competitions table schema has `id` column available (it should - it's the primary key)
  </action>
  <verify>
Fetch a match sitemap section if available, or check TypeScript compiles:
`npx tsc --noEmit src/app/sitemap/matches/[id]/route.ts`
  </verify>
  <done>
Match sitemap URLs use /leagues/{competition.id}/{match-slug} format.
URLs resolve to valid pages without redirect chains.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix match-card internal links to use competition.id</name>
  <files>src/components/match-card.tsx, src/app/leagues/[slug]/league-hub-content.tsx</files>
  <action>
1. In `src/components/match-card.tsx`:
   - Current code (line ~87-89):
     ```typescript
     const matchUrl = match.slug && match.competition.slug
       ? `/leagues/${match.competition.slug}/${match.slug}`
       : `/matches/${match.id}`;
     ```
   - Change to use `competition.id`:
     ```typescript
     const matchUrl = match.slug && match.competition.id
       ? `/leagues/${match.competition.id}/${match.slug}`
       : `/matches/${match.id}`;
     ```

2. Verify the MatchCardProps interface:
   - It already has `competition.id` as string (check interface definition)
   - The `slug` field on competition becomes unused for URL generation

3. Check `src/app/leagues/[slug]/league-hub-content.tsx`:
   - Ensure it passes competition.id to match cards
   - If it's passing data from database queries, verify the competition.id is included in the query results

4. Search for other uses of `competition.slug` in link generation:
   - Run: `grep -rn "competition.slug" src/components/ src/app/`
   - Fix any other instances that generate URLs
  </action>
  <verify>
1. `npx tsc --noEmit src/components/match-card.tsx`
2. In browser, inspect match card links on league page - should be /leagues/epl/... not /leagues/premier-league/...
3. `grep -n "competition.slug" src/components/match-card.tsx` should not find URL-related usage
  </verify>
  <done>
Match card generates URLs using competition.id.
All 128 pages with broken links now link to valid canonical URLs.
No internal navigation leads to 404 pages.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `curl http://localhost:3000/sitemap/leagues.xml` - verify all URLs use short IDs
2. Browse to a league page, inspect match card links in browser DevTools
3. Click a match card - should navigate directly to /leagues/{short-id}/{match-slug}
4. Search codebase: `grep -rn "competition.slug" src/` - verify no URL generation uses slug
</verification>

<success_criteria>
- League sitemap contains only canonical URLs (/leagues/epl, /leagues/ucl, etc.)
- Match sitemap URLs use competition.id
- Match card links use competition.id in URL path
- Zero internal links point to long-form league slugs
- Requirements SEO-T03 and SEO-T04 addressed
</success_criteria>

<output>
After completion, create `.planning/phases/09-critical-seo-errors/09-02-SUMMARY.md`
</output>
