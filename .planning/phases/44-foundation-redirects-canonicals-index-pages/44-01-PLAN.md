---
phase: 44-foundation-redirects-canonicals-index-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/leagues/[slug]/[match]/page.tsx
  - src/lib/seo/metadata.ts
autonomous: true

must_haves:
  truths:
    - "Root layout HTML does not contain <link rel='canonical'> or <link rel='alternate' hreflang> tags"
    - "Match pages at /leagues/{slug}/{match} have self-referential canonical URLs matching their actual route"
    - "html lang='en' attribute is preserved on <html> element"
    - "No page in the app inherits a cascading canonical from root layout"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "Root layout without cascading canonical or hreflang"
      contains: "metadataBase"
    - path: "src/lib/seo/metadata.ts"
      provides: "Match metadata with correct canonical URL path"
      contains: "canonical"
  key_links:
    - from: "src/app/layout.tsx"
      to: "child pages"
      via: "Next.js metadata merging"
      pattern: "alternates.*canonical"
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "src/lib/seo/metadata.ts"
      via: "buildMatchMetadata call"
      pattern: "buildMatchMetadata"
---

<objective>
Remove cascading canonical URL and broken hreflang tags from root layout, and verify/fix match page self-referential canonicals.

Purpose: Prevents Google from seeing every page as a duplicate of the homepage (cascading canonical) and eliminates broken hreflang tags pointing to non-existent subdomains (de.kroam.xyz, es.kroam.xyz, etc.). Also ensures match pages have correct self-referential canonicals matching their actual URL path.

Output: Modified root layout without canonical/hreflang, verified match page canonical strategy.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/layout.tsx
@src/lib/seo/metadata.ts
@src/lib/seo/constants.ts
@src/app/leagues/[slug]/[match]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove cascading canonical and hreflang from root layout</name>
  <files>src/app/layout.tsx</files>
  <action>
    Edit src/app/layout.tsx metadata export to:
    1. REMOVE the `alternates` object entirely (both `canonical` and `languages` properties)
    2. KEEP `metadataBase: new URL('https://kroam.xyz')` — this is needed for relative URL resolution
    3. KEEP `html lang="en"` on the html element (accessibility)
    4. KEEP all other metadata (title, description, keywords, openGraph, twitter, robots)

    The current metadata has:
    ```
    alternates: {
      canonical: 'https://kroam.xyz',
      languages: {
        'en-US': 'https://kroam.xyz',
        'en': 'https://kroam.xyz',
        'de': 'https://de.kroam.xyz',
        'es': 'https://es.kroam.xyz',
        'fr': 'https://fr.kroam.xyz',
        'it': 'https://it.kroam.xyz',
      },
    },
    ```

    Remove the entire `alternates` block. Do NOT add it back per-page here — each page already defines (or will define) its own canonical.

    Also search for any other files that reference hreflang or language alternates:
    - `grep -r "hreflang\|languages:" src/app --include="*.tsx"`
    - If found elsewhere, remove those too (complete hreflang removal per user decision)

    Requirements covered: REDIR-04, I18N-01, I18N-02
  </action>
  <verify>
    1. `grep -r "hreflang\|'de':\|'es':\|'fr':\|'it':" src/app/layout.tsx` returns empty (no hreflang)
    2. `grep "canonical" src/app/layout.tsx` returns empty (no cascading canonical)
    3. `grep 'lang="en"' src/app/layout.tsx` returns a match (lang preserved)
    4. `grep "metadataBase" src/app/layout.tsx` returns a match (metadataBase preserved)
    5. `npx next build --webpack` completes without errors (or `npm run build`)
  </verify>
  <done>Root layout metadata has no alternates.canonical and no alternates.languages. html lang="en" preserved. No hreflang tags appear in any page's root layout HTML.</done>
</task>

<task type="auto">
  <name>Task 2: Verify and fix match page self-referential canonicals</name>
  <files>src/app/leagues/[slug]/[match]/page.tsx, src/lib/seo/metadata.ts</files>
  <action>
    1. Read src/app/leagues/[slug]/[match]/page.tsx to find how it generates metadata (look for generateMetadata function or metadata export).

    2. Check if the canonical URL matches the actual route pattern /leagues/{slug}/{match}:
       - The match page lives at /leagues/[slug]/[match]/page.tsx
       - Its canonical URL MUST be `${BASE_URL}/leagues/${slug}/${matchSlug}` (self-referential)
       - If it currently uses `/matches/${uuid}` as canonical, this is WRONG — fix it

    3. In src/lib/seo/metadata.ts, the `buildMatchMetadata` function currently sets:
       ```
       const url = `/matches/${match.id}`;
       ```
       This path does NOT match the actual route. If the match page uses buildMatchMetadata, either:
       - a) Update buildMatchMetadata to accept the actual URL path, OR
       - b) Override the canonical in the match page's generateMetadata

       Preferred approach (a): Add a `canonicalPath` parameter to buildMatchMetadata:
       ```typescript
       export function buildMatchMetadata(match: MatchSeoData, activeModels?: number, canonicalPath?: string): Metadata {
         const url = canonicalPath || `/matches/${match.id}`;
         // ... rest stays the same
       ```
       Then the match page passes its actual path: `/leagues/${slug}/${matchSlug}`

    4. Verify that canonical URLs use the SHORT-FORM league slug (e.g., /leagues/epl, not /leagues/premier-league) per user decision. The slug parameter from the URL should already be the short form after middleware redirect handles long forms.

    5. Ensure canonical URLs do NOT have trailing slashes (matches existing pattern in codebase).

    Requirements covered: REDIR-05
  </action>
  <verify>
    1. Read the match page's generateMetadata and confirm canonical URL uses /leagues/{slug}/{match} pattern
    2. `grep "canonical" src/app/leagues/[slug]/[match]/page.tsx` or the metadata builder shows self-referential URL
    3. `npx next build --webpack` completes without errors
  </verify>
  <done>Match pages at /leagues/{slug}/{match} have self-referential canonical URLs matching their actual route path. Canonical uses short-form league slug with no trailing slash.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build` or `npx next build --webpack`
2. Root layout has no canonical or hreflang: `grep -E "canonical|hreflang|languages:" src/app/layout.tsx` returns empty
3. Match page has self-referential canonical: The canonical URL in match page metadata matches /leagues/{slug}/{match} pattern
4. No hreflang anywhere: `grep -r "hreflang\|languages:" src/app --include="*.tsx"` returns empty (or only non-metadata references)
</verification>

<success_criteria>
- REDIR-04: Root layout does not set canonical URL (no cascading canonical to child pages)
- REDIR-05: All match pages have self-referential canonical URLs matching /leagues/{slug}/{match}
- I18N-01: Root layout does not declare language alternates for non-functional subdomains
- I18N-02: No hreflang tags pointing to URLs that return 503 or non-200 status codes
</success_criteria>

<output>
After completion, create `.planning/phases/44-foundation-redirects-canonicals-index-pages/44-01-SUMMARY.md`
</output>
