---
phase: 44-foundation-redirects-canonicals-index-pages
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "www.kroam.xyz requests redirect with 301 to https://kroam.xyz (not 302)"
    - "http://kroam.xyz requests redirect with 301 to https://kroam.xyz (not 302)"
    - "No redirect chains exist — any entry URL reaches final destination in one hop"
    - "/matches/UUID requests return 410 Gone status"
    - "API routes still have CORS headers and body size limits"
    - "League slug redirects (premier-league -> epl) are single-hop with www/http"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Unified middleware handling redirects, 410, and CORS"
      contains: "301"
    - path: "next.config.ts"
      provides: "Config without league slug redirects"
      contains: "redirects"
  key_links:
    - from: "src/middleware.ts"
      to: "all routes"
      via: "matcher config"
      pattern: "matcher"
    - from: "src/middleware.ts"
      to: "API routes"
      via: "CORS headers"
      pattern: "Access-Control"
    - from: "next.config.ts"
      to: "src/middleware.ts"
      via: "redirect consolidation"
      pattern: "redirects"
---

<objective>
Rewrite middleware to handle www/http redirects, /matches/UUID 410 Gone, and league slug redirects in a single hop, while preserving existing CORS and body-size logic for API routes. Remove league slug redirects from next.config.ts.

Purpose: Eliminates redirect chains that waste crawl budget and lose link equity. Consolidates all redirect logic in middleware for single-hop resolution. Returns 410 Gone for permanently removed /matches/UUID URLs.

Output: Rewritten middleware.ts with redirect logic, cleaned next.config.ts.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/middleware.ts
@next.config.ts
@src/lib/football/competitions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite middleware with redirect logic and 410 Gone</name>
  <files>src/middleware.ts</files>
  <action>
    Rewrite src/middleware.ts to handle ALL cross-cutting concerns in a single pass:

    **Order of operations in middleware:**
    1. Check /matches/UUID — return 410 Gone immediately
    2. Detect all redirect conditions (www, http, league slug) in ONE pass
    3. If any redirect condition detected, compute final canonical URL and redirect with 301
    4. For API routes, apply existing CORS and body-size logic (preserve current behavior)
    5. For non-redirect, non-API routes, return NextResponse.next()

    **League slug redirects to consolidate from next.config.ts:**
    ```typescript
    const LEAGUE_SLUG_REDIRECTS: Record<string, string> = {
      'premier-league': 'epl',
      'champions-league': 'ucl',
      'europa-league': 'uel',
      'la-liga': 'laliga',
      'serie-a': 'seriea',
      'ligue-1': 'ligue1',
    };
    ```
    These come directly from next.config.ts redirects() and the aliases in competitions.ts.

    **410 Gone for /matches/UUID:**
    - Pattern: pathname starts with `/matches/`
    - Return `new NextResponse('Gone', { status: 410, headers: { 'Content-Type': 'text/plain' } })`
    - Do NOT redirect — return 410 directly

    **Single-hop redirect logic:**
    ```
    Detect: hasWww, isHttp (protocol check may not work in Edge Runtime — check x-forwarded-proto header instead), leagueSlugNeedsRedirect
    Compute: final host (strip www), final protocol (https), final pathname (mapped slug)
    If ANY condition true: redirect to final URL with 301
    ```

    **Important Edge Runtime notes:**
    - `url.protocol` in Edge Runtime may not reliably detect HTTP vs HTTPS
    - Use `request.headers.get('x-forwarded-proto')` to detect HTTP
    - Or use `request.nextUrl.protocol` which Next.js sets correctly

    **Matcher config:**
    - MUST match ALL routes (not just /api/*) for redirects to work
    - Use negative lookahead for static assets:
    ```typescript
    export const config = {
      matcher: [
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp|ico)$).*)',
      ],
    };
    ```
    This runs middleware on ALL routes except static files, including both API and page routes.

    **CORS preservation:**
    - Keep ALL existing CORS functions (handleCORSPreflight, addCORSHeaders, isAllowedOrigin, checkBodySize)
    - Apply CORS logic ONLY to /api/* routes (same as current behavior)
    - The redirect/410 logic runs BEFORE CORS (redirects take priority)

    **Cache headers on redirects:**
    - Add `Cache-Control: public, max-age=31536000` to 301 redirect responses
    - This allows browsers and CDNs to cache the redirect for 1 year

    Requirements covered: REDIR-01, REDIR-02, REDIR-03
  </action>
  <verify>
    1. `grep "301" src/middleware.ts` shows permanent redirect status code
    2. `grep "410" src/middleware.ts` shows Gone status code
    3. `grep "LEAGUE_SLUG_REDIRECTS" src/middleware.ts` shows consolidated slug map
    4. `grep "Access-Control" src/middleware.ts` shows CORS headers preserved
    5. `grep "matcher" src/middleware.ts` shows broad matcher (not just /api/*)
    6. `npx next build --webpack` completes without errors
  </verify>
  <done>Middleware handles www/http redirects with 301, /matches/UUID with 410, and league slug redirects in single hop. CORS preserved for API routes. Matcher covers all routes.</done>
</task>

<task type="auto">
  <name>Task 2: Remove league slug redirects from next.config.ts</name>
  <files>next.config.ts</files>
  <action>
    Edit next.config.ts to remove the league slug redirects since they are now handled in middleware (single-hop with www/http).

    Change the `redirects()` function to return an empty array:
    ```typescript
    async redirects() {
      return [];
    },
    ```

    OR remove the `redirects()` function entirely from the config. Keeping it as empty array is cleaner for future additions.

    **Do NOT modify anything else in next.config.ts** — keep cacheComponents, experimental, images, and Sentry config unchanged.

    Verify that the 6 league slug redirects now in middleware match exactly:
    - premier-league -> epl (with :path*)
    - champions-league -> ucl (with :path*)
    - europa-league -> uel (with :path*)
    - la-liga -> laliga (with :path*)
    - serie-a -> seriea (with :path*)
    - ligue-1 -> ligue1 (with :path*)

    The middleware must handle the :path* portion (subpaths like /leagues/premier-league/arsenal-vs-chelsea -> /leagues/epl/arsenal-vs-chelsea).

    Requirements covered: REDIR-03 (no chains — single source of redirect truth)
  </action>
  <verify>
    1. `grep "premier-league\|champions-league\|europa-league\|la-liga\|serie-a\|ligue-1" next.config.ts` returns empty (redirects removed)
    2. `grep "redirects" next.config.ts` shows empty array or no redirects function
    3. `npx next build --webpack` completes without errors
  </verify>
  <done>League slug redirects removed from next.config.ts. All redirects now handled exclusively in middleware for single-hop resolution.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build` or `npx next build --webpack`
2. Middleware handles all redirect conditions: grep confirms 301, 410, LEAGUE_SLUG_REDIRECTS, CORS in middleware.ts
3. No redirects in next.config.ts: league slug redirects removed
4. Matcher covers all routes: not limited to /api/*
5. CORS preserved: API routes still have Access-Control headers
</verification>

<success_criteria>
- REDIR-01: All www.kroam.xyz requests return 301 to https://kroam.xyz
- REDIR-02: All http://kroam.xyz requests return 301 to https://kroam.xyz
- REDIR-03: No redirect chains exist (single-hop from any entry point to canonical URL)
</success_criteria>

<output>
After completion, create `.planning/phases/44-foundation-redirects-canonicals-index-pages/44-02-SUMMARY.md`
</output>
