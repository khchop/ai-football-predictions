---
phase: 45-sitemap-internal-linking
plan: 04
type: execute
wave: 2
depends_on: ["45-01", "45-02", "45-03"]
files_modified:
  - scripts/audit-internal-links.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Build-time audit script validates sitemap contains no /matches/UUID URLs"
    - "Build-time audit script validates all sitemap URLs use canonical short-form league slugs"
    - "Build-time audit script verifies all expected pages (models, leagues, matches, blog, static) appear in sitemap"
    - "Build-time audit script reports internal link inventory and identifies pages with potential orphan risk"
    - "npm run audit:links runs the audit script successfully"
    - "npm run build runs audit:links before next build"
  artifacts:
    - path: "scripts/audit-internal-links.ts"
      provides: "Build-time internal link and sitemap audit script"
      min_lines: 100
    - path: "package.json"
      provides: "Updated build scripts with audit integration"
      contains: "audit:links"
  key_links:
    - from: "scripts/audit-internal-links.ts"
      to: "sitemap XML output"
      via: "HTTP fetch and XML parsing"
      pattern: "fetch.*sitemap"
    - from: "package.json"
      to: "scripts/audit-internal-links.ts"
      via: "npm script"
      pattern: "audit:links.*tsx.*audit-internal-links"
---

<objective>
Create a build-time audit script that validates sitemap integrity and internal link coverage, then integrate it into the build pipeline.

Purpose: Catch sitemap issues (UUID URLs, non-canonical slugs, missing pages) and potential orphan pages before deployment. Per user decision, the build must fail if bad slugs or sitemap issues are detected. This is the final validation gate for the entire Phase 45.

Output: TypeScript audit script at `scripts/audit-internal-links.ts` and updated `package.json` build scripts.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-sitemap-internal-linking/45-01-SUMMARY.md
@.planning/phases/45-sitemap-internal-linking/45-02-SUMMARY.md
@.planning/phases/45-sitemap-internal-linking/45-03-SUMMARY.md
@src/lib/football/competitions.ts
@src/middleware.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build-time internal link and sitemap audit script</name>
  <files>scripts/audit-internal-links.ts</files>
  <action>
Create `scripts/audit-internal-links.ts` that performs three validation passes:

**Pass 1: Sitemap URL Validation**
- Fetch the sitemap index from `${BASE_URL}/sitemap.xml` (use env var `AUDIT_BASE_URL` or default to `http://localhost:3000`)
- Parse the XML to extract all sub-sitemap URLs
- For each sub-sitemap, fetch and parse the XML
- Collect ALL URLs from all sitemaps into a flat list
- Validate:
  - FAIL if any URL matches `/matches/[0-9a-f-]{36}` (UUID pattern) — SMAP-02
  - FAIL if any URL contains a long-form league slug from the `LEAGUE_SLUG_REDIRECTS` map (e.g., `/leagues/premier-league`, `/leagues/champions-league`, `/leagues/europa-league`, `/leagues/la-liga`, `/leagues/serie-a`, `/leagues/ligue-1`) — REDIR-06
  - WARN if any URL returns non-200 status when fetched (spot-check 5 random URLs)

**Pass 2: Sitemap Completeness**
- Connect to database using `getDb()` from `@/lib/db`
- Enumerate expected pages:
  - Static: `/`, `/about`, `/leaderboard`, `/matches`, `/blog`, `/methodology`, `/models`, `/leagues`
  - Models: All from `models` table (active), generate `/models/${id}`
  - Leagues: All 17 competitions from `COMPETITIONS` config, generate `/leagues/${comp.id}`
  - Matches: Count from `matches` table where slug is not null
  - Blog: Count from `blogPosts` table where status = 'published'
- Cross-reference with sitemap URLs:
  - FAIL if `/models` or `/leagues` missing from sitemap — SMAP-04
  - FAIL if any competition ID missing from leagues sitemap — SMAP-03
  - WARN if model count in sitemap differs from database count
  - WARN if match count in sitemap differs significantly from database count (>5% difference)

**Pass 3: Internal Link Architecture Inventory**
This pass does NOT crawl pages (too slow for build). Instead, it performs a structural analysis:
- Analyze known link sources for each page type:
  - Model pages: inbound from `/models` index (1), leaderboard (1), league top-5 (N), related models widget (N), match predicting-models widget (N). Report: "Model pages have 3+ guaranteed link sources"
  - League pages: inbound from `/leagues` index (1), breadcrumbs on match pages (N), model leagues-covered widget (N), navigation. Report link source count.
  - Match pages: inbound from league hub match grid (1), model recent-predictions widget (N), blog posts (variable). Report link source count.
  - Blog pages: inbound from `/blog` index (1), related articles widget (variable). Report link source count.
- This is a STRUCTURAL report, not a crawl. It validates the architecture supports 3+ links per page type.
- WARN (not FAIL) if any page type has fewer than 3 structural link sources

**Output format:**
```
=== Sitemap & Internal Link Audit ===

Pass 1: Sitemap URL Validation
  ✓ No /matches/UUID URLs found (checked N URLs)
  ✓ No long-form league slugs found
  ✓ Spot-check: 5/5 URLs returned 200

Pass 2: Sitemap Completeness
  ✓ /models index page in sitemap
  ✓ /leagues index page in sitemap
  ✓ 17/17 league pages in sitemap
  ✓ 42 model pages in sitemap (42 in DB)
  ✓ ~1234 match pages in sitemap (~1234 in DB)
  ✓ 56 blog posts in sitemap

Pass 3: Internal Link Architecture
  ✓ Model pages: 5+ link sources (models index, leaderboard, league top-5, related models, match widget)
  ✓ League pages: 4+ link sources (leagues index, breadcrumbs, model widget, navigation)
  ✓ Match pages: 3+ link sources (league hub, model widget, blog)
  ⚠ Blog pages: 2 link sources (blog index, related articles) — below threshold

=== AUDIT PASSED (0 failures, 1 warning) ===
```

- Exit code 0 if no FAILs (warnings are OK)
- Exit code 1 if any FAIL detected

**Technical approach:**
- Use native `fetch()` for HTTP requests (Node.js 18+ built-in)
- Parse XML with simple regex or string matching (sitemap XML is well-structured, no need for cheerio just for this)
- Use `getDb()` from `@/lib/db` for database queries
- Import `COMPETITIONS` from `@/lib/football/competitions`
- Define the LEAGUE_SLUG_REDIRECTS map inline (same values as middleware: premier-league, champions-league, europa-league, la-liga, serie-a, ligue-1)
- Use `tsx` to run the TypeScript file

**Important:** The script needs a running server for Pass 1 (fetching sitemaps). When run in CI/build, this means the dev server must be started first OR the script uses pre-built output. To keep it simple:
- If `AUDIT_BASE_URL` env var is set, use that (for CI with running server)
- If not set, SKIP Pass 1 and only run Pass 2 + Pass 3 (database + structural analysis)
- Pass 1 can be run manually via `AUDIT_BASE_URL=http://localhost:3000 npm run audit:links`

This way, the build always runs Pass 2 + 3, and Pass 1 is optional (manual or CI).
  </action>
  <verify>
1. `npx tsx scripts/audit-internal-links.ts` runs without errors and produces audit report
2. Script exits with code 0 when all checks pass
3. Script exits with code 1 when a FAIL condition is triggered (test by temporarily adding a bad URL)
  </verify>
  <done>
Build-time audit script exists at `scripts/audit-internal-links.ts`. It validates sitemap URLs (no UUIDs, no long-form slugs), verifies sitemap completeness against database, and reports internal link architecture status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate audit script into build pipeline</name>
  <files>package.json</files>
  <action>
Update `package.json` scripts:

1. Add the audit script:
   ```json
   "audit:links": "tsx scripts/audit-internal-links.ts"
   ```

2. Update the build script to run the audit first:
   ```json
   "build": "tsx scripts/audit-internal-links.ts && next build"
   ```

3. Add a convenience script for full audit with server (Pass 1 included):
   ```json
   "audit:links:full": "AUDIT_BASE_URL=http://localhost:3000 tsx scripts/audit-internal-links.ts"
   ```

This ensures:
- Every `npm run build` runs the audit (Pass 2 + 3)
- Build fails if sitemap completeness or structural issues detected
- `npm run audit:links:full` can be run manually with a dev server for sitemap URL validation

**Important:** Test that `npm run build` still works correctly — the audit should complete quickly (< 5 seconds for Pass 2 + 3) since it only queries the database and analyzes structure, no HTTP requests.

**Verify the build chain works in Coolify/Nixpacks:** The audit script uses `@/lib/db` imports which require the TypeScript path aliases. Since `tsx` is already in devDependencies and used for other scripts (e.g., `migrate:betting`), this should work. If path aliases fail in `tsx`, use relative imports or configure `tsx` with the existing `tsconfig.json`.
  </action>
  <verify>
1. `npm run audit:links` completes successfully with audit report
2. `npm run build` runs the audit first, then proceeds to `next build`
3. If the audit detects a FAIL condition, `npm run build` stops before `next build` runs
  </verify>
  <done>
Build pipeline includes audit step. `npm run build` runs `tsx scripts/audit-internal-links.ts && next build`. Build fails if sitemap or link architecture issues are detected.
  </done>
</task>

</tasks>

<verification>
1. `npm run audit:links` produces clean report with 0 failures
2. `npm run build` runs audit first, then next build
3. Build stops on FAIL conditions (UUID URLs, missing pages, bad slugs)
4. Audit completes in < 10 seconds (no HTTP crawling in default mode)
5. Script handles missing database connection gracefully (useful in CI without DB)
</verification>

<success_criteria>
- LINK-05: Internal link architecture validated — pages with insufficient link sources identified
- REDIR-06: Sitemap URLs validated for canonical slug usage (no redirect-triggering slugs)
- SMAP-01 through SMAP-04: Sitemap completeness verified by automated audit
- Build fails if orphan pages or bad slugs detected (per user decision)
</success_criteria>

<output>
After completion, create `.planning/phases/45-sitemap-internal-linking/45-04-SUMMARY.md`
</output>
