---
phase: 45-sitemap-internal-linking
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/match/predicting-models-widget.tsx
  - src/app/leagues/[slug]/[match]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Match pages link to ALL models that made predictions for that match"
    - "Each match page has model links visible in the page content (not just predictions table)"
    - "Clicking a model name in the widget navigates to /models/{id}"
  artifacts:
    - path: "src/components/match/predicting-models-widget.tsx"
      provides: "Widget showing all models that predicted a match with links"
      min_lines: 30
    - path: "src/app/leagues/[slug]/[match]/page.tsx"
      provides: "Match page with predicting models cross-link widget"
      contains: "PredictingModelsWidget"
  key_links:
    - from: "src/components/match/predicting-models-widget.tsx"
      to: "/models/{id}"
      via: "Link component href"
      pattern: "href=.*models/"
    - from: "src/app/leagues/[slug]/[match]/page.tsx"
      to: "src/components/match/predicting-models-widget.tsx"
      via: "import and JSX usage"
      pattern: "PredictingModelsWidget"
---

<objective>
Add cross-linking widget to match pages that links to all models that made predictions for that match.

Purpose: Ensure match pages have internal links to model pages (LINK-02), creating a bidirectional link network between matches and models. This improves SEO discoverability and eliminates orphan match pages by ensuring they connect into the wider site structure through model links.

Output: New PredictingModelsWidget component integrated into match pages.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/leagues/[slug]/[match]/page.tsx
@src/components/model/related-models-widget.tsx
@src/components/match/match-layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PredictingModelsWidget component</name>
  <files>src/components/match/predicting-models-widget.tsx</files>
  <action>
Create an async server component that shows all models that made predictions for a specific match.

Props: `{ matchId: string }`

Query: Join `predictions` with `models` table. Select:
- `models.id`
- `models.displayName`
- `models.provider`
- `predictions.predictedHomeScore`, `predictions.predictedAwayScore`
- `predictions.points` (null if match not yet finished)

Filter by `predictions.matchId === matchId`. Order by `predictions.points DESC NULLS LAST` (best performers first for finished matches), then by `models.displayName ASC` as tiebreaker.

UI Design (follow existing patterns from `CompetitionTopModels` and `RelatedModelsWidget`):
- Use `Card` with `CardHeader` and `CardContent` from `@/components/ui/card`
- Header: "AI Models That Predicted This Match" with `Bot` icon from lucide-react
- Show count in subtitle: "{N} models made predictions"
- Each model as a `HoverPrefetchLink` to `/models/${model.id}` from `@/components/navigation/hover-prefetch-link`
- Display: model name, provider, predicted score (e.g., "2-1"), and points earned if available
- Use a compact grid or list layout (2-3 columns on desktop, 1 on mobile)
- For finished matches: show points earned with color coding (green for high, yellow for medium)
- Return `null` if no predictions found (early matches before prediction window)

Use `getDb()` from `@/lib/db` for database access. Import `predictions, models` from `@/lib/db`.
  </action>
  <verify>
`npx tsc --noEmit` passes. Component exports correctly.
  </verify>
  <done>
`PredictingModelsWidget` component exists at `src/components/match/predicting-models-widget.tsx`, querying all predictions for a match and rendering linked model entries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PredictingModelsWidget into match page</name>
  <files>src/app/leagues/[slug]/[match]/page.tsx</files>
  <action>
In `src/app/leagues/[slug]/[match]/page.tsx`:

1. Import the new widget:
   ```typescript
   import { PredictingModelsWidget } from '@/components/match/predicting-models-widget';
   ```

2. The match page uses `MatchDataProvider` and `MatchLayout` components. The widget needs `matchId` which is available as `matchData.id` in the page component.

3. Add the widget AFTER the `MatchLayout` component (which contains the main match content), but still inside the `MatchDataProvider` wrapper:
   ```tsx
   <PredictingModelsWidget matchId={matchData.id} />
   ```

4. Wrap in `<Suspense>` with appropriate fallback for PPR:
   ```tsx
   <Suspense fallback={<Skeleton className="h-[200px] rounded-xl" />}>
     <PredictingModelsWidget matchId={matchData.id} />
   </Suspense>
   ```

5. Import `Suspense` (already imported) and `Skeleton` from `@/components/ui/skeleton` if not already imported.

6. Examine the existing page structure carefully — the widget should appear AFTER the main match content (predictions table, FAQ) as a "Related Models" cross-linking section. Place it as one of the last sections before the closing `</>` or `</div>`.

Note: The match page already has `predictions` data fetched via `getPredictionsForMatchWithDetails`. The widget does its own query because it's a server component that renders independently — this is consistent with how `RelatedModelsWidget` works on model pages.
  </action>
  <verify>
1. `npm run build` succeeds.
2. Visit a match page in the dev server (e.g., a recent EPL match).
3. Verify "AI Models That Predicted This Match" section appears with model links.
4. Verify clicking a model name navigates to `/models/{modelId}`.
5. Verify the widget shows predicted scores and points for finished matches.
  </verify>
  <done>
Match pages now include a PredictingModelsWidget that links to all models that predicted the match. This creates bidirectional links: model pages link to matches (via RecentPredictionsWidget), and match pages link back to models (via PredictingModelsWidget).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Match pages show "AI Models That Predicted This Match" widget
3. All predicting models are listed with clickable links to `/models/{id}`
4. Widget shows predicted scores and points for finished matches
5. Widget returns null gracefully for matches with no predictions
6. Links use `HoverPrefetchLink` for prefetching behavior
</verification>

<success_criteria>
- LINK-02: Match pages link to predicting models — no orphan match pages
- LINK-03: League pages already link to related models via CompetitionTopModels (verified, no changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/45-sitemap-internal-linking/45-03-SUMMARY.md`
</output>
