---
phase: 45-sitemap-internal-linking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/model/recent-predictions-widget.tsx
  - src/components/model/leagues-covered-widget.tsx
  - src/app/models/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Model detail page shows recent match predictions with clickable links to match pages"
    - "Model detail page shows leagues this model has covered with clickable links to league pages"
    - "Each model page has 3+ internal links pointing TO it (from /models index, leaderboard, league top-5, and other model pages)"
  artifacts:
    - path: "src/components/model/recent-predictions-widget.tsx"
      provides: "Widget showing recent match predictions for a model"
      min_lines: 40
    - path: "src/components/model/leagues-covered-widget.tsx"
      provides: "Widget showing leagues covered by a model"
      min_lines: 30
    - path: "src/app/models/[id]/page.tsx"
      provides: "Model detail page with cross-linking widgets"
      contains: "RecentPredictionsWidget"
  key_links:
    - from: "src/components/model/recent-predictions-widget.tsx"
      to: "/leagues/{slug}/{match}"
      via: "Link component href"
      pattern: "href=.*leagues/"
    - from: "src/components/model/leagues-covered-widget.tsx"
      to: "/leagues/{slug}"
      via: "Link component href"
      pattern: "href=.*leagues/"
    - from: "src/app/models/[id]/page.tsx"
      to: "src/components/model/recent-predictions-widget.tsx"
      via: "import and JSX usage"
      pattern: "RecentPredictionsWidget"
---

<objective>
Add cross-linking widgets to model detail pages so each model page links to its recent match predictions and the leagues it covers.

Purpose: Ensure model pages have rich internal linking to match and league pages (LINK-01, LINK-04), improving SEO discoverability and reducing orphan pages. Each model page will have outbound links to matches and leagues, while those pages link back to models.

Output: Two new widget components integrated into the model detail page.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/models/[id]/page.tsx
@src/components/model/related-models-widget.tsx
@src/components/competition/competition-top-models.tsx
@src/lib/football/competitions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecentPredictionsWidget and LeaguesCoveredWidget components</name>
  <files>
    src/components/model/recent-predictions-widget.tsx
    src/components/model/leagues-covered-widget.tsx
  </files>
  <action>
**RecentPredictionsWidget** (`src/components/model/recent-predictions-widget.tsx`):

Create an async server component that shows the 10 most recent match predictions for a model.

Props: `{ modelId: string }`

Query: Join `predictions` with `matches` and `competitions` tables. Select:
- `matches.slug` (matchSlug)
- `matches.homeTeam`, `matches.awayTeam`
- `matches.homeScore`, `matches.awayScore`
- `matches.status`
- `matches.kickoffTime`
- `competitions.id` (for league slug in URL)
- `competitions.name`
- `predictions.predictedHomeScore`, `predictions.predictedAwayScore`
- `predictions.points`

Filter by `predictions.modelId === modelId`, order by `matches.kickoffTime DESC`, limit 10.

UI Design (match existing card/list patterns from `RelatedModelsWidget`):
- Use `Card` with `CardHeader` ("Recent Predictions") and `CardContent`
- Each prediction is a `Link` (from next/link) to `/leagues/${competition.id}/${match.slug}`
- Show: "{homeTeam} vs {awayTeam}" as main text
- Show: predicted score "{predictedHome}-{predictedAway}", actual score if finished, points earned
- Show: competition name as small badge/text
- Use `HoverPrefetchLink` from `@/components/navigation/hover-prefetch-link` instead of bare `Link` for prefetching
- Use appropriate lucide icon (e.g., `Calendar` or `BarChart2`)
- Return `null` if no predictions found

**LeaguesCoveredWidget** (`src/components/model/leagues-covered-widget.tsx`):

Create an async server component that shows unique leagues this model has predicted in.

Props: `{ modelId: string }`

Query: Select distinct `competitions.id` and `competitions.name` from `predictions` joined with `matches` and `competitions`, where `predictions.modelId === modelId`. Group by competition, count predictions per league. Order by prediction count DESC.

UI Design:
- Use `Card` with `CardHeader` ("Leagues Covered") and `CardContent`
- Each league as a `Link` to `/leagues/${competition.id}` styled as a rounded badge/pill
- Show prediction count as small text next to league name
- Use `Trophy` or `Globe` lucide icon in header
- Use `HoverPrefetchLink` for prefetching
- Return `null` if no leagues found

**Important:** Use `getDb()` from `@/lib/db` for database access. Import table schemas from `@/lib/db` (models, predictions, matches, competitions). Use drizzle-orm query operators (eq, desc, sql, etc.).
  </action>
  <verify>
`npx tsc --noEmit` passes. Both components export correctly and TypeScript types align with database schema.
  </verify>
  <done>
Two new widget components exist at `src/components/model/recent-predictions-widget.tsx` and `src/components/model/leagues-covered-widget.tsx`, each querying the database and rendering linked content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate cross-linking widgets into model detail page</name>
  <files>src/app/models/[id]/page.tsx</files>
  <action>
In `src/app/models/[id]/page.tsx`:

1. Import the two new widgets:
   ```typescript
   import { RecentPredictionsWidget } from '@/components/model/recent-predictions-widget';
   import { LeaguesCoveredWidget } from '@/components/model/leagues-covered-widget';
   ```

2. Add both widgets BEFORE the existing `RelatedModelsWidget` section (after the "Performance by League" section, before "Related Models"):
   ```tsx
   {/* Cross-linking: Recent Predictions */}
   <section>
     <RecentPredictionsWidget modelId={id} />
   </section>

   {/* Cross-linking: Leagues Covered */}
   <section>
     <LeaguesCoveredWidget modelId={id} />
   </section>
   ```

3. Wrap each in a `<Suspense>` boundary with a `<Skeleton>` fallback for PPR compatibility:
   ```tsx
   <Suspense fallback={<Skeleton className="h-[200px] rounded-xl" />}>
     <RecentPredictionsWidget modelId={id} />
   </Suspense>
   ```

The existing `RelatedModelsWidget` remains as the last section â€” it provides model-to-model cross-links. The new widgets add model-to-match and model-to-league cross-links.
  </action>
  <verify>
1. `npm run build` succeeds.
2. Visit a model page (e.g., `/models/meta-llama-4-maverick`) in the dev server.
3. Verify "Recent Predictions" section appears with clickable match links.
4. Verify "Leagues Covered" section appears with clickable league links.
5. Verify all links navigate to correct pages (match pages and league pages).
  </verify>
  <done>
Model detail page renders RecentPredictionsWidget and LeaguesCoveredWidget, providing outbound internal links to match pages and league pages. Combined with existing inbound links from /models index, leaderboard, and league top-5 sections, model pages meet the 3+ internal link threshold.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. Model detail page shows "Recent Predictions" with 10 match links
3. Model detail page shows "Leagues Covered" with league badge links
4. Clicking match links navigates to correct `/leagues/{slug}/{match}` pages
5. Clicking league links navigates to correct `/leagues/{slug}` pages
6. Both widgets return `null` gracefully when no data exists
</verification>

<success_criteria>
- LINK-01: Model pages have 3+ internal links (leaderboard + /models index + league top-5 + cross-linking widgets)
- LINK-04: Model pages link to recent matches they predicted AND leagues they cover
</success_criteria>

<output>
After completion, create `.planning/phases/45-sitemap-internal-linking/45-02-SUMMARY.md`
</output>
