---
phase: 45-sitemap-internal-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/navigation/urls.ts
  - src/app/sitemap.xml/route.ts
  - src/app/sitemap/static.xml/route.ts
  - src/app/sitemap/leagues.xml/route.ts
  - src/app/sitemap/models.xml/route.ts
autonomous: true

must_haves:
  truths:
    - "/sitemap.xml returns valid XML referencing all sub-sitemaps (static, leagues, models, blog, matches)"
    - "/sitemap/static.xml includes /models and /leagues index page URLs"
    - "/sitemap/leagues.xml includes all 17 leagues (not just club competitions)"
    - "/sitemap/models.xml uses lastmod from most recent prediction timestamp per model"
    - "No /matches/UUID URLs appear in any sitemap"
    - "getInternalUrl('league', {slug: 'epl'}) returns /leagues/epl"
  artifacts:
    - path: "src/lib/navigation/urls.ts"
      provides: "Centralized URL helper enforcing canonical slugs"
      exports: ["getInternalUrl", "getAbsoluteUrl"]
    - path: "src/app/sitemap/static.xml/route.ts"
      provides: "Static pages sitemap including /models and /leagues"
    - path: "src/app/sitemap/leagues.xml/route.ts"
      provides: "All 17 league pages in sitemap"
    - path: "src/app/sitemap/models.xml/route.ts"
      provides: "Model pages with accurate lastmod timestamps"
  key_links:
    - from: "src/lib/navigation/urls.ts"
      to: "src/lib/football/competitions.ts"
      via: "getCompetitionById import"
      pattern: "getCompetitionById"
    - from: "src/app/sitemap/models.xml/route.ts"
      to: "predictions table"
      via: "MAX(updatedAt) join"
      pattern: "MAX.*updatedAt"
---

<objective>
Fix sitemap hygiene issues and create centralized URL helper for canonical slug enforcement.

Purpose: Ensure all pages are discoverable via sitemaps with accurate timestamps, and provide a single source of truth for generating internal URLs that always use canonical short-form slugs.

Output: Updated sitemap route handlers with accurate lastmod, all page types covered, and a reusable getInternalUrl helper.
</objective>

<execution_context>
@/Users/pieterbos/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pieterbos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/football/competitions.ts
@src/lib/seo/constants.ts
@src/lib/navigation/breadcrumb-utils.ts
@src/app/sitemap.xml/route.ts
@src/app/sitemap/static.xml/route.ts
@src/app/sitemap/leagues.xml/route.ts
@src/app/sitemap/models.xml/route.ts
@src/app/sitemap/blog.xml/route.ts
@src/app/sitemap/matches/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized getInternalUrl helper</name>
  <files>src/lib/navigation/urls.ts</files>
  <action>
Create `src/lib/navigation/urls.ts` with two exported functions:

1. `getInternalUrl(type, params)` — returns a canonical relative path:
   - `type: 'league' | 'model' | 'match' | 'blog' | 'static'`
   - For `league`: import `getCompetitionById` from `@/lib/football/competitions`. Use `params.slug` to look up the competition, return `/leagues/${competition.id}`. Throw if unknown slug.
   - For `model`: return `/models/${params.id}`
   - For `match`: return `/leagues/${params.leagueSlug}/${params.matchSlug}`
   - For `blog`: return `/blog/${params.slug}`
   - For `static`: return `params.slug` directly (e.g., `/about`, `/leaderboard`)

2. `getAbsoluteUrl(type, params)` — returns full URL by prepending `BASE_URL` from `@/lib/seo/constants`:
   - Import `BASE_URL` from `@/lib/seo/constants`
   - Return `${BASE_URL}${getInternalUrl(type, params)}`

Add TypeScript interfaces:
- `InternalUrlType = 'league' | 'model' | 'match' | 'blog' | 'static'`
- `InternalUrlParams = { slug?: string; id?: string; leagueSlug?: string; matchSlug?: string }`

Add JSDoc comments explaining that this helper enforces canonical slug usage to prevent redirect-triggering URLs in sitemaps and internal links.
  </action>
  <verify>
`npx tsc --noEmit` passes with no errors. Import the file in a test context or verify the TypeScript compiles cleanly.
  </verify>
  <done>
`getInternalUrl` and `getAbsoluteUrl` exported from `src/lib/navigation/urls.ts`. League URLs resolve through `getCompetitionById` to enforce canonical short-form slugs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix all sitemap route handlers</name>
  <files>
    src/app/sitemap/static.xml/route.ts
    src/app/sitemap/leagues.xml/route.ts
    src/app/sitemap/models.xml/route.ts
    src/app/sitemap.xml/route.ts
  </files>
  <action>
**static.xml/route.ts:**
- Add two new entries to `staticPages` array:
  - `{ url: '${BASE_URL}/models', lastmod: today, changefreq: 'daily', priority: 0.9 }`
  - `{ url: '${BASE_URL}/leagues', lastmod: today, changefreq: 'daily', priority: 0.9 }`
- These are the index pages created in Phase 44 that were missing from the sitemap.

**leagues.xml/route.ts:**
- Remove the `.filter()` that excludes international competitions. Currently filters to only `club-domestic` and `club-europe` categories. Per user decision, include ALL leagues (all 17 competitions).
- Change: `COMPETITIONS.filter(comp => ...)` → use `COMPETITIONS` directly (no filter).
- Use `getDb()` to query for the most recent match `updatedAt` per competition for accurate lastmod. Join `matches` with `competitions` grouped by `competitionId`, take `MAX(matches.updatedAt)`. If no matches exist for a competition, fall back to today's date.
- Import `getDb, matches, competitions` from `@/lib/db` and `eq, sql, desc` from `drizzle-orm`.

**models.xml/route.ts:**
- Replace `today` lastmod with actual timestamps from the database.
- Join `models` with `predictions` to get `MAX(predictions.updatedAt)` per model.
- Use left join so models without predictions still appear (with today as fallback lastmod).
- Import `predictions` from `@/lib/db` and `eq, sql, desc` from `drizzle-orm`.
- Filter to only active models: add `.where(eq(models.active, true))` if `active` column exists, otherwise include all.

**sitemap.xml/route.ts (index):**
- No structural changes needed — it already references all sub-sitemaps correctly.
- The `lastmod` in the sitemap index can remain `new Date().toISOString()` since the index itself is regenerated on each request.

**Important constraints:**
- Keep `priority` and `changefreq` values per user decision (Google ignores them in 2026, but include for spec compliance).
- Do NOT add any `/matches/UUID` format URLs anywhere (already correct, just verify).
- Use `getAbsoluteUrl` from the new helper where practical for league and model URLs to enforce canonical slugs. For static pages, continue using `${BASE_URL}/path` directly since those are fixed strings.
  </action>
  <verify>
1. `npm run build` succeeds.
2. Start dev server and verify:
   - `curl http://localhost:3000/sitemap/static.xml` includes `/models` and `/leagues` URLs
   - `curl http://localhost:3000/sitemap/leagues.xml` includes all 17 leagues (count `<url>` tags)
   - `curl http://localhost:3000/sitemap/models.xml` has `<lastmod>` values that differ per model (not all the same date)
   - No URL in any sitemap contains `/matches/` followed by a UUID pattern
  </verify>
  <done>
Static sitemap includes /models and /leagues. Leagues sitemap includes all 17 competitions (not just club). Models sitemap uses accurate lastmod from prediction timestamps. No UUID match URLs in any sitemap.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. /sitemap.xml returns valid XML with references to static, leagues, models, blog, and match sub-sitemaps
3. /sitemap/static.xml includes entries for /models and /leagues
4. /sitemap/leagues.xml has 17 `<url>` entries (all competitions including international)
5. /sitemap/models.xml has per-model lastmod timestamps (not uniform dates)
6. No sitemap contains /matches/UUID format URLs
7. TypeScript compiles with `npx tsc --noEmit`
</verification>

<success_criteria>
- SMAP-01: Sitemap index at /sitemap.xml references all sub-sitemaps
- SMAP-02: No /matches/UUID URLs in any sitemap (verified)
- SMAP-03: All 17 league pages appear in leagues sitemap
- SMAP-04: /models and /leagues index pages in static sitemap
- REDIR-06 (partial): getInternalUrl helper created for canonical slug enforcement
</success_criteria>

<output>
After completion, create `.planning/phases/45-sitemap-internal-linking/45-01-SUMMARY.md`
</output>
