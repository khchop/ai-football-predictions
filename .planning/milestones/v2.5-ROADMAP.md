# Milestone v2.5: Model Reliability & Dynamic Counts

**Status:** SHIPPED 2026-02-05
**Phases:** 40-43
**Total Plans:** 11

## Overview

Make all models work reliably with model-specific prompts and Together.ai fallbacks, and display model counts dynamically everywhere.

## Phases

### Phase 40: Model-Specific Prompt Selection

**Goal**: Failing models receive appropriate prompts and timeouts for reliable JSON output
**Depends on**: Phase 39
**Plans**: 2 plans

Plans:

- [x] 40-01: Create prompt variant and response handler infrastructure
- [x] 40-02: Integrate into providers and configure failing models

**Details:**
- PromptVariant enum (5 variants: BASE, ENGLISH_ENFORCED, JSON_STRICT, THINKING_STRIPPED, ENGLISH_THINKING_STRIPPED)
- ResponseHandler enum (3 handlers: DEFAULT, EXTRACT_JSON, STRIP_THINKING_TAGS)
- Pure function response handlers for string→string pipeline
- Re-enabled 6 disabled Synthetic models with tailored configs
- Model-specific timeouts: 90s reasoning, 60s standard, 45s JSON-strict
- Provider count expanded from 36 to 42 (29 Together + 13 Synthetic)

### Phase 41: Together AI Fallbacks

**Goal**: Synthetic model failures automatically fall back to Together AI equivalents with cycle detection and cost tracking
**Depends on**: Phase 40
**Plans**: 4 plans

Plans:

- [x] 41-01: Add usedFallback column and startup validation
- [x] 41-02: Implement callAPIWithFallback wrapper
- [x] 41-03: Add fallback metrics to admin dashboard
- [x] 41-04: Gap closure: add K2.5 mapping, correct criteria

**Details:**
- usedFallback boolean column on predictions table
- validateFallbackMapping() at module load time (fail-fast)
- callAPIWithFallback() on base provider class
- Max fallback depth 1, no retries on original model
- Admin dashboard FallbackMetrics component with per-model breakdown
- Cost warning at 2x threshold with amber badges
- Kimi K2.5-syn mapped to Together AI Kimi K2 Instruct

### Phase 42: Dynamic Model Counts

**Goal**: Model counts displayed dynamically throughout the application with single source of truth
**Depends on**: Phase 40 (independent, ran in parallel)
**Plans**: 2 plans

Plans:

- [x] 42-01: Create getActiveModelCount() and cache invalidation infrastructure
- [x] 42-02: Replace all hardcoded "35 models" with dynamic counts

**Details:**
- getActiveModelCount() with 60s cache TTL aligned with CACHE_TTL.STATS
- Cache invalidation wired to all model status mutations
- Batch invalidation after recoverDisabledModels()
- 12 files updated: SEO metadata, pages, content generation, JSON-LD schema
- Optional activeModels parameter with ?? 35 fallback for backwards compatibility

### Phase 43: Testing & Validation

**Goal**: All 42 models validated with comprehensive integration tests and production monitoring
**Depends on**: Phase 41, Phase 42
**Plans**: 3 plans

Plans:

- [x] 43-01: Set up Vitest framework and Zod validation schemas
- [x] 43-02: Create integration tests for all 42 models
- [x] 43-03: Add production fallback rate monitoring script

**Details:**
- Vitest with Node environment, 60s timeout, maxConcurrency 5
- Zod v4 validation schemas for prediction structure
- Parameterized tests for all 42 models
- PREVIOUSLY_DISABLED_MODELS constant tracking 6 rehabilitated models
- Dual threshold: overall AND previously disabled >90%
- Fallback rate monitoring: <5% global, >90% per-model success
- npm scripts: validate:models, check:fallback, validate:all

---

## Milestone Summary

**Key Decisions:**

- Model-specific prompts over LangChain/LiteLLM (avoids 10MB+ bundle, 50-200ms latency)
- Enum-based configuration for compile-time validation (PromptVariant, ResponseHandler)
- Combo variants over multi-variant arrays (simpler model configuration)
- Response handlers as pure functions (string→string pipeline)
- No retries on original model for fallbacks (immediate Together AI fallback)
- Max fallback depth 1 with structural enforcement (Together models have no fallbacks)
- Boolean usedFallback tracking (modelId stores original model)
- 60s cache TTL for model count (aligned with CACHE_TTL.STATS)
- Node environment for Vitest (API testing, not browser)
- Zod v4 uses .issues not .errors on ZodError

**Issues Resolved:**

- 6 previously disabled Synthetic models re-enabled with appropriate configurations
- GLM models receive English enforcement prompts
- Thinking models (DeepSeek R1, Qwen3-235B-Thinking) return valid JSON
- Kimi K2.5 completes within timeout with fallback safety net
- All hardcoded "35 models" references replaced with dynamic counts

**Issues Deferred:**

- Fallback prompt config uses target model's config, not original model's (intentional design)
- 1 remaining "35" reference in retry-config.ts comment (not user-facing)
- SEO metadata functions use ?? 35 fallback for backwards compatibility

**Technical Debt Incurred:**

- None significant — 3 INFO-level items only

---

_For current project status, see .planning/ROADMAP.md_
