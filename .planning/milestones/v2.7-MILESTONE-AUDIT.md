---
milestone: v2.7
audited: 2026-02-07T11:00:00Z
status: tech_debt
scores:
  requirements: 19/20
  phases: 4/4
  integration: 15/15
  flows: 3/4
gaps:
  requirements:
    - "SETTLE-01: Investigation script exists but not run against production (blocked on operational step)"
  integration: []
  flows:
    - "Settlement Recovery flow: investigation script NOT RUN, root cause of 43 failures unknown"
tech_debt:
  - phase: 50-settlement-investigation-recovery
    items:
      - "SETTLE-01: Investigation script ready but not executed against production Redis"
      - "Settlement backfill script ready but not executed"
      - "Root cause of 43 failed settlement jobs not yet identified"
---

# v2.7 Milestone Audit: Pipeline Reliability & Retroactive Backfill

**Audited:** 2026-02-07T11:00:00Z
**Status:** TECH_DEBT (no blockers, 1 operational item deferred)

## Milestone Definition of Done

> Fix the prediction/analysis pipeline that fails to schedule jobs for existing matches after server restarts, investigate and resolve 43 failed settlement jobs, retroactively generate predictions for all matches from the last 7 days that are missing them, and add pipeline health monitoring to prevent future gaps.

## Requirements Coverage

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| PIPE-01: Catch-up scheduling handles past-due matches | 49 | ✓ SATISFIED | Early exit removed, status-based guard added |
| PIPE-02: Fixtures worker schedules existing matches missing jobs | 49 | ✓ SATISFIED | scheduleMatchJobs moved outside isNewMatch block |
| PIPE-03: Backfill uses wider windows (48h/12h/12h) | 49 | ✓ SATISFIED | Constants verified in backfill.worker.ts |
| PIPE-04: Dependency chain validation (analysis→lineups→predictions) | 49 | ✓ SATISFIED | DB query joins enforce chain |
| PIPE-05: Combined coverage via catch-up + backfill + stuck-match | 49 | ✓ SATISFIED | Three overlapping safety nets |
| SETTLE-01: 43 failed settlement jobs investigated | 50 | ⚠ PARTIAL | Script ready, needs production run |
| SETTLE-02: Settlement worker handles zero predictions gracefully | 50 | ✓ SATISFIED | Conditional retry logic in scoring.worker.ts |
| SETTLE-03: Backfill covers finished matches with unscored predictions | 50 | ✓ SATISFIED | Backfill worker + script cover both cases |
| SETTLE-04: Settlement retry cleans up failed jobs | 50 | ✓ SATISFIED | Admin API with retry + clear implemented |
| RETRO-01: Script identifies matches missing predictions | 51 | ✓ SATISFIED | Gap detection query with COUNT < 42 filter |
| RETRO-02: Historical data fetched for matches missing analysis | 51 | ✓ SATISFIED | Analysis queue with allowRetroactive flag |
| RETRO-03: All 42 LLMs generate predictions | 51 | ✓ SATISFIED | Predictions queue with allowRetroactive flag |
| RETRO-04: Finished match predictions scored immediately | 51 | ✓ SATISFIED | Settlement logic for status === 'finished' |
| RETRO-05: Live/upcoming predictions stored for later scoring | 51 | ✓ SATISFIED | Conditional scoring (only finished matches) |
| RETRO-06: Script is idempotent | 51 | ✓ SATISFIED | Deterministic job IDs + stale job cleanup |
| MON-01: Health endpoint shows match coverage % | 52 | ✓ SATISFIED | /api/health returns matchCoverage with 60s cache |
| MON-02: Admin dashboard shows matches within 6h with no jobs | 52 | ✓ SATISFIED | /api/admin/pipeline-health with severity classification |
| MON-03: Server logs alert when match within 2h with no job | 52 | ✓ SATISFIED | Backfill worker logs ERROR for critical gaps |
| MON-04: Queue metrics include matchesWithoutPredictions | 52 | ✓ SATISFIED | metrics.ts includes pipeline coverage metrics |
| MON-05: Settlement failure dashboard with retry controls | 52 | ✓ SATISFIED | /api/admin/settlement-failures GET + POST |

**Score:** 19/20 requirements satisfied (95%)

## Phase Verification Summary

| Phase | Goal | Verification | Score | Status |
|-------|------|-------------|-------|--------|
| 49 - Pipeline Scheduling Fixes | Catch-up + wider backfill windows | 49-VERIFICATION.md | 6/6 | ✓ PASSED |
| 50 - Settlement Investigation & Recovery | Investigate + fix 43 failed jobs | 50-VERIFICATION.md | 3/5 | ⚠ GAPS (operational) |
| 51 - Retroactive Backfill Script | Generate missing predictions for 7 days | 51-VERIFICATION.md | 6/6 | ✓ PASSED |
| 52 - Monitoring & Observability | Pipeline health monitoring | 52-VERIFICATION.md | 14/14 | ✓ PASSED |

**Phase Score:** 4/4 phases have all code complete. 1 phase has unexecuted operational steps.

## Cross-Phase Integration

| Connection | Status | Details |
|-----------|--------|---------|
| Phase 49 → 50: backfill.worker.ts shared | ✓ CONNECTED | Zero-prediction detection coexists with wider windows |
| Phase 49 → 51: Worker allowRetroactive flag | ✓ CONNECTED | Flag bypasses status check without breaking normal flow |
| Phase 49 → 52: Backfill worker + monitoring | ✓ CONNECTED | Pipeline health logging added as step 7 |
| Phase 50 → 52: Settlement failures endpoint | ✓ CONNECTED | Both use DLQ/queue infrastructure, no conflicts |
| Phase 51 → 52: Retroactive backfill + gap detection | ✓ CONNECTED | Monitoring detects gaps that backfill fixes |
| Monitoring module → 4 consumers | ✓ CONNECTED | health, admin, backfill worker, metrics all import correctly |
| Admin auth on all admin endpoints | ✓ VERIFIED | X-Admin-Password required on all 3 admin routes |
| Rate limiting on admin endpoints | ✓ VERIFIED | RATE_LIMIT_PRESETS.admin on all admin routes |
| TypeScript compilation | ✓ PASSED | No type errors in source code |

**Integration Score:** 15/15 connections verified (100%)

## E2E Flow Verification

| Flow | Status | Break Points |
|------|--------|-------------|
| Server Restart Recovery | ✓ COMPLETE | None |
| Retroactive Backfill | ✓ COMPLETE | None |
| Settlement Recovery | ⚠ GAPS | Investigation script NOT RUN against production |
| Ongoing Pipeline Monitoring | ✓ COMPLETE | None |

**Flow Score:** 3/4 flows complete (75%)

## Tech Debt

### Phase 50: Settlement Investigation & Recovery

All code is written and verified. The remaining items are **operational steps**, not code gaps:

1. **Investigation script not executed** — `scripts/investigate-settlement-failures.ts` exists (230 lines) but has not been run against production Redis. Root cause of 43 failures remains unknown.
   - **Action:** `npx tsx scripts/investigate-settlement-failures.ts`
   - **Impact:** LOW — infrastructure to fix/retry already exists

2. **Settlement backfill not executed** — `scripts/backfill-settlement.ts` exists (154 lines) but has not been run.
   - **Action:** `npx tsx scripts/backfill-settlement.ts`
   - **Impact:** LOW — automated backfill worker already catches zero-prediction matches

**Why this is tech debt, not a blocker:**
- The automated pipeline (Phase 49 fixes + Phase 50 worker extensions + Phase 52 monitoring) prevents this class of failure from recurring
- The admin retry API allows manual recovery at any time
- The monitoring dashboard makes future failures immediately visible
- Running the scripts is a one-time operational task, not a code change

## Anti-Patterns

No anti-patterns found across any v2.7 phase:
- No TODO/FIXME comments in implementation code
- No placeholder/stub implementations
- No empty return handlers
- No hardcoded IDs (all deterministic)
- No console.log in production code (scripts use console.log appropriately)
- No circular dependencies in monitoring module

## Summary

**v2.7 achieved its core objective:** The prediction/analysis pipeline is now reliable after server restarts, retroactive backfill capability exists, and pipeline health monitoring detects gaps before they become problems.

**What's working:**
- Pipeline scheduling fixed — past-due matches no longer dropped (Phase 49)
- Wider backfill windows catch gaps that slip through (Phase 49)
- Retroactive backfill generates missing predictions for any time window (Phase 51)
- Pipeline health monitoring with alerts, dashboards, and metrics (Phase 52)
- Settlement retry infrastructure with admin controls (Phase 50 + 52)

**What's deferred:**
- Running investigation script against production to identify 43 failure root causes
- Running settlement backfill to score all recent finished matches

---

*Audited: 2026-02-07T11:00:00Z*
*Auditor: Claude (gsd-milestone-audit)*
