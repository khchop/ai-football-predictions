# Milestone v2.7: Pipeline Reliability & Retroactive Backfill

**Status:** SHIPPED 2026-02-07
**Phases:** 49-52
**Total Plans:** 9

## Overview

Fix the prediction/analysis pipeline that fails to schedule jobs for existing matches after server restarts, investigate and resolve 43 failed settlement jobs, retroactively generate predictions for all matches from the last 7 days that are missing them, and add pipeline health monitoring to prevent future gaps.

## Phases

### Phase 49: Pipeline Scheduling Fixes

**Goal**: Catch-up scheduling handles past-due matches and backfill detects wider gaps to ensure all matches receive analysis/predictions
**Depends on**: Phase 48
**Plans**: 2 plans

Plans:
- [x] 49-01: Fix scheduler early exit and fixtures worker existing-match scheduling
- [x] 49-02: Widen backfill time windows and add chain validation

**Details:**
- Removed `kickoff <= now` early exit from scheduleMatchJobs() — blocks catch-up scheduling
- Added status-based guard (finished/cancelled/postponed) instead of time-based guard
- Fixtures worker schedules jobs for ALL scheduled matches, not just new ones
- Widened backfill windows: 48h analysis (was 12h), 12h lineups/predictions (was 2h)
- Dependency chain validation via DB query joins (analysis → lineups → predictions)
- Chain validation logging for debugging visibility

### Phase 50: Settlement Investigation & Recovery

**Goal**: All 43 failed settlement jobs investigated, root cause fixed, and matches re-settled with correct scoring
**Depends on**: Phase 49
**Plans**: 2 plans

Plans:
- [x] 50-01: Investigate failed settlement jobs and fix scoring worker zero-prediction handling
- [x] 50-02: Admin settlement retry API, backfill worker extension, and settlement backfill script

**Details:**
- Investigation script (`scripts/investigate-settlement-failures.ts`) for production root cause analysis
- Conditional retry in scoring worker: analysis exists → retry with backoff, no analysis → skip gracefully
- Admin settlement retry API: POST /api/admin/settlement/retry (retry from queue + DLQ)
- Extended backfill worker with zero-prediction detection (hourly, step 6)
- One-shot settlement backfill script with idempotent job IDs
- Used favoriteTeamName as reliable analysis existence indicator

### Phase 51: Retroactive Backfill Script

**Goal**: All matches from last 7 days missing predictions have retroactive predictions generated and scored
**Depends on**: Phase 49 (pipeline must be healthy first)
**Plans**: 2 plans

Plans:
- [x] 51-01: Add allowRetroactive flag to worker types and analysis/predictions workers
- [x] 51-02: Create retroactive backfill script with gap detection and job orchestration

**Details:**
- Added `allowRetroactive?: boolean` flag to AnalyzeMatchPayload and PredictMatchPayload
- Workers bypass status check when allowRetroactive=true, preserving normal pipeline behavior otherwise
- Gap detection query identifies matches with < 42 predictions from last N days
- Sequential orchestration: analysis (if missing) → predictions → settlement (if finished)
- Idempotent job IDs: analyze-retro-*, predict-retro-*, settle-retro-*
- Per-match error handling for maximum recovery coverage
- Phase-specific timeouts: 120s analysis, 300s predictions, 60s settlement

### Phase 52: Monitoring & Observability

**Goal**: Pipeline health monitoring detects matches approaching kickoff without scheduled jobs before they become gaps
**Depends on**: Phase 49
**Plans**: 3 plans

Plans:
- [x] 52-01: Core pipeline coverage calculation module (types + getMatchCoverage)
- [x] 52-02: Health endpoint enhancement, backfill alerts, queue metrics extension (MON-01, MON-03, MON-04)
- [x] 52-03: Admin pipeline-health and settlement-failures endpoints (MON-02, MON-05)

**Details:**
- Shared monitoring types (MatchGap, MatchCoverageResult, PipelineHealthSummary)
- getMatchCoverage() compares scheduled matches against BullMQ jobs
- classifyGapsBySeverity() for critical/warning/info severity buckets
- Health endpoint: /api/health returns coverage %, 60s cache, HTTP 503 on Redis failure
- Health status: ok (>= 90%), degraded (< 90%), unhealthy (Redis down)
- Backfill worker step 7: hourly pipeline health with ERROR for < 2h gaps
- Queue metrics: matchesWithoutPredictions count in 5-minute logging
- Admin pipeline health: GET /api/admin/pipeline-health (severity-classified gaps)
- Admin settlement failures: GET + POST /api/admin/settlement-failures (view + retry)

---

## Milestone Summary

**Key Decisions:**
- Remove time-based early exit from scheduler in favor of status-based guards
- Wider backfill windows (48h/12h/12h) for comprehensive catch-up
- Optional allowRetroactive flag for retroactive processing without modifying global behavior
- 60s cache on health endpoint to prevent monitoring spam
- No auth on health endpoint (load balancers need unauthenticated access)
- Admin endpoints use rate limiting (10 req/min) and error message truncation (300 chars)

**Issues Resolved:**
- Pipeline not scheduling jobs for existing matches after server restart
- Backfill windows too narrow (12h analysis, 2h lineups/predictions)
- Scoring worker silently skipping zero-prediction matches
- No monitoring for pipeline gaps or settlement failures

**Issues Deferred:**
- SETTLE-01: Investigation script exists but not run against production Redis (operational step)
- Running settlement backfill script against production (operational step)

**Technical Debt Incurred:**
- SETTLE-01 investigation script needs production execution to identify root cause of 43 failures
- Settlement and retroactive backfill scripts ready but awaiting production run

---

_For current project status, see .planning/ROADMAP.md_
